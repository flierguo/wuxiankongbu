# 游戏引擎开发指南

## 📋 概述

本指南旨在帮助开发者避免常见的游戏引擎开发错误，特别是定时器使用、API调用、UI组件等方面的兼容性问题。

## ⚠️ 常见错误及解决方案

### 1. 定时器使用错误

#### ❌ **错误做法**：
```typescript
// 不要使用标准JavaScript定时器
setTimeout(() => {
    console.log('延迟执行');
}, 1000);

setInterval(() => {
    console.log('定时执行');
}, 5000);
```

#### ✅ **正确做法**：
```typescript
// 使用游戏引擎的RobotManageNpc系统
export function _A_second(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 每秒执行的代码
    console.log('每秒执行');
}

export function _Ten_seconds(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 每10秒执行的代码
    console.log('每10秒执行');
}

export function 每分钟检测一次(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 每分钟执行的代码
    console.log('每分钟执行');
}
```

#### 📝 **定时器规则**：
- ✅ 使用`RobotManageNpc`中的定时器函数
- ✅ 函数必须导出为`export function`
- ✅ 函数参数必须包含`Npc: TNormNpc, Player: TPlayObject, Args: TArgs`
- ❌ 不要使用`setTimeout`、`setInterval`
- ❌ 不要使用`process.nextTick`

### 2. API调用错误

#### ❌ **错误做法**：
```typescript
// 错误的API调用
const playerCount = GameLib.GetPlayerCount(); // 不存在的方法
const onlineCount = GameLib.GetOnlineCount(); // 不存在的方法
```

#### ✅ **正确做法**：
```typescript
// 正确的API调用
try {
    const playerCount = GameLib.GetPlayCount() || 0; // 正确的方法
    console.log('在线玩家数量:', playerCount);
} catch (error) {
    console.log('获取玩家数量失败:', error);
    const playerCount = 0; // 提供默认值
}
```

#### 📝 **API调用规则**：
- ✅ 使用`GameLib.GetPlayCount()`获取玩家数量
- ✅ 使用`GameLib.GetPlayerCount()`是错误的
- ✅ 总是添加try-catch错误处理
- ✅ 提供默认值以防API调用失败
- ❌ 不要假设API方法存在

### 3. UI组件名称错误

#### ❌ **错误做法**：
```typescript
// 包含emoji的组件名称
GameLib.AdminUI.AddButton('页面', '▶ 启动系统', '提示');
GameLib.AdminUI.AddButton('页面', '🟢 系统状态: 正常', '提示');

// 包含动态数据的组件名称
GameLib.AdminUI.AddButton('页面', '运行时间: 0分钟', '提示');
GameLib.AdminUI.AddButton('页面', '内存使用: 0%', '提示');

// 包含特殊字符的组件名称
GameLib.AdminUI.AddEdit('页面', '监控间隔(秒)', '5', '提示');
```

#### ✅ **正确做法**：
```typescript
// 使用纯文本的静态组件名称
GameLib.AdminUI.AddButton('页面', '启动系统', '启动核心运行监控');
GameLib.AdminUI.AddButton('页面', '系统状态', '当前系统运行状态');
GameLib.AdminUI.AddButton('页面', '运行时间', '系统持续运行时间');
GameLib.AdminUI.AddButton('页面', '内存使用', '系统内存使用率');
GameLib.AdminUI.AddEdit('页面', '监控间隔', '5', '设置监控数据更新间隔(秒)');
```

#### 📝 **UI组件规则**：
- ✅ 组件名称必须是纯文本
- ✅ 不能包含emoji表情符号
- ✅ 不能包含动态数据（如冒号、数字、百分比）
- ✅ 不能包含特殊字符（如括号）
- ✅ 组件名称应该是静态标识符
- ❌ 不要将显示数据作为组件名称

### 4. 函数导入错误

#### ❌ **错误做法**：
```typescript
// 导入不存在的函数
import { 获取装备缓存统计 } from "./大数值版本/装备属性统计";
import { 不存在的函数 } from "./某个模块";

// 调用不存在的函数
const result = 获取装备缓存统计(); // 函数不存在
```

#### ✅ **正确做法**：
```typescript
// 只导入存在的函数
import { 清理装备JSON缓存 } from "./大数值版本/装备属性统计";

// 检查函数是否存在再调用
try {
    if (typeof 清理装备JSON缓存 === 'function') {
        清理装备JSON缓存();
    } else {
        console.log('函数不存在，使用替代方案');
    }
} catch (error) {
    console.log('函数调用失败:', error);
}
```

#### 📝 **函数导入规则**：
- ✅ 导入前确认函数存在
- ✅ 使用try-catch包装函数调用
- ✅ 提供替代方案或默认值
- ❌ 不要导入不存在的函数
- ❌ 不要假设函数一定存在

### 5. 类型访问错误

#### ❌ **错误做法**：
```typescript
// 使用错误的属性名
const 统计 = 获取清理性能统计();
const 循环次数 = 统计.循环操作次数; // 属性不存在
const 缓存大小 = 统计.缓存大小; // 属性不存在
```

#### ✅ **正确做法**：
```typescript
// 使用正确的属性名
try {
    const 统计 = 获取清理性能统计();
    if (统计) {
        const 执行次数 = 统计.总执行次数 || 0; // 正确的属性名
        const 总耗时 = 统计.总耗时 || 0;
        const 平均耗时 = 统计.平均耗时 || 0;
    }
} catch (error) {
    console.log('获取统计失败:', error);
}
```

#### 📝 **类型访问规则**：
- ✅ 使用正确的属性名
- ✅ 添加空值检查
- ✅ 提供默认值
- ❌ 不要使用不存在的属性名
- ❌ 不要假设对象结构

## 🛠️ 开发最佳实践

### 1. 错误处理模式

```typescript
// 标准错误处理模式
function safeApiCall<T>(apiCall: () => T, defaultValue: T, errorMessage: string): T {
    try {
        return apiCall();
    } catch (error) {
        console.log(`${errorMessage}:`, error);
        return defaultValue;
    }
}

// 使用示例
const playerCount = safeApiCall(
    () => GameLib.GetPlayCount(),
    0,
    '获取玩家数量失败'
);
```

### 2. 函数存在性检查

```typescript
// 检查函数是否存在
function callFunctionIfExists<T>(func: T | undefined, ...args: any[]): any {
    if (typeof func === 'function') {
        try {
            return func(...args);
        } catch (error) {
            console.log('函数调用失败:', error);
            return null;
        }
    } else {
        console.log('函数不存在');
        return null;
    }
}

// 使用示例
const result = callFunctionIfExists(清理装备JSON缓存);
```

### 3. 安全的对象属性访问

```typescript
// 安全访问对象属性
function safeGetProperty<T>(obj: any, property: string, defaultValue: T): T {
    try {
        return obj && obj[property] !== undefined ? obj[property] : defaultValue;
    } catch (error) {
        console.log(`访问属性 ${property} 失败:`, error);
        return defaultValue;
    }
}

// 使用示例
const 执行次数 = safeGetProperty(统计, '总执行次数', 0);
```

### 4. 监控系统集成模式

```typescript
// 在RobotManageNpc中集成监控系统
export function _A_second(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 监控系统 - 每秒更新
    if (systemStatus.isRunning) {
        try {
            UpdateSystemStatus();
            monitoringCounters.秒计数器++;
        } catch (error) {
            console.log('监控更新失败:', error);
        }
    }
    
    // 其他每秒执行的代码...
}

export function _Ten_seconds(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 监控系统 - 每10秒监控核心模块
    if (systemStatus.isRunning) {
        try {
            MonitorCoreModules();
            monitoringCounters.十秒计数器++;
        } catch (error) {
            console.log('核心模块监控失败:', error);
        }
    }
    
    // 其他每10秒执行的代码...
}
```

## 📚 常用API参考

### 游戏引擎API

| 功能 | 正确API | 错误API | 说明 |
|------|---------|---------|------|
| 获取玩家数量 | `GameLib.GetPlayCount()` | `GameLib.GetPlayerCount()` | 获取当前在线玩家数量 |
| 获取服务器名称 | `GameLib.ServerName` | - | 获取服务器名称 |
| 获取当前时间 | `GameLib.TickCount` | `Date.now()` | 获取游戏引擎时间戳 |
| 重新加载脚本 | `GameLib.ReLoadScriptEngine()` | - | 重新加载脚本引擎 |

### UI组件API

| 组件类型 | 正确用法 | 错误用法 |
|----------|----------|----------|
| 按钮 | `GameLib.AdminUI.AddButton('页面', '按钮名称', '提示文本')` | 名称包含emoji或动态数据 |
| 编辑框 | `GameLib.AdminUI.AddEdit('页面', '编辑框名称', '默认值', '提示文本')` | 名称包含特殊字符 |
| 复选框 | `GameLib.AdminUI.AddCheckBox('页面', '复选框名称', true, '提示文本')` | 名称包含动态内容 |

### 定时器函数

| 函数名 | 执行频率 | 参数要求 | 用途 |
|--------|----------|----------|------|
| `_A_second` | 每秒 | `(Npc, Player, Args)` | 高频更新、状态检查 |
| `_Ten_seconds` | 每10秒 | `(Npc, Player, Args)` | 中等频率监控、数据统计 |
| `每分钟检测一次` | 每分钟 | `(Npc, Player, Args)` | 低频清理、维护任务 |

## 🔍 调试技巧

### 1. 控制台输出

```typescript
// 使用控制台输出进行调试
console.log('调试信息:', 变量名);
console.log('API调用结果:', GameLib.GetPlayCount());
console.log('函数执行状态:', '成功' || '失败');
```

### 2. 错误日志记录

```typescript
// 记录错误日志
function logError(category: string, message: string, error?: any): void {
    const timestamp = new Date().toLocaleString();
    const logMessage = `[${timestamp}] [错误] [${category}] ${message}`;
    console.log(logMessage);
    if (error) {
        console.log('错误详情:', error);
    }
}

// 使用示例
try {
    // 可能出错的代码
} catch (error) {
    logError('API调用', '获取玩家数量失败', error);
}
```

### 3. 性能监控

```typescript
// 简单的性能监控
function measurePerformance<T>(name: string, func: () => T): T {
    const start = Date.now();
    try {
        const result = func();
        const end = Date.now();
        console.log(`${name} 执行时间: ${end - start}ms`);
        return result;
    } catch (error) {
        const end = Date.now();
        console.log(`${name} 执行失败，耗时: ${end - start}ms`, error);
        throw error;
    }
}

// 使用示例
const playerCount = measurePerformance('获取玩家数量', () => {
    return GameLib.GetPlayCount();
});
```

## 🚀 部署检查清单

### 部署前检查

- [ ] 确认所有定时器使用`RobotManageNpc`函数
- [ ] 确认所有API调用使用正确的方法名
- [ ] 确认所有UI组件名称符合规范
- [ ] 确认所有导入的函数都存在
- [ ] 确认所有对象属性访问使用正确的属性名
- [ ] 添加了适当的错误处理
- [ ] 提供了默认值和备用方案
- [ ] 测试了所有功能模块

### 常见问题排查

1. **定时器不工作** → 检查是否使用了`setTimeout`/`setInterval`
2. **API调用失败** → 检查方法名是否正确
3. **UI组件错误** → 检查组件名称是否包含emoji或特殊字符
4. **函数调用失败** → 检查函数是否存在
5. **属性访问错误** → 检查属性名是否正确

## 📖 总结

遵循本指南可以避免大部分常见的游戏引擎开发错误：

1. **使用正确的定时器系统** - RobotManageNpc
2. **使用正确的API方法** - 验证方法存在性
3. **遵循UI组件命名规范** - 纯文本静态名称
4. **添加完善的错误处理** - try-catch和默认值
5. **验证函数和属性存在性** - 避免运行时错误

记住：**预防胜于治疗**，在开发过程中遵循这些规则可以大大减少错误的发生。
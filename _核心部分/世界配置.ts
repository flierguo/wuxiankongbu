// ==================== 锚点计算函数（大数值版） ====================
import { 智能计算 } from '../大数值/核心计算方法'


/**
 * 世界配置 - 统一管理大陆、地图、生物配置
 * 后续更新只需修改此文件即可
 */

// ==================== 难度等级常量 ====================
export const 难度等级 = {
    简单: { 名称: '简单', 倍数: 1, 下标偏移: 0 },
    普通: { 名称: '普通', 倍数: 2, 下标偏移: 1 },
    困难: { 名称: '困难', 倍数: 3, 下标偏移: 2 },
    精英: { 名称: '精英', 倍数: 5, 下标偏移: 3 },
    炼狱: { 名称: '炼狱', 倍数: 10, 下标偏移: 4 },
} as const

export const 难度列表 = ['简单', '普通', '困难', '精英', '炼狱'] as const

// ==================== 圣耀副本难度配置 ====================
// 圣耀副本的生物强度倍数配置，可快速调整
export const 圣耀难度配置 = {
    基础倍数: 30,           // 圣耀副本基础难度倍数
    每层递增: 5,            // 每层额外增加的倍数
    最大倍数: 1000,         // 最大难度倍数上限
} as const
export const 固定副本数量 = 5  // 每个地图的固定副本数量
export const 最大副本数 = 10

// ==================== 地图名称常量 ====================
export const 地图名称 = {
    浣熊市: '浣熊市',
    蜂巢入口: '蜂巢入口',
    病毒研究室: '病毒研究室',
    生化实验室: '生化实验室',
    激光走廊: '激光走廊',
    红后控制室: '红后控制室',
} as const

// ==================== TAG 刷怪比例常量 ====================
export const TAG刷怪比例 = {
    1: 0.50,   // 基础小怪 50%
    2: 0.25,   // 挑战小怪 25%
    3: 0.15,   // 稀有怪物 15%
    4: 0.08,   // 精英怪物 8%
    5: 0.02,   // 首领怪物 2%
    6: 0.005,  // 大陆BOSS 0.5%（2小时检测补怪）
} as const

// ==================== 刷怪密度配置 ====================
// 每100x100格子的基础怪物数量
export const 刷怪密度 = {
    基础密度: 0.6,      // 每100格子0.8只怪（即10000格子80只）
    最小数量: 200,       // 地图最少怪物数
    最大数量: 2000,      // 地图最多怪物数
} as const

// ==================== 锚点系统配置（简化版） ====================
// 锚点仅决定生物强度
export interface 锚点配置 {
    锚点等级: number        // 基础锚点等级
    生物强度倍数: string    // 生物属性倍数（大数值字符串）
    装备等级基础: number    // 掉落装备的基础等级
}

// ==================== 地图配置接口 ====================
export interface 地图配置项 {
    地图名: string
    下标: number           // 起始下标（每个地图占用10个下标）
    固定星级: number       // 基础星级
    需求等级: number       // 进入等级要求
    地图等级: number       // 地图难度等级（用于属性计算的倍数基础）
    生物强度倍数: string   // 生物属性倍数（大数值字符串）
    地图宽度?: number      // 可选，不填则自动获取
    地图高度?: number      // 可选，不填则自动获取
}

export const 地图配置: 地图配置项[] = [
    { 地图名: 地图名称.浣熊市,     下标: 1,   固定星级: 1,   需求等级: 1,   地图等级: 100,  生物强度倍数: '1' },
    { 地图名: 地图名称.蜂巢入口,   下标: 11,  固定星级: 2,   需求等级: 50,  地图等级: 200,  生物强度倍数: '2' },
    { 地图名: 地图名称.病毒研究室, 下标: 21,  固定星级: 3,   需求等级: 100, 地图等级: 300,  生物强度倍数: '4' },
    { 地图名: 地图名称.生化实验室, 下标: 31,  固定星级: 4,   需求等级: 150, 地图等级: 400,  生物强度倍数: '8' },
    { 地图名: 地图名称.激光走廊,   下标: 41,  固定星级: 5,   需求等级: 200, 地图等级: 500,  生物强度倍数: '16' },
    { 地图名: 地图名称.红后控制室, 下标: 51,  固定星级: 6,   需求等级: 250, 地图等级: 600,  生物强度倍数: '32' },
]


/**
 * 根据地图等级计算锚点（简化版 - 仅生物强度）
 * @param 地图等级 地图基础等级
 * @param 难度倍数 难度系数（简单1，普通2，困难3...）
 * @param 自定义强度倍数 可选的自定义生物强度倍数
 */
export function 计算锚点(地图等级: number, 难度倍数: number = 1, 自定义强度倍数?: string): 锚点配置 {
    const 基础锚点 = Math.floor(地图等级 / 100) + 1
    const 实际锚点 = 基础锚点 * 难度倍数
    
    // 默认生物强度倍数：2^(锚点-1)，使用大数值运算
    let 生物强度倍数 = 智能计算('2', String(实际锚点 - 1), 7)
    
    // 应用自定义强度倍数
    if (自定义强度倍数) {
        // 自定义倍数 * 难度倍数
        生物强度倍数 = 智能计算(自定义强度倍数, String(难度倍数), 3)
    }
    
    return {
        锚点等级: 实际锚点,
        生物强度倍数,
        装备等级基础: 地图等级 * 难度倍数,
    }
}

/**
 * 计算圣耀副本的生物强度倍数
 * @param 基础强度倍数 地图的基础生物强度倍数
 * @param 圣耀倍率 玩家选择的圣耀倍率
 */
export function 计算圣耀强度倍数(基础强度倍数: string, 圣耀倍率: number): string {
    const 圣耀难度 = 圣耀难度配置.基础倍数 + (圣耀倍率 - 1) * 圣耀难度配置.每层递增
    const 实际倍数 = Math.min(圣耀难度, 圣耀难度配置.最大倍数)
    return 智能计算(基础强度倍数, String(实际倍数), 3)
}

// ==================== 大陆配置接口 ====================
export interface 大陆配置项 {
    大陆名: string
    大陆编号: number
    地图列表: string[]           // 地图名列表
    大陆BOSS名字: string         // TAG 6
    特殊BOSS名字: string         // TAG 7
}

// ==================== 大陆配置表 ====================
export const 大陆配置表: 大陆配置项[] = [
    {
        大陆名: '生化篇章',
        大陆编号: 1,
        地图列表: ['浣熊市', '蜂巢入口', '病毒研究室', '生化实验室', '激光走廊', '红后控制室'],
        大陆BOSS名字: '威斯克',
        特殊BOSS名字: '红后',
    },
]

// ==================== 地图生物配置接口 ====================
export interface 地图生物配置项 {
    地图名: string
    生物名字?: {
        TAG1?: string
        TAG2?: string
        TAG3?: string
        TAG4?: string
        TAG5?: string
        TAG6?: string  // 大陆BOSS
    }
}

// ==================== 地图生物配置表 ====================
export const 地图生物配置表: 地图生物配置项[] = [
    { 地图名: '浣熊市', 生物名字: { TAG1: '丧尸', TAG2: '变异丧尸', TAG3: '舔食者', TAG4: '猎杀者', TAG5: '暴君' } },
    { 地图名: '蜂巢入口', 生物名字: { TAG1: '蜂巢丧尸', TAG2: '蜂巢变异体', TAG3: '蜂巢舔食者', TAG4: '蜂巢猎杀者', TAG5: '蜂巢暴君' } },
    { 地图名: '病毒研究室', 生物名字: { TAG1: '实验体A', TAG2: '实验体B', TAG3: '实验体C', TAG4: '实验体D', TAG5: '实验体X' } },
    { 地图名: '生化实验室', 生物名字: { TAG1: '生化兵', TAG2: '生化战士', TAG3: '生化精英', TAG4: '生化队长', TAG5: '生化指挥官' } },
    { 地图名: '激光走廊', 生物名字: { TAG1: '激光守卫', TAG2: '激光战士', TAG3: '激光精英', TAG4: '激光队长', TAG5: '激光指挥官' } },
    { 地图名: '红后控制室', 生物名字: { TAG1: '红后守卫', TAG2: '红后战士', TAG3: '红后精英', TAG4: '红后队长', TAG5: '红后指挥官' } },
]


// ==================== 辅助函数 ====================

/** 根据大陆名获取配置 */
export function 取大陆配置(大陆名: string): 大陆配置项 | null {
    return 大陆配置表.find(c => c.大陆名 === 大陆名) || null
}

/** 根据地图名获取所属大陆 */
export function 取地图所属大陆(地图名: string): 大陆配置项 | null {
    return 大陆配置表.find(c => c.地图列表.includes(地图名)) || null
}

/** 根据地图名获取生物配置 */
export function 取地图生物配置(地图名: string): 地图生物配置项 | null {
    return 地图生物配置表.find(c => c.地图名 === 地图名) || null
}

/** 根据地图名获取地图配置 */
export function 取地图配置(地图名: string): 地图配置项 | null {
    return 地图配置.find(c => c.地图名 === 地图名) || null
}

/** 获取地图的生物名字 */
export function 取生物名字(地图名: string, TAG尾数: number): string {
    const 配置 = 取地图生物配置(地图名)
    if (配置?.生物名字) {
        const key = `TAG${TAG尾数}` as keyof typeof 配置.生物名字
        if (配置.生物名字[key]) {
            return 配置.生物名字[key]!
        }
    }
    // 默认名字
    const 类型名 = ['', '小怪', '精英', '稀有', '精英首领', '首领', '大陆BOSS', '特殊BOSS']
    return `${地图名}${类型名[TAG尾数] || '怪物'}`
}

/** 获取大陆BOSS名字 */
export function 取大陆BOSS名字(地图名: string): string {
    const 大陆 = 取地图所属大陆(地图名)
    return 大陆?.大陆BOSS名字 || '大陆BOSS'
}

/** 获取特殊BOSS名字 */
export function 取特殊BOSS名字(地图名: string): string {
    const 大陆 = 取地图所属大陆(地图名)
    return 大陆?.特殊BOSS名字 || '特殊BOSS'
}

/** 获取难度配置 */
export function 取难度配置(难度名: string) {
    return 难度等级[难度名 as keyof typeof 难度等级] || null
}

/** 获取所有地图名 */
export function 取所有地图名(): string[] {
    return 地图配置.map(c => c.地图名)
}

/** 
 * 智能计算刷怪数量 - 基于地图面积
 * @param AMap 地图对象
 * @param 地图名 地图名称（可选，用于日志）
 * @returns 计算后的怪物总数
 */
export function 智能计算刷怪数量(AMap: TEnvirnoment | null, 地图名?: string): number {
    if (!AMap) return 刷怪密度.最小数量

    const 宽度 = AMap.GetMapWidth() || 100
    const 高度 = AMap.GetMapHeight() || 100
    
    // 计算面积（格子数）
    const 面积 = 宽度 * 高度
    
    // 根据密度计算数量：每100x100格子刷 基础密度 * 100 只怪
    // 例如：200x200的地图 = 40000格子，基础密度0.8，刷怪数 = 40000 * 0.8 / 100 = 320只
    let 数量 = Math.floor(面积 * 刷怪密度.基础密度 / 50)
    
    // 限制范围
    数量 = Math.max(刷怪密度.最小数量, Math.min(刷怪密度.最大数量, 数量))
    
    // console.log(`[刷怪计算] 地图: ${地图名 || AMap.DisplayName}, 尺寸: ${宽度}x${高度}, 面积: ${面积}, 计算数量: ${数量}`)
    
    return 数量
}

/**
 * 智能计算刷怪坐标 - 在地图范围内随机
 * @param AMap 地图对象
 * @returns {x, y, 范围} 坐标和范围
 */
export function 智能计算刷怪坐标(AMap: TEnvirnoment): { x: number, y: number, 范围: number } {
    const 宽度 = AMap?.GetMapWidth() || 100
    const 高度 = AMap?.GetMapHeight() || 100
    
    const x = Math.floor(宽度 / 2)
    const y = Math.floor(高度 / 2)
    const 范围 = Math.floor(Math.max(宽度, 高度) / 2)

    return { x, y, 范围 }
}

// ==================== 锚点计算函数（大数值版） ====================
import { 智能计算 } from '../_大数值/核心计算方法'

/**
 * ============================================================================
 * 世界配置 - 统一管理大陆、地图、生物配置
 * ============================================================================
 * 
 * 【重要说明】
 * 本文件是游戏数值平衡的核心配置文件，所有生物属性和装备属性的计算都基于此配置。
 * 修改本文件前请仔细阅读以下说明，确保理解数值关系。
 * 
 * 【核心公式】
 * - 生物属性 = 基础值 × 地图难度倍数 × TAG倍数（仅3次乘法，优化CPU消耗）
 * - 装备属性 = 基础值 × 地图难度倍数 × 随机倍数(0.8-1.2) × 极品倍率
 * - 地图难度倍数 = 地图强度 × 难度系数
 * 
 * 【设计原则】
 * 1. 约3倍递增：避免指数爆炸，保持数值可控
 * 2. 整数倍数：TAG倍数使用整数，便于理解和调整
 * 3. 统一配置：所有数值计算使用相同的基准配置
 * 4. 性能优先：减少大数值乘法次数，降低CPU消耗
 * 
 * 后续更新只需修改此文件即可
 * ============================================================================
 */

// ==================== 难度系数配置（新版 - 统一数值基准） ====================
/**
 * 难度系数配置表 - 所有数值计算的核心基准
 * 
 * 【设计原则】
 * - 约3倍递增，避免指数爆炸
 * - 玩家获得当前难度满属性装备后，可以挑战下一难度的基础怪物
 * 
 * 【递增关系】
 * - 简单(1) → 普通(3): 3倍递增
 * - 普通(3) → 困难(10): 约3.3倍递增
 * - 困难(10) → 精英(30): 3倍递增
 * - 精英(30) → 炼狱(100): 约3.3倍递增
 * - 炼狱(100) → 圣耀(300): 3倍递增
 * 
 * 【验证规则】
 * - 相邻难度的倍数比例应在2-5倍范围内
 * - 当前难度装备攻击 > 同难度TAG1生物防御（确保玩家能有效击杀）
 * 
 * 【示例计算】（地图强度10，简单难度）
 * - TAG1血量 = 1000 × 10 × 1 × 1 = 10,000
 * - TAG5血量 = 1000 × 10 × 1 × 16 = 160,000
 * - 装备攻击 = 100 × 10 × 1 = 1,000
 */
export const 难度系数配置 = {
    简单: 1,      // 基准难度 - 新手入门
    普通: 3,      // 3倍递增 - 正常游戏
    困难: 10,     // 约3倍递增 - 有一定挑战
    精英: 30,     // 3倍递增 - 需要好装备
    炼狱: 100,    // 约3倍递增 - 高难度挑战
    圣耀: 300,    // 3倍递增 - 终极挑战
} as const

// ==================== TAG倍数配置（新版 - 统一怪物类型强度） ====================
/**
 * TAG倍数配置表 - 统一管理怪物类型强度
 * 
 * 【设计原则】
 * - TAG1-5: 约2倍递增（1→2→4→8→16），形成清晰的难度阶梯
 * - TAG6(大陆BOSS): 约3倍于首领（50），全大陆刷新的强力BOSS
 * - TAG7(特殊BOSS): 10倍于首领（160），杀怪2000后刷新的最强BOSS
 * 
 * 【重要】TAG7 > TAG6，特殊BOSS应该比大陆BOSS更强
 * 
 * 【怪物类型说明】
 * - TAG1 基础小怪: 最弱，大量刷新，用于练级
 * - TAG2 挑战小怪: 较弱，有一定挑战
 * - TAG3 稀有怪物: 中等，掉落较好
 * - TAG4 精英怪物: 较强，需要一定装备
 * - TAG5 首领怪物: 强，地图BOSS级别
 * - TAG6 大陆BOSS: 很强，整个大陆所有地图刷新
 * - TAG7 特殊BOSS: 最强，杀怪2000后刷新
 * 
 * 【示例计算】（地图强度10，简单难度，血量基础1000）
 * - TAG1血量 = 1000 × 10 × 1 = 10,000
 * - TAG2血量 = 1000 × 10 × 2 = 20,000
 * - TAG3血量 = 1000 × 10 × 4 = 40,000
 * - TAG4血量 = 1000 × 10 × 8 = 80,000
 * - TAG5血量 = 1000 × 10 × 16 = 160,000
 * - TAG6血量 = 1000 × 10 × 50 = 500,000
 * - TAG7血量 = 1000 × 10 × 160 = 1,600,000
 */
export const TAG倍数配置: Record<number, number> = {
    1: 1,       // 基础小怪 - 基准（最弱）
    2: 2,       // 挑战小怪 - 2倍
    3: 4,       // 稀有怪物 - 4倍
    4: 8,       // 精英怪物 - 8倍
    5: 16,      // 首领怪物 - 16倍
    6: 50,      // 大陆BOSS - 约3倍于首领（全大陆刷新）
    7: 160,     // 特殊BOSS - 10倍于首领（杀怪2000后刷新，最强）
} as const

// ==================== 生物基础值配置（新版 - 简化计算） ====================
/**
 * 生物基础值配置 - 所有生物属性计算的基础
 * 
 * 【计算公式】
 * 实际属性 = 基础值 × 地图难度倍数 × TAG倍数
 * 地图难度倍数 = 地图强度 × 难度系数
 * 
 * 【属性关系】
 * - 血量:攻击:防御 = 1000:100:50 = 20:2:1
 * - 攻击是防御的2倍，确保玩家能有效击杀怪物
 * - 血量是攻击的10倍，确保战斗有一定时长
 * 
 * 【调整建议】
 * - 如果玩家击杀太快，增加血量基础值
 * - 如果玩家击杀太慢，减少防御基础值
 * - 如果玩家死亡太快，减少攻击基础值
 */
export const 生物基础值配置 = {
    血量: 1000,   // 血量基础值 - 决定怪物生存时间
    攻击: 100,    // 攻击基础值 - 决定怪物伤害
    防御: 50,     // 防御基础值 - 决定怪物减伤
} as const

// ==================== 装备基础值配置（新版 - 简化计算） ====================
/**
 * 装备基础值配置 - 所有装备属性计算的基础
 * 
 * 【计算公式】
 * 实际属性 = 基础值 × 地图难度倍数 × 随机倍数(0.8-1.2) × 极品倍率
 * 
 * 【平衡关系】
 * - 装备攻击基础(100) = 生物攻击基础(100)
 * - 确保同难度装备能有效应对同难度怪物
 * - 随机倍数(0.8-1.2)提供小范围波动，增加装备多样性
 * 
 * 【调整建议】
 * - 如果装备太弱，增加属性基础值
 * - 如果装备太强，减少属性基础值
 */
export const 装备基础值配置 = {
    属性基础: 1000,  // 装备属性基础值 - 与生物攻击基础相同
    魔次基础: 5,   // 魔次属性基础值 - 技能加成
} as const

// 难度列表（从难度系数配置自动生成）
export const 难度列表 = Object.keys(难度系数配置) as (keyof typeof 难度系数配置)[]

// ==================== 装备倍数怪配置 ====================
/**
 * 装备倍数怪配置
 * 
 * 【触发几率】1/100（1%）
 * 
 * 【倍数权重池】
 * - 10个3倍, 9个4倍, 8个5倍, 7个6倍, 6个7倍
 * - 5个8倍, 3个9-11倍, 2个12-15倍, 1个16-20倍
 * 
 * 【效果】
 * - 怪物变为金色
 * - 名称显示"装备属性翻倍*X倍"
 * - 掉落装备的基础属性翻X倍（魔次不翻倍）
 */
export const 装备倍数怪配置 = {
    触发几率: 100,  // 1/100 = 1%
    倍数池: [
        // 10个3倍
        3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
        // 9个4倍
        4, 4, 4, 4, 4, 4, 4, 4, 4,
        // 8个5倍
        5, 5, 5, 5, 5, 5, 5, 5,
        // 7个6倍
        6, 6, 6, 6, 6, 6, 6,
        // 6个7倍
        7, 7, 7, 7, 7, 7,
        // 5个8倍
        8, 8, 8, 8, 8,
        // 3个9-11倍
        9, 9, 9, 10, 10, 10, 11, 11, 11,
        // 2个12-15倍
        12, 12, 13, 13, 14, 14, 15, 15,
        // 1个16-20倍
        16, 17, 18, 19, 20,
    ] as const,
} as const

/**
 * 获取随机装备倍数
 * @returns 随机倍数值（3-20）
 */
export function 获取随机装备倍数(): number {
    const 池 = 装备倍数怪配置.倍数池
    return 池[Math.floor(Math.random() * 池.length)]
}

// ==================== 圣耀副本难度配置 ====================
export const 圣耀难度配置 = {
    基础倍数: 30,
    每层递增: 5,
    最大倍数: 1000,
} as const

export const 固定副本数量 = 6  // 6个难度等级：简单、普通、困难、精英、炼狱、圣耀
export const 最大副本数 = 10

// ==================== TAG 刷怪比例常量 ====================
export const TAG刷怪比例 = {
    1: 0.50,   // 基础小怪 50%
    2: 0.25,   // 挑战小怪 25%
    3: 0.15,   // 稀有怪物 15%
    4: 0.08,   // 精英怪物 8%
    5: 0.02,   // 首领怪物 2%
    6: 0.005,  // 大陆BOSS 0.5%
} as const

// ==================== 刷怪密度配置 ====================
export const 刷怪密度 = {
    基础密度: 0.6,
    最小数量: 200,
    最大数量: 2000,
} as const

// ==================== 锚点系统配置 ====================
export interface 锚点配置 {
    锚点等级: number
    生物强度倍数: string
    装备等级基础: number
}

// ==================== 完整地图配置接口 ====================
/**
 * 完整地图配置 - 统一管理地图、生物、装备、大陆配置
 * 只需修改这一个配置表即可调整整个游戏数值
 */
export interface 完整地图配置项 {
    // === 基础信息 ===
    地图名: string
    下标: number
    需求等级: number

    // === 生物配置 ===
    地图强度: number
    固定星级: number
    生物强度倍数: string
    生物名字: string[]      // [TAG1小怪, TAG2挑战, TAG3稀有, TAG4精英, TAG5首领]

    // === 装备配置 ===
    装备属性倍数: number

    // === 大陆配置 ===
    大陆名: string
    大陆编号: number
    大陆BOSS名字: string    // TAG6
    特殊BOSS名字: string    // TAG7

    // === 可选配置 ===
    地图宽度?: number
    地图高度?: number
}

// ==================== 核心配置表（只需修改这里） ====================
/**
 * 完整地图配置表 - 统一管理所有地图
 * 生物名字数组顺序: [TAG1小怪, TAG2挑战, TAG3稀有, TAG4精英, TAG5首领]
 */
export const 完整地图配置: 完整地图配置项[] = [
    {
        地图名: '新手地图',
        下标: 1,
        需求等级: 1,
        地图强度: 10,
        固定星级: 1,
        生物强度倍数: '1',
        生物名字: ['鸡', '稻草人', '洞蛆', '山洞蝙蝠', '蝎子'],
        装备属性倍数: 1,
        大陆名: '生化篇章',
        大陆编号: 1,
        大陆BOSS名字: '威斯克',
        特殊BOSS名字: '红后'
    },
    {
        地图名: '浣熊市',
        下标: 101,
        需求等级: 1,
        地图强度: 10,
        固定星级: 101,
        生物强度倍数: '1',
        生物名字: ['丧尸', '变异丧尸', '舔食者', '猎杀者', '暴君'],
        装备属性倍数: 1,
        大陆名: '生化篇章',
        大陆编号: 1,
        大陆BOSS名字: '威斯克',
        特殊BOSS名字: '红后'
    },
    {
        地图名: '蜂巢入口',
        下标: 111,
        需求等级: 50,
        地图强度: 200,
        固定星级: 111,
        生物强度倍数: '2',
        生物名字: ['蜂巢丧尸', '蜂巢变异体', '蜂巢舔食者', '蜂巢猎杀者', '蜂巢暴君'],
        装备属性倍数: 1.5,
        大陆名: '生化篇章',
        大陆编号: 1,
        大陆BOSS名字: '威斯克',
        特殊BOSS名字: '红后'
    },
    {
        地图名: '病毒研究室',
        下标: 121,
        需求等级: 100,
        地图强度: 300,
        固定星级: 121,
        生物强度倍数: '4',
        生物名字: ['实验体A', '实验体B', '实验体C', '实验体D', '实验体X'],
        装备属性倍数: 2,
        大陆名: '生化篇章',
        大陆编号: 1,
        大陆BOSS名字: '威斯克',
        特殊BOSS名字: '红后'
    },
    {
        地图名: '生化实验室',
        下标: 131,
        需求等级: 150,
        地图强度: 400,
        固定星级: 131,
        生物强度倍数: '8',
        生物名字: ['生化兵', '生化战士', '生化精英', '生化队长', '生化指挥官'],
        装备属性倍数: 3,
        大陆名: '生化篇章',
        大陆编号: 1,
        大陆BOSS名字: '威斯克',
        特殊BOSS名字: '红后'
    },
    {
        地图名: '激光走廊',
        下标: 141,
        需求等级: 200,
        地图强度: 500,
        固定星级: 141,
        生物强度倍数: '16',
        生物名字: ['激光守卫', '激光战士', '激光精英', '激光队长', '激光指挥官'],
        装备属性倍数: 4,
        大陆名: '生化篇章',
        大陆编号: 1,
        大陆BOSS名字: '威斯克',
        特殊BOSS名字: '红后'
    },
    {
        地图名: '红后控制室',
        下标: 151,
        需求等级: 250,
        地图强度: 600,
        固定星级: 151,
        生物强度倍数: '32',
        生物名字: ['红后守卫', '红后战士', '红后精英', '红后队长', '红后指挥官'],
        装备属性倍数: 5,
        大陆名: '生化篇章',
        大陆编号: 1,
        大陆BOSS名字: '威斯克',
        特殊BOSS名字: '红后'
    },
]

/**
 * 根据地图强度计算锚点
 * @param 地图强度 地图基础强度
 * @param 难度倍数 难度系数
 * @param 自定义强度倍数 可选的自定义生物强度倍数
 */
export function 计算锚点(地图强度: number, 难度倍数: number = 1, 自定义强度倍数?: string): 锚点配置 {
    const 基础锚点 = 地图强度
    const 实际锚点 = 基础锚点 * 难度倍数

    let 生物强度倍数 = 智能计算('2', String(实际锚点 - 1), 7)

    if (自定义强度倍数) {
        生物强度倍数 = 智能计算(自定义强度倍数, String(难度倍数), 3)
    }

    return {
        锚点等级: 实际锚点,
        生物强度倍数,
        装备等级基础: 地图强度 * 难度倍数,
    }
}

/**
 * 计算圣耀副本的生物强度倍数
 */
export function 计算圣耀强度倍数(基础强度倍数: string, 圣耀倍率: number): string {
    const 圣耀难度 = 圣耀难度配置.基础倍数 + (圣耀倍率 - 1) * 圣耀难度配置.每层递增
    const 实际倍数 = Math.min(圣耀难度, 圣耀难度配置.最大倍数)
    return 智能计算(基础强度倍数, String(实际倍数), 3)
}

// ==================== 辅助函数 ====================

/** 根据地图名获取完整配置 */
export function 取完整地图配置(地图名: string): 完整地图配置项 | null {
    return 完整地图配置.find(c => c.地图名 === 地图名) || null
}

/** 根据大陆名获取该大陆的所有地图 */
export function 取大陆地图列表(大陆名: string): 完整地图配置项[] {
    return 完整地图配置.filter(c => c.大陆名 === 大陆名)
}

/** 获取所有地图名 */
export function 取所有地图名(): string[] {
    return 完整地图配置.map(c => c.地图名)
}

/** 获取所有大陆名（去重） */
export function 取所有大陆名(): string[] {
    return [...new Set(完整地图配置.map(c => c.大陆名))]
}

/** 获取地图的生物名字 */
export function 取生物名字(地图名: string, TAG尾数: number): string {
    const 配置 = 取完整地图配置(地图名)
    if (!配置) {
        return `${地图名}怪物`
    }

    // TAG6 = 大陆BOSS
    if (TAG尾数 === 6) {
        return 配置.大陆BOSS名字
    }

    // TAG7 = 特殊BOSS
    if (TAG尾数 === 7) {
        return 配置.特殊BOSS名字
    }

    // TAG1-5 从生物名字数组获取
    const 索引 = TAG尾数 - 1
    if (索引 >= 0 && 索引 < 配置.生物名字.length) {
        return 配置.生物名字[索引]
    }

    // 默认名字
    const 类型名 = ['', '小怪', '精英', '稀有', '精英首领', '首领']
    return `${地图名}${类型名[TAG尾数] || '怪物'}`
}

/** 获取难度配置（返回难度系数） */
export function 取难度配置(难度名: string): number {
    return 难度系数配置[难度名 as keyof typeof 难度系数配置] || 1
}

/** 智能计算刷怪数量 */
export function 智能计算刷怪数量(AMap: TEnvirnoment | null): number {
    if (!AMap) return 刷怪密度.最小数量

    const 宽度 = AMap.GetMapWidth() || 100
    const 高度 = AMap.GetMapHeight() || 100
    const 面积 = 宽度 * 高度

    let 数量 = Math.floor(面积 * 刷怪密度.基础密度 / 50)
    数量 = Math.max(刷怪密度.最小数量, Math.min(刷怪密度.最大数量, 数量))

    return 数量
}

/** 智能计算刷怪坐标 */
export function 智能计算刷怪坐标(AMap: TEnvirnoment): { x: number, y: number, 范围: number } {
    const 宽度 = AMap?.GetMapWidth() || 100
    const 高度 = AMap?.GetMapHeight() || 100

    const x = Math.floor(宽度 / 2)
    const y = Math.floor(高度 / 2)
    const 范围 = Math.floor(Math.max(宽度, 高度) / 2)

    return { x, y, 范围 }
}

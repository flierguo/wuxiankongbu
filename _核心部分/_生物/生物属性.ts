/*怪物刷新单元 - 基于星级的生物属性系统（关联版）*/
/*
 * 优化说明：
 * 1. 星级驱动：所有属性基于地图固定星级计算
 * 2. 关联计算：生物属性 = 基础值 × 星级倍数 × TAG倍数 × 难度系数
 * 3. 性能优化：先合并小数值倍数，最后只进行1次大数值乘法
 * 4. 统一配置：从世界配置.ts导入所有配置
 */

import { 血量显示, 随机小数 } from "../字符计算"
import { 智能计算, 比较 } from "../../_大数值/核心计算方法"
import { 生成怪物随机技能, 获取技能2血量倍数, 获取技能2攻击倍数, 获取技能2防御倍数, 设置怪物技能变量, 生成怪物技能名字 } from "./生物随机技能"
import { 怪物类型, 进化加一, TAG, 原始名字, 基础数值, 怪物攻速移速, 怪物爆率文件, 怪物等级, 怪物变量等级, 怪物显示称号, 怪物经验值, 怪物装备倍数, 怪物颜色 as 怪物颜色常量, 怪物装备属性 } from "../基础常量"
import { 
    完整地图配置, 
    完整地图配置项, 
    TAG倍数配置, 
    难度系数配置, 
    装备倍数怪配置, 
    获取随机装备倍数,
    计算星级倍数,
    生物基础值配置
} from "../世界配置"

// ==================== 生物属性倍数配置（简化版 - 星级驱动） ====================
/**
 * 生物属性倍数配置 - 基于星级的简化计算
 * 
 * 【核心公式】
 * 生物属性 = 生物基础值 × 星级倍数 × TAG倍数 × 难度系数 × 随机波动
 * 
 * 【设计原则】
 * - 星级倍数是核心，由地图固定星级自动计算
 * - TAG倍数控制同地图不同怪物的强度差异
 * - 难度系数控制同地图不同难度的强度差异
 * - 随机波动增加生物多样性
 */

// 随机波动配置（增加生物多样性）
export const 随机波动配置 = {
    血量波动: { 最小: 1.5, 最大: 3.5 },   // 血量随机波动 80%-120%
    攻击波动: { 最小: 0.9, 最大: 1.1 },   // 攻击随机波动 90%-110%
    防御波动: { 最小: 0.85, 最大: 1.15 }, // 防御随机波动 85%-115%
} as const

// 特殊词缀配置（稀有怪物额外加成）
export const 特殊词缀配置 = {
    // 词缀触发几率（百分比）- 使用生物类型枚举值作为键
    触发几率: {
        1: 5,    // 基础小怪 5%
        2: 10,   // 挑战小怪 10%
        3: 20,   // 稀有怪物 20%
        4: 35,   // 精英怪物 35%
        5: 50,   // 首领怪物 50%
        6: 80,   // 大陆BOSS 80%
        7: 100,  // 特殊BOSS 100%
    } as Record<number, number>,
    // 词缀池（名称 -> 属性倍数）
    词缀池: [
        { 名称: '狂暴', 血量倍数: 1.0, 攻击倍数: 1.5, 防御倍数: 0.8, 颜色: 249 },
        { 名称: '坚韧', 血量倍数: 1.3, 攻击倍数: 0.9, 防御倍数: 1.5, 颜色: 154 },
        { 名称: '迅捷', 血量倍数: 0.8, 攻击倍数: 1.2, 防御倍数: 0.9, 颜色: 250 },
        { 名称: '巨型', 血量倍数: 2.0, 攻击倍数: 1.3, 防御倍数: 1.2, 颜色: 243 },
        { 名称: '精锐', 血量倍数: 1.2, 攻击倍数: 1.2, 防御倍数: 1.2, 颜色: 241 },
        { 名称: '嗜血', 血量倍数: 0.9, 攻击倍数: 1.8, 防御倍数: 0.7, 颜色: 249 },
        { 名称: '铁壁', 血量倍数: 1.5, 攻击倍数: 0.8, 防御倍数: 2.0, 颜色: 154 },
        { 名称: '幽灵', 血量倍数: 0.7, 攻击倍数: 1.4, 防御倍数: 1.4, 颜色: 241 },
        { 名称: '远古', 血量倍数: 1.8, 攻击倍数: 1.5, 防御倍数: 1.3, 颜色: 251 },
        { 名称: '噩梦', 血量倍数: 1.5, 攻击倍数: 1.5, 防御倍数: 1.5, 颜色: 249 },
    ],
} as const

// ==================== 星级倍数缓存（性能优化） ====================
// 同一星级的倍数在整个运行期间不会变化，缓存避免重复的大数值幂运算
const 星级倍数缓存: Record<number, string> = {}

function 获取缓存星级倍数(固定星级: number): string {
    if (星级倍数缓存[固定星级]) return 星级倍数缓存[固定星级]
    const 倍数 = 计算星级倍数(固定星级)
    星级倍数缓存[固定星级] = 倍数
    return 倍数
}

// ==================== 生物属性倍数计算器（简化版） ====================
/**
 * 生物属性倍数信息接口
 */
interface 生物属性倍数信息 {
    // 核心倍数
    星级倍数: string        // 由地图固定星级计算（大数值）
    TAG倍数: number         // 由TAG类型决定
    难度系数: number        // 由副本难度决定
    
    // 技能倍数
    技能血量倍数: number
    技能攻击倍数: number
    技能防御倍数: number
    
    // 随机波动倍数
    随机血量倍数: number
    随机攻击倍数: number
    随机防御倍数: number
    
    // 特殊词缀倍数
    词缀血量倍数: number
    词缀攻击倍数: number
    词缀防御倍数: number
    词缀名称: string
    词缀颜色: number
    
    // === 综合小数值倍数（合并后，用于减少大数值乘法） ===
    综合血量倍数: number
    综合攻击倍数: number
    综合防御倍数: number
}

/**
 * 计算生物属性综合倍数（简化版 - 星级驱动）
 * 
 * @param 生物类型 生物类型枚举值
 * @param 固定星级 地图固定星级
 * @param TAG倍数 TAG倍数
 * @param 难度系数 难度系数
 * @param 技能信息 怪物技能信息
 * @returns 生物属性倍数信息
 */
export function 计算生物属性倍数(
    生物类型: number,
    固定星级: number,
    TAG倍数: number,
    难度系数: number,
    技能信息: { 技能2: string }
): 生物属性倍数信息 {
    // 1. 计算星级倍数（核心）— 使用缓存避免重复幂运算
    const 星级倍数 = 获取缓存星级倍数(固定星级)
    
    // 2. 获取技能倍数
    const 技能血量倍数 = 获取技能2血量倍数(技能信息.技能2)
    const 技能攻击倍数 = 获取技能2攻击倍数(技能信息.技能2)
    const 技能防御倍数 = 获取技能2防御倍数(技能信息.技能2)
    
    // 3. 计算随机波动倍数
    const 随机血量倍数 = 随机小数(随机波动配置.血量波动.最小, 随机波动配置.血量波动.最大)
    const 随机攻击倍数 = 随机小数(随机波动配置.攻击波动.最小, 随机波动配置.攻击波动.最大)
    const 随机防御倍数 = 随机小数(随机波动配置.防御波动.最小, 随机波动配置.防御波动.最大)
    
    // 4. 计算特殊词缀倍数
    let 词缀血量倍数 = 1
    let 词缀攻击倍数 = 1
    let 词缀防御倍数 = 1
    let 词缀名称 = ''
    let 词缀颜色 = 0
    
    const 触发几率 = 特殊词缀配置.触发几率[生物类型] || 0
    if (random(100) < 触发几率) {
        const 词缀 = 特殊词缀配置.词缀池[random(特殊词缀配置.词缀池.length)]
        词缀血量倍数 = 词缀.血量倍数
        词缀攻击倍数 = 词缀.攻击倍数
        词缀防御倍数 = 词缀.防御倍数
        词缀名称 = 词缀.名称
        词缀颜色 = 词缀.颜色
    }
    
    // 5. 合并所有小数值倍数（关键优化：减少大数值乘法次数）
    // 综合倍数 = TAG倍数 × 难度系数 × 技能倍数 × 随机倍数 × 词缀倍数
    const 综合血量倍数 = TAG倍数 * 难度系数 * 技能血量倍数 * 随机血量倍数 * 词缀血量倍数
    const 综合攻击倍数 = TAG倍数 * 难度系数 * 技能攻击倍数 * 随机攻击倍数 * 词缀攻击倍数
    const 综合防御倍数 = TAG倍数 * 难度系数 * 技能防御倍数 * 随机防御倍数 * 词缀防御倍数
    
    return {
        星级倍数,
        TAG倍数,
        难度系数,
        技能血量倍数,
        技能攻击倍数,
        技能防御倍数,
        随机血量倍数,
        随机攻击倍数,
        随机防御倍数,
        词缀血量倍数,
        词缀攻击倍数,
        词缀防御倍数,
        词缀名称,
        词缀颜色,
        综合血量倍数,
        综合攻击倍数,
        综合防御倍数,
    }
}

/**
 * 应用综合倍数计算最终属性（优化版）
 * 优化：只进行1次大数值乘法（基础值 × 综合小数值倍数 合并后 × 星级倍数）
 * 
 * @param 基础值 属性基础值（从生物基础值配置获取）
 * @param 星级倍数 星级倍数（大数值字符串）
 * @param 综合倍数 合并后的综合小数值倍数
 * @returns 最终属性值（大数值字符串）
 */
export function 应用综合倍数(基础值: number, 星级倍数: string, 综合倍数: number): string {
    // 先合并基础值和综合倍数（小数值运算）
    const 小数值合并 = 基础值 * 综合倍数
    // 只进行1次大数值乘法
    return 智能计算(星级倍数, String(小数值合并), 3)
}
// ==================== 数值平衡配置（简化版） ====================
/**
 * 生物属性配置
 * 包含魔次抵抗和经验值相关配置
 */
const 数值平衡配置 = {
    魔次抵抗系数: 10000,     // 魔次抵抗计算系数：防御/系数
    魔次抵抗上限倍数: 5,     // 魔次抵抗上限 = 固定星级 * 倍数
    经验值波动: { 最小: 0.9, 最大: 1.1 },  // 经验值随机波动 90%-110%
} as const

// ==================== 生物类型定义 ====================
// 1-5: 正常刷新生物（难度递增）
// 6: 特殊BOSS（杀怪2000后刷新，难度很高）
// 7: 大陆BOSS（整个大陆所有地图刷新，难度最高）
export const 生物类型枚举 = {
    基础小怪: 1,      // 最弱
    挑战小怪: 2,      // 较弱
    稀有怪物: 3,      // 中等
    精英怪物: 4,      // 较强
    首领怪物: 5,      // 强
    特殊BOSS: 6,      // 很强（杀怪2000后刷新）
    大陆BOSS: 7,      // 最强（全大陆刷新）
} as const

// ==================== 怪物称号特效 ====================
const 怪物称号特效 = {
    无: 0,
    BOSS: 22,
    精英: 21,
    稀有: 0,
    首领: 23,
    大陆BOSS: 25,
    特殊BOSS: 22,
}

// ==================== 怪物颜色配置 ====================
const 怪物颜色配置 = {
    基础白: 255,
    挑战绿: 250,
    稀有蓝: 154,
    精英紫: 241,
    首领橙: 243,
    大陆BOSS红: 249,
    特殊BOSS金: 251,
}

// ==================== 生物配置接口（简化版） ====================
interface 生物配置项 {
    类型名称: string
    经验倍数: number
    颜色: number
    称号: number
    爆率倍数: number
}

// ==================== 生物配置表（简化版 - 基础值从世界配置获取） ====================
/**
 * 生物配置表 - 只保留非数值配置
 * 血量/攻击/防御基础值统一从 生物基础值配置 获取
 * 不同TAG的强度差异由 TAG倍数配置 控制
 */
const 生物配置表: Record<number, 生物配置项> = {
    [生物类型枚举.基础小怪]: {
        类型名称: '基础',
        经验倍数: 1,
        颜色: 怪物颜色配置.基础白,
        称号: 怪物称号特效.无,
        爆率倍数: 1,
    },
    [生物类型枚举.挑战小怪]: {
        类型名称: '挑战',
        经验倍数: 3,
        颜色: 怪物颜色配置.挑战绿,
        称号: 怪物称号特效.无,
        爆率倍数: 1,
    },
    [生物类型枚举.稀有怪物]: {
        类型名称: '稀有',
        经验倍数: 15,
        颜色: 怪物颜色配置.稀有蓝,
        称号: 怪物称号特效.无,
        爆率倍数: 1,
    },
    [生物类型枚举.精英怪物]: {
        类型名称: '精英',
        经验倍数: 45,
        颜色: 怪物颜色配置.精英紫,
        称号: 怪物称号特效.精英,
        爆率倍数: 1,
    },
    [生物类型枚举.首领怪物]: {
        类型名称: '首领',
        经验倍数: 135,
        颜色: 怪物颜色配置.首领橙,
        称号: 怪物称号特效.首领,
        爆率倍数: 2,
    },
    [生物类型枚举.特殊BOSS]: {
        类型名称: '特殊BOSS',
        经验倍数: 500,
        颜色: 怪物颜色配置.特殊BOSS金,
        称号: 怪物称号特效.特殊BOSS,
        爆率倍数: 3,
    },
    [生物类型枚举.大陆BOSS]: {
        类型名称: '大陆BOSS',
        经验倍数: 1000,
        颜色: 怪物颜色配置.大陆BOSS红,
        称号: 怪物称号特效.大陆BOSS,
        爆率倍数: 5,
    },
}

// ==================== 获取地图信息（简化版 - 星级驱动） ====================

interface 地图难度信息 {
    固定星级: number        // 核心常量
    难度名称: string
    难度系数: number
    爆率文件: string
    装备等级: number
    地图配置项?: 完整地图配置项
}

// ==================== 地图难度信息缓存（性能优化） ====================
// 同一地图ID的难度信息在运行期间不会变化，缓存避免每只怪物都遍历副本池
const 地图难度缓存: Record<string, 地图难度信息> = {}

/**
 * 从地图获取难度信息（带缓存 - 避免每只怪物都遍历副本池）
 */
function 获取地图难度信息(Envir: TEnvirnoment): 地图难度信息 {
    const 地图名 = Envir.GetMapName()

    // 命中缓存直接返回
    if (地图难度缓存[地图名]) return 地图难度缓存[地图名]

    const 显示名 = Envir.DisplayName || ''

    // 默认值
    let 固定星级 = 1
    let 难度名称 = '简单'
    let 难度系数 = 1
    let 爆率文件 = '默认'
    let 找到的配置项: 完整地图配置项 | undefined

    // 从副本池获取难度名称和爆率文件（固定星级由下方配置表决定，不从副本池取）
    const 副本池 = GameLib.R.地图池 as any[]
    if (副本池 && 副本池.length > 0) {
        for (const 副本 of 副本池) {
            if (副本 && 副本.地图ID === 地图名) {
                难度名称 = 副本.难度 || '简单'
                爆率文件 = 副本.地图名 || '默认'
                break
            }
        }
    }

    // 根据显示名解析难度系数
    if (显示名.includes('简单')) {
        难度名称 = '简单'
        难度系数 = 难度系数配置.简单
    } else if (显示名.includes('普通')) {
        难度名称 = '普通'
        难度系数 = 难度系数配置.普通
    } else if (显示名.includes('困难')) {
        难度名称 = '困难'
        难度系数 = 难度系数配置.困难
    } else if (显示名.includes('精英')) {
        难度名称 = '精英'
        难度系数 = 难度系数配置.精英
    } else if (显示名.includes('炼狱')) {
        难度名称 = '炼狱'
        难度系数 = 难度系数配置.炼狱
    } else if (显示名.includes('圣耀')) {
        难度名称 = '圣耀'
        难度系数 = 难度系数配置.圣耀
    }

    // 根据地图配置查找
    for (const 配置 of 完整地图配置) {
        if (显示名.includes(配置.地图名)) {
            固定星级 = 配置.固定星级
            爆率文件 = 配置.地图名
            找到的配置项 = 配置
            break
        }
    }

    const 结果: 地图难度信息 = {
        固定星级,
        难度名称,
        难度系数,
        爆率文件,
        装备等级: 固定星级,
        地图配置项: 找到的配置项
    }

    // 写入缓存
    地图难度缓存[地图名] = 结果
    return 结果
}

/**
 * 根据Tag获取生物类型
 * Tag % 10 的值对应生物类型
 */
function 获取生物类型(Tag: number): number {
    const 尾数 = Tag % 10
    // 映射Tag尾数到生物类型
    switch (尾数) {
        case 1: return 生物类型枚举.基础小怪
        case 2: return 生物类型枚举.挑战小怪
        case 3: return 生物类型枚举.稀有怪物
        case 4: return 生物类型枚举.精英怪物
        case 5: return 生物类型枚举.首领怪物
        case 6: return 生物类型枚举.大陆BOSS
        case 7: return 生物类型枚举.特殊BOSS
        default: return 生物类型枚举.基础小怪
    }
}


// ==================== 主刷新函数（星级驱动版） ====================
/**
 * 生物刷新函数 - 星级驱动版
 * 
 * 【核心公式】
 * 生物属性 = 生物基础值 × 星级倍数 × TAG倍数 × 难度系数 × 随机波动
 * 
 * 【优化】
 * - 先合并所有小数值倍数，最后只进行1次大数值乘法
 * - 星级倍数是核心，由地图固定星级自动计算
 */
export function Refresh(Envir: TEnvirnoment, Monster: TActor, Tag: number): void {
    Randomize()

    // 检查是否已进化
    if (Monster.GetNVar(进化加一) == 1) {
        return
    }

    // 保存原始名字
    Monster.SetSVar(原始名字, Monster.GetName())
    Monster.SetAlwaysShowHP(true)

    // 获取地图难度信息（核心：固定星级）
    const 地图信息 = 获取地图难度信息(Envir)

    // 获取生物类型
    const 生物类型 = 获取生物类型(Tag)
    const 配置 = 生物配置表[生物类型]

    if (!配置) {
        console.log(`[生物属性] 未找到生物类型配置: ${生物类型}`)
        return
    }

    // 生成怪物随机技能
    const 技能信息 = 生成怪物随机技能(生物类型)

    // ==================== 星级驱动属性计算（优化版） ====================
    // 获取TAG倍数（从统一配置）
    const 怪物TAG = Tag % 10
    const TAG系数 = TAG倍数配置[怪物TAG] || 1

    // 计算生物属性综合倍数（合并所有小数值倍数）
    const 倍数信息 = 计算生物属性倍数(
        生物类型,
        地图信息.固定星级,
        TAG系数,
        地图信息.难度系数,
        技能信息
    )

    // 应用综合倍数计算最终属性（只进行1次大数值乘法）
    let 血量 = 应用综合倍数(生物基础值配置.血量, 倍数信息.星级倍数, 倍数信息.综合血量倍数)
    let 攻击 = 应用综合倍数(生物基础值配置.攻击, 倍数信息.星级倍数, 倍数信息.综合攻击倍数)
    let 防御 = 应用综合倍数(生物基础值配置.防御, 倍数信息.星级倍数, 倍数信息.综合防御倍数)

    // 魔次抵抗计算
    let 魔次抵抗 = 智能计算(防御, String(数值平衡配置.魔次抵抗系数), 4)

    // 魔次抵抗上限控制（基于固定星级）
    const 魔次抵抗上限 = 智能计算(String(地图信息.固定星级), String(数值平衡配置.魔次抵抗上限倍数), 3)
    if (比较(魔次抵抗, 魔次抵抗上限) > 0) {
        魔次抵抗 = 魔次抵抗上限
    }

    // 经验值计算（带随机波动）
    const 经验波动 = getRandomDecimal(数值平衡配置.经验值波动.最小, 数值平衡配置.经验值波动.最大)
    const 经验值 = Math.floor(地图信息.固定星级 * 配置.经验倍数 * 经验波动)

    // 特殊处理：新手地图防御为0
    // if (地图信息.固定星级 <= 15) {
    //     防御 = '0'
    // }
    // 低星级地图魔次抵抗为0
    if (地图信息.固定星级 < 10 || 比较(魔次抵抗, '0') < 0) {
        魔次抵抗 = '0'
    }

    // ==================== 设置怪物属性 ====================

    // ==================== 装备倍数怪判定（1/100几率） ====================
    let 装备倍数 = 0
    let 最终颜色 = 倍数信息.词缀颜色 > 0 ? 倍数信息.词缀颜色 : 配置.颜色
    let 最终名字前缀 = ''

    // 词缀名称前缀
    if (倍数信息.词缀名称) {
        最终名字前缀 = `[${倍数信息.词缀名称}]`
    }

    // 1/100几率成为装备倍数怪（TAG6/7 BOSS不参与）
    if (生物类型 <= 生物类型枚举.首领怪物 && random(装备倍数怪配置.触发几率) < 1) {
        装备倍数 = 获取随机装备倍数()
        最终颜色 = 怪物颜色常量.装备倍数怪金  // 金色
        最终名字前缀 = `[装备${装备倍数}倍]` + 最终名字前缀
    }

    // 设置装备倍数变量（供装备掉落使用）
    Monster.SetNVar(怪物装备倍数, 装备倍数)

    // 基础属性（引擎限制内的固定值）
    Monster.SetDCMax(999)
    Monster.SetDCMin(999)
    Monster.SetACMax(0)
    Monster.SetACMin(0)
    Monster.SetMaxHP(99999999999999)
    Monster.SetHP(99999999999999)

    // 经验和爆率
    Monster.SetExp(经验值)
    Monster.SetDropName(地图信息.爆率文件)
    Monster.SetDropItemRate(配置.爆率倍数)

    // 攻速移速
    Monster.SetAttackSpeed(技能信息.攻速移速)
    Monster.SetWalkSpeed(技能信息.攻速移速)
    Monster.SetAttackRange(技能信息.距离)

    // 颜色和称号（词缀怪或装备倍数怪使用特殊颜色）
    Monster.SetNameColor(最终颜色)
    if (配置.称号 > 0) {
        Monster.SetTitleEffect(配置.称号)
    }

    // 设置变量
    Monster.SetNVar(怪物类型, 生物类型)
    Monster.SetNVar(怪物等级, 地图信息.装备等级)
    Monster.SetNVar(怪物经验值, 经验值)
    Monster.SetNVar(怪物攻速移速, 技能信息.攻速移速)
    Monster.SetNVar(怪物显示称号, 配置.称号)
    Monster.SetNVar(怪物变量等级, 地图信息.固定星级)
    Monster.SetNVar(TAG, Tag % 10)

    // 存储装备属性倍数（星级倍数字符串，供装备掉落使用）
    Monster.SetSVar(怪物装备属性, 倍数信息.星级倍数)

    Monster.SetSVar(怪物爆率文件, 地图信息.爆率文件)
    // 装备基础（使用固定星级）
    Monster.SetSVar(基础数值, String(地图信息.固定星级))

    // 设置怪物技能变量
    设置怪物技能变量(Monster, 技能信息)
    Monster.SetTriggerSelectMagicBeforeAttack(true)
    Monster.SetConfuseBitTimeBeAttacked(true)

    // 存储计算后的属性（用于战斗计算）
    Monster.SetSVar(91, 血量)  // 当前血量
    Monster.SetSVar(92, 血量)  // 最大血量
    Monster.SetSVar(93, 攻击)  // 攻击
    Monster.SetSVar(94, 防御)  // 防御
    Monster.SetSVar(95, 魔次抵抗)  // 魔次抵抗
    Monster.SetSVar(96, 防御)  // 备用

    // 生成怪物名字（加入词缀和装备倍数前缀）
    const 怪物原始名字 = Monster.GetSVar(原始名字) || Monster.GetName()
    const 怪物技能名字 = 生成怪物技能名字(技能信息, 怪物原始名字)
    const 最终怪物名字 = 最终名字前缀 + 怪物技能名字
    Monster.SetSVar(97, 最终怪物名字)
    Monster.Name = 最终怪物名字

    if (生物类型 === 生物类型枚举.大陆BOSS) {
        GameLib.BroadcastTopMessage(`{s=【大陆BOSS】${Monster.Name} 出现在 ${Envir.DisplayName} 坐标 ${Monster.GetMapX()} ${Monster.GetMapY()};c=249}`)
        GameLib.BroadcastCountDownMessage(`{s=【大陆BOSS】;c=249}${Monster.Name} 出现在 ${Envir.DisplayName} 显示时间:<$Time:20$>…`)
    } else if (生物类型 === 生物类型枚举.特殊BOSS) {
        GameLib.BroadcastCountDownMessage(`{s=【特殊BOSS】;c=247}${Monster.Name} 出现在 ${Envir.DisplayName} 坐标 ${Monster.GetMapX()} ${Monster.GetMapY()} 显示时间:<$Time:20$>…`)
    }

    // 存储怪物信息到全局（包含星级信息）
    const 怪物信息 = {
        怪物名字: Monster.GetSVar(97),
        怪物等级: String(Monster.Level),
        血量: 血量,
        攻击: 攻击,
        防御: 防御,
        怪物颜色: 最终颜色,
        怪物标志: Tag,
        生物类型: 生物类型,
        固定星级: 地图信息.固定星级,
        难度系数: 地图信息.难度系数,
        装备倍数: 装备倍数,
        怪物装备属性: 怪物装备属性,
        // 倍数信息
        词缀名称: 倍数信息.词缀名称,
        综合血量倍数: 倍数信息.综合血量倍数.toFixed(2),
        综合攻击倍数: 倍数信息.综合攻击倍数.toFixed(2),
        综合防御倍数: 倍数信息.综合防御倍数.toFixed(2),
    }
    GameLib.R.怪物信息 = GameLib.R.怪物信息 || {}
    GameLib.R.怪物信息[`${Monster.Handle}`] = JSON.stringify(怪物信息)
    Monster.SetSVar(98, JSON.stringify(怪物信息))

    // 显示血量
    血量显示(Monster)
}

// ==================== 辅助函数 ====================

/**
 * 获取随机小数
 * @param min 最小值
 * @param max 最大值
 * @returns 随机小数
 */
export function getRandomDecimal(min: number, max: number): number {
    if (min >= max) {
        return min
    }
    return min + (max - min) * Math.random()
}

# 攻击计算系统重构说明

## 新伤害计算公式

```
最终伤害 = (人物主属性 - 生物防御) × 技能加成 × (攻击技能魔次 - 生物魔次抵抗) × 2^基因等级 × 伤害加成 × 暴击倍率 × 地图修正
```

## 生物属性存储（SVar索引）

根据 `生物属性.ts` 的定义：
- `SVar(91)` = 当前血量
- `SVar(92)` = 最大血量
- `SVar(93)` = 攻击
- `SVar(94)` = 防御
- `SVar(95)` = 魔次抵抗
- `SVar(96)` = 防御大（备用）

**注意**：生物属性已经在刷新时计算好，不需要再计算随机值！

## 详细计算步骤

### 1. 获取人物主属性
- 根据玩家职业（Job 0-5）获取对应主属性
- 对应关系：`R.自定属性[161 + Job]`
  - Job 0 (战士) → 攻击 (161)
  - Job 1 (法师) → 魔法 (162)
  - Job 2 (道士) → 道术 (163)
  - Job 3 (刺客) → 刺术 (164)
  - Job 4 (弓箭) → 箭术 (165)
  - Job 5 (武僧) → 武术 (166)

### 2. 减去生物防御
- 获取敌人防御：`敌人.GetSVar(94)`（已计算好，无需随机）
- 应用无视防御（迅疾基因）：`无视量 = 防御 × 无视比例`
- 计算基础伤害：`人物主属性 - 生物防御`（最小为1）

### 3. 应用技能加成
- 技能加成倍率 = `基础加成 + 技能等级 × 等级加成`
- 例如：攻杀剑术（基础200%，每级+20%）
  - 1级：2.0 + 1 × 0.2 = 2.2倍
  - 10级：2.0 + 10 × 0.2 = 4.0倍

### 4. 应用魔次加成
- 获取技能魔次：从装备属性统计中累加
- 获取敌人魔次抵抗：`敌人.GetSVar(95)`（已计算好，无需随机）
- 有效魔次 = `攻击技能魔次 - 生物魔次抵抗`（最小为1）

### 5. 应用基因倍率
- 基因等级：`R.基因锁等级`
- 基因倍率 = `2^基因等级`
  - 基因等级1：2倍
  - 基因等级5：32倍
  - 基因等级10：1024倍
  - 基因等级20：1048576倍

### 6. 应用伤害加成
- 基因攻击伤害（迅疾）：`R.基因攻击伤害`（200%）
- 神器增伤加成：`R.神器增伤加成`
- 总加成倍率 = `1 + (基因攻击伤害 + 神器增伤) × 0.01`

### 7. 应用暴击
- 暴击几率：`AddedAbility.CriticalHit`（狂化基因+20%）
- 暴击伤害：`AddedAbility.CriticalHitAppendDamage`（狂化基因+500%）
- 暴击倍率 = `2 + 暴击伤害加成 × 0.01`
  - 基础暴击：2倍
  - 狂化基因：2 + 5 = 7倍

### 8. 应用地图修正
- 根据地图等级应用伤害修正系数
- 高等级地图有更低的修正系数

### 9. 应用职业被动
- 天枢：人之怒/地之怒/天之怒/神之怒（几率触发额外倍率）
- 血神：血气迸发（吸血）
- 暗影：暗影猎取（获取暗影点）、暗影附体（袭杀2倍）
- 烈焰：烈焰突袭（每5次攻击触发）
- 正义：行刑/洗礼（怪物类型加成）、审判（满血切割）、神罚（当前血量切割）
- 不动：泰山（主属性加成）

## 性能优化

### 减少函数调用
- 使用 `× 0.01` 代替 `÷ 100`
- 直接计算倍率，避免多次转换
- 缓存常用属性访问（V、R）
- **移除随机值计算**：生物属性已在刷新时计算好

### 快速路径
- 提前检查攻击合法性
- 快速返回无效情况
- 使用Map结构存储配置

### 大数值优化
- 使用智能计算函数处理超大数值
- 避免嵌套调用，减少计算次数
- 例如：`智能计算(值, '0.1', 3)` 代替 `智能计算(智能计算(值, '10', 3), '100', 4)`

## 基因系统

### 六种基因类型
1. **狂化**：暴击几率+20%，暴击伤害+500%
2. **迅疾**：无视防御20%，攻击伤害+200%
3. **甲壳**：防御+30%，血量+50%
4. **融合**：回收倍率+50%，血量+50%
5. **念力**：爆率+20%，主属性+10%
6. **协作**：极品率+10%，主属性+10%

### 基因等级作用
- 基因等级通过 `2^等级` 的方式指数级提升伤害
- 这是后期伤害提升的核心机制
- 配合技能魔次，可以达到极高的伤害倍率

## 示例计算

假设：
- 人物主属性：10000
- 生物防御：2000（从SVar(94)获取）
- 技能加成：4倍（10级攻杀剑术）
- 技能魔次：100
- 生物魔次抵抗：10（从SVar(95)获取）
- 基因等级：10
- 伤害加成：200%（迅疾）
- 暴击：7倍（狂化触发）

计算过程：
1. 基础伤害：10000 - 2000 = 8000
2. 技能加成：8000 × 4 = 32000
3. 魔次加成：32000 × (100 - 10) = 2880000
4. 基因倍率：2880000 × 2^10 = 2949120000
5. 伤害加成：2949120000 × 3 = 8847360000
6. 暴击：8847360000 × 7 = 61931520000

最终伤害：**619亿**

## 怪物对玩家伤害

计算公式：`怪物攻击 - 玩家防御`

- 怪物攻击：从 `怪物.GetSVar(93)` 获取
- 玩家防御：从 `玩家.R.自定属性[168]` 获取
- 应用玩家受伤被动技能（血气吸纳、铁布衫、人王盾等）

## 注意事项

1. 所有大数值计算必须使用字符串类型
2. 确保最小伤害为1，避免0或负数
3. 暴击、被动技能等随机触发需要合理控制几率
4. 地图修正系数随地图等级递减，平衡游戏难度
5. 基因等级是核心成长系统，需要谨慎设计获取方式
6. **生物属性已在刷新时计算好，战斗时直接读取SVar，不要重复计算随机值**

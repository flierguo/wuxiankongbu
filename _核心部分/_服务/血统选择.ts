/**
 * 血统系统
 * 
 * 功能：
 * - 血统选择（血族、狼人、修真、恶魔）
 * - 血统等级提升
 * - 血统重置
 * - 血统属性加成
 */

import { 装备属性统计 } from "../_装备/属性统计";

// ==================== 血统配置 ====================
interface 血统配置类型 {
    名称: string;
    图标: number;      // 图标ID
    血量加成: number;  // 百分比
    主属性加成: number; // 百分比
    防御加成: number;  // 百分比
    介绍: string;
}

const 血统配置: { [key: string]: 血统配置类型 } = {
    '血族': {
        名称: '血族',
        图标: 326,
        血量加成: 5,
        主属性加成: 3,
        防御加成: 2,
        介绍: '血量提高5%/2级,主属性提高3%/2级,防御提高2%/2级'
    },
    '狼人': {
        名称: '狼人',
        图标: 324,
        血量加成: 3,
        主属性加成: 5,
        防御加成: 2,
        介绍: '血量提高3%/2级,主属性提高5%/2级,防御提高2%/2级'
    },
    '修真': {
        名称: '修真',
        图标: 323,
        血量加成: 3,
        主属性加成: 3,
        防御加成: 4,
        介绍: '血量提高3%/2级,主属性提高3%/2级,防御提高4%/2级'
    },
    '恶魔': {
        名称: '恶魔',
        图标: 325,
        血量加成: 3,
        主属性加成: 4,
        防御加成: 3,
        介绍: '血量提高3%/2级,主属性提高4%/2级,防御提高3%/2级'
    }
};

// 血统列表
const 血统列表 = ['血族', '狼人', '修真', '恶魔'];

// ==================== 初始化 ====================
function 初始化血统变量(Player: TPlayObject): void {
    Player.V.血统 ??= '';
    Player.V.血统等级 ??= 0;
}

// ==================== 主界面 ====================
export function Main(Npc: TNormNpc, Player: TPlayObject): void {
    初始化血统变量(Player);

    const 当前血统 = Player.V.血统 || '';
    const 血统显示 = 当前血统 ? `${当前血统} ${Player.V.血统等级}级` : '未选择';

    // 计算当前属性加成
    let 属性加成文本 = '';
    if (当前血统 && Player.V.血统等级 > 0) {
        const 配置 = 血统配置[当前血统];
        const 血量加成 = 配置.血量加成 * (Player.V.血统等级 / 2);
        const 主属性加成 = 配置.主属性加成 * (Player.V.血统等级 / 2);
        const 防御加成 = 配置.防御加成 * (Player.V.血统等级 / 2);
        属性加成文本 = `当前血统加成:血量+ ${血量加成}% 主属性+ ${主属性加成}% 防御+ ${防御加成}%`;
    }

    // 构建血统列表
    let 血统列表文本 = '';
    const Y基准 = 100;
    let 索引 = 0;

    for (const 血统名 of 血统列表) {
        const 配置 = 血统配置[血统名];
        const Y位置 = Y基准 + 索引 * 40;
        const 已选择 = 当前血统 === 血统名;
        const 颜色 = 已选择 ? 249 : 251;
        const 状态文字 = 已选择 ? '[已选择]' : '[选择此项]';
        const 状态颜色 = 已选择 ? 249 : 250;

        血统列表文本 += `{i=${配置.图标};f=新UI素材文件.data;X=10;Y=${Y位置}}  {S=${配置.名称};X=60;Y=${Y位置};C=${颜色};FS=13}  {S=${配置.介绍};X=110;Y=${Y位置};H=5;W=200;C=253}  <{S=${状态文字};X=420;Y=${Y位置};C=${状态颜色}}/@血统选择.确认选择(${血统名})>\\\\`;
        索引++;
    }

    // 构建完整界面
    const S = `
                            {S=血统;AC=251,249,222,210;X=210;Y=10;H=30}
    {S=当前已选血统：${血统显示};C=249;X=10;Y=35}  {S=(只能选择一个);C=253;X=200;Y=35}
    {S=${属性加成文本};C=146;X=10;Y=60}
${血统列表文本}\\\\
    {S=血统介绍：;C=19;X=10;Y=270}{S=血统等级越高，属性加成越多;0X=10;Y=270;C=154;}
    {S=升级材料：;C=19;X=10;Y=290}{S=粹血源核，数量为100*等级的等差数列求和;0X=10;Y=290;C=154;}
    {S=举例：;C=19;X=10;Y=310}{S=1级升2级需要100个，2级升3级需要200个，3级升4级需要300个;0X=10;Y=310;C=154;}
\\\\
                                     <{S=升级血统;C=116;X=320;Y=360;HINT=提升血统等级}/@血统选择.提升等级>  <{S=重置血统;C=253;X=420;Y=360;HINT=重置血统，可重新选择}/@血统选择.确认重置>
    `;

    Npc.SayEx(Player, 'NPC中大窗口', S);
}

// ==================== 计算升级所需材料 ====================
/**
 * 计算升级到目标等级所需的材料总数
 * 等差数列求和：100 + 200 + 300 + ... + 100*等级
 * 公式：(首项 + 末项) * 项数 / 2 = (100 + 100*等级) * 等级 / 2
 */
function 计算升级材料(当前等级: number): number {
    const 目标等级 = 当前等级 + 1;
    // 从1级到目标等级的总材料数
    const 总材料 = (100 + 100 * 目标等级) * 目标等级 / 2;
    // 减去已经消耗的材料（从1级到当前等级）
    const 已消耗 = 当前等级 > 0 ? (100 + 100 * 当前等级) * 当前等级 / 2 : 0;
    return 总材料 - 已消耗;
}

// ==================== 确认选择血统 ====================
export function 确认选择(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    const 血统名 = Args.Str[0];

    // 检查是否已有血统
    if (Player.V.血统 && Player.V.血统 !== '') {
        Player.MessageBox('你已经拥有血统，请先重置');
        Main(Npc, Player);
        return;
    }

    // 检查血统是否存在
    if (!血统配置[血统名]) {
        Player.SendMessage('血统不存在', 1);
        Main(Npc, Player);
        return;
    }

    // 选择血统
    Player.V.血统 = 血统名;
    Player.V.血统等级 = 1;

    Player.MessageBox(`成功选择血统: ${血统名}\\血统等级: 1级`);

    // 重新计算属性
    装备属性统计(Player)

    Main(Npc, Player);
}

// ==================== 提升血统等级 ====================
export function 提升等级(Npc: TNormNpc, Player: TPlayObject): void {
    // 检查是否有血统
    if (!Player.V.血统 || Player.V.血统 === '') {
        Player.MessageBox('你还没有选择血统');
        Main(Npc, Player);
        return;
    }

    const 配置 = 血统配置[Player.V.血统];
    const 当前血量加成 = 配置.血量加成 * (Player.V.血统等级 / 2);
    const 当前主属性加成 = 配置.主属性加成 * (Player.V.血统等级 / 2);
    const 当前防御加成 = 配置.防御加成 * (Player.V.血统等级 / 2);

    const 下级血量加成 = 配置.血量加成 * (1 + (Player.V.血统等级) / 2);
    const 下级主属性加成 = 配置.主属性加成 * (1 + (Player.V.血统等级) / 2);
    const 下级防御加成 = 配置.防御加成 * (1 + (Player.V.血统等级) / 2);

    const 所需材料 = 计算升级材料(Player.V.血统等级);

    let str = `{S=提升血统等级;C=251;X=200;Y=10;H=30}\n`;
    str += `{S=━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━;C=249;X=10;Y=40}\n\n`;

    str += `{S=当前血统: ${Player.V.血统}  等级: ${Player.V.血统等级}级;C=116;X=30;Y=70}\n\n`;

    str += `{S=当前属性:;C=149;X=30;Y=110}\n`;
    str += `{S=血量:   +${当前血量加成}%;C=19;X=50;Y=135}\n`;
    str += `{S=主属性: +${当前主属性加成}%;C=19;X=50;Y=160}\n`;
    str += `{S=防御:   +${当前防御加成}%;C=19;X=50;Y=185}\n\n`;

    str += `{S=提升后属性:;C=149;X=250;Y=110}\n`;
    str += `{S=血量:   +${下级血量加成}%;C=116;X=250;Y=135}\n`;
    str += `{S=主属性: +${下级主属性加成}%;C=116;X=250;Y=160}\n`;
    str += `{S=防御:   +${下级防御加成}%;C=116;X=250;Y=185}\n\n`;

    str += `{S=━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━;C=249;X=10;Y=220}\n\n`;

    str += `{S=升级所需材料:;C=154;X=30;Y=250}\n`;
    str += `{S=粹血源核 x ${所需材料};C=19;X=30;Y=275}\n\n`;

    str += `<{S=[确认提升];C=116;X=200;Y=320}/@血统选择.执行提升>\n`;
    str += `<{S=[返回];C=9;X=320;Y=320}/@血统选择.Main>\n`;

    Npc.SayEx(Player, 'NPC中大窗口', str);
}

// ==================== 执行提升 ====================
export function 执行提升(Npc: TNormNpc, Player: TPlayObject): void {
    // 检查是否有血统
    if (!Player.V.血统 || Player.V.血统 === '') {
        Player.MessageBox('你还没有选择血统');
        Main(Npc, Player);
        return;
    }
    if (Player.V.血统等级 >= 1000) {
        Player.MessageBox('血统等级已达上限!');
        Main(Npc, Player);
        return;
    }
    // 计算所需材料
    const 所需材料 = 计算升级材料(Player.V.血统等级);

    // 检查材料是否足够
    const 拥有数量 = Player.GetItemCount('粹血源核');
    if (拥有数量 < 所需材料) {
        Player.MessageBox(`材料不足！需要粹血源核 ${所需材料}个，当前拥有 ${拥有数量}个`);
        提升等级(Npc, Player);
        return;
    }

    // 扣除材料
    Npc.Take(Player, '粹血源核', 所需材料)

    // 提升等级
    Player.V.血统等级 += 1;

    const 配置 = 血统配置[Player.V.血统];
    const 血量加成 = 配置.血量加成 * (Player.V.血统等级 / 2);
    const 主属性加成 = 配置.主属性加成 * (Player.V.血统等级 / 2);
    const 防御加成 = 配置.防御加成 * (Player.V.血统等级 / 2);

    Player.MessageBox(`血统等级提升至 ${Player.V.血统等级}级\\当前加成: 血量+${血量加成}% 主属性+${主属性加成}% 防御+${防御加成}%`);


    // 重新计算属性
    装备属性统计(Player)

    提升等级(Npc, Player);
}

// ==================== 确认重置 ====================
export function 确认重置(Npc: TNormNpc, Player: TPlayObject): void {
    if (!Player.V.血统 || Player.V.血统 === '') {
        Player.MessageBox('你还没有选择血统');
        Main(Npc, Player);
        return;
    }

    // 使用Question弹窗确认
    Player.Question(
        `警告：重置血统将清空你的血统等级(${Player.V.血统} ${Player.V.血统等级}级)和所有属性加成！\n\n确定要重置吗？`,
        '@血统选择.执行重置',
        '@血统选择.Main'
    );
}

// ==================== 执行重置 ====================
export function 执行重置(Npc: TNormNpc, Player: TPlayObject): void {
    if (!Player.V.血统 || Player.V.血统 === '') {
        Player.MessageBox('你还没有选择血统');
        Main(Npc, Player);
        return;
    }

    const 旧血统 = Player.V.血统;
    const 旧等级 = Player.V.血统等级;

    // 重置血统
    Player.V.血统 = '';
    Player.V.血统等级 = 0;

    Player.MessageBox(`已重置血统: ${旧血统}  ${旧等级}级\\你可以重新选择血统了`);
    // Player.SendMessage('你可以重新选择血统了', 1);

    // 重新计算属性
    装备属性统计(Player)

    Main(Npc, Player);
}

// ==================== 获取血统属性加成 ====================
/**
 * 获取玩家的血统属性加成
 * 返回: { 血量百分比, 主属性百分比, 防御百分比 }
 */
export function 获取血统加成(Player: TPlayObject): { 血量: number, 主属性: number, 防御: number } {
    初始化血统变量(Player);

    if (!Player.V.血统 || Player.V.血统 === '' || Player.V.血统等级 <= 0) {
        return { 血量: 0, 主属性: 0, 防御: 0 };
    }

    const 配置 = 血统配置[Player.V.血统];
    if (!配置) {
        return { 血量: 0, 主属性: 0, 防御: 0 };
    }

    return {
        血量: 配置.血量加成 * (Player.V.血统等级 / 2),
        主属性: 配置.主属性加成 * (Player.V.血统等级 / 2),
        防御: 配置.防御加成 * (Player.V.血统等级 / 2)
    };
}

// import { 数字转单位2, 数字转单位3 } from "../../大数值版本/大数值版本/字符计算";
import { 装备属性统计 } from "../_装备/属性统计";
// import { 特效 } from "../../_核心部分/基础常量";
import { 人物登录BUFF } from "../_玩家/登录触发";

// 新职业技能数据
const 职业数据 = {
    天枢: {
        技能: [
            { 图标: 120, 名称: '怒斩', 描述: '主动,对目标周围3码内所有敌人造成伤害200%,每级提高20%.' },
            { 图标: 122, 名称: '人之怒', 描述: '被动,攻击时20%几率使你造成得伤害额外提高400%,每级提高40%.' },
            { 图标: 130, 名称: '地之怒', 描述: '被动,攻击时10%几率使你造成得伤害额外提高600%,每级提高60%.' },
            { 图标: 126, 名称: '天之怒', 描述: '被动,攻击时5%几率使你造成得伤害额外提高800%,每级提高80%.' },
            { 图标: 172, 名称: '神之怒', 描述: '被动,攻击时1%几率使你造成得伤害额外提高1000%,每级提高100%.' },
        ]
    },
    血神: {
        技能: [
            { 图标: 822, 名称: '血气献祭', 描述: '主动,消耗1%的生命,对目标造成500%的伤害,每级提高50%(血量低于10%时不发动.)' },
            { 图标: 862, 名称: '血气燃烧', 描述: '开启后,每秒对周围5码范围内敌人造成150%的伤害,每级提高15%.(每秒消耗1%血量.血量低于10%时关闭)' },
            { 图标: 924, 名称: '血气吸纳', 描述: '被动,被攻击5%几率恢复3%血量,每50级几率提高1%,(最高到20).' },
            { 图标: 928, 名称: '血气迸发', 描述: '被动,攻击时可吸取造成伤害的1‰转化为生命,每级提高1‰,最高到2000‰.' },
            { 图标: 840, 名称: '血魔临身', 描述: '开启后,每秒回血1%,持续时间30S(每5级回复提高1%,持续时间增加1S,最高180S).冷却3分钟.' },
        ]
    },
    暗影: {
        技能: [
            { 图标: 890, 名称: '暗影猎取', 描述: '被动,攻击1%的几率获取暗影点,每点提高1%主属性,每5级提高1点上限.' },
            { 图标: 900, 名称: '暗影袭杀', 描述: '主动,对目标造成500%伤害,每级提高50%.' },
            { 图标: 910, 名称: '暗影剔骨', 描述: '开启后,对周围6码范围内敌人造成300%伤害,每级提高30%,每秒消耗1点暗影点.' },
            { 图标: 940, 名称: '暗影风暴', 描述: '主动,对目标范围5码内敌人造成400%伤害,消耗5点暗影点.每级提高40%.冷却20S.' },
            { 图标: 942, 名称: '暗影附体', 描述: '主动,消耗10点暗影点,使暗影袭杀的攻击提高至1000%,持续5S,每10级增加1S.冷却3分钟' },
        ]
    },
    烈焰: {
        技能: [
            { 图标: 308, 名称: '火焰追踪', 描述: '主动,对目标造成200%伤害,每级提高20%.' },
            { 图标: 302, 名称: '火镰狂舞', 描述: '被动,每10级可为火焰追踪的目标增加一个.' },
            { 图标: 644, 名称: '烈焰护甲', 描述: '开启后,每2秒对周围4格内的目标造成300%伤害,每级提高30%.' },
            { 图标: 660, 名称: '爆裂火冢', 描述: '被动,击中目标20%几率造成8格范围300%伤害,每级提高30%.' },
            { 图标: 662, 名称: '烈焰突袭', 描述: '被动,每攻击5次,使你下次伤害提升至200%,每重+20%.' },
        ]
    },
    正义: {
        技能: [
            { 图标: 640, 名称: '圣光', 描述: '开启后,每秒对周围5码内所有目标造成200%伤害,每级提高20%.' },
            { 图标: 678, 名称: '行刑', 描述: '被动,对普通怪物的伤害增加200%，每级提高20%.' },
            { 图标: 680, 名称: '洗礼', 描述: '被动,对精英以上怪物的伤害增加100%，每级提高10%.' },
            { 图标: 684, 名称: '审判', 描述: '被动,对满血目标造成10%血量切割，每20级+1%切割,封顶40%.' },
            { 图标: 668, 名称: '神罚', 描述: '被动,攻击10%几率使目标遭受神罚，损失当前生命的1%，每40级+1%.' },
        ]
    },
    不动: {
        技能: [
            { 图标: 914, 名称: '如山', 描述: '开启后,每秒对周围5码内造成400%伤害,每级提高40%.' },
            { 图标: 908, 名称: '泰山', 描述: '被动,主属性提高30%,每级增加3%.' },
            { 图标: 964, 名称: '人王盾', 描述: '主动,释放技能提供一个防御上限值1000%的护盾，每级提高100%，CD10秒' },
            { 图标: 978, 名称: '铁布衫', 描述: '被动,提供20%格挡，每10级提高1%（50上限）' },
            { 图标: 1010, 名称: '金刚掌', 描述: '主动,对目标周围8格范围造成500%伤害,并麻痹目标3秒，CD15秒,每级提高50%.' },
        ]
    },
}


// 本职业技能数据 (根据GetJob返回值 0-5 对应 战士 法师 道士 刺客 弓箭 武僧)
const 本职业数据: { [key: number]: { 名称: string, 技能: { 图标: number, 名称: string, 描述: string }[] } } = {
    0: { // 战士
        名称: '战士',
        技能: [
            { 图标: 2298, 名称: '攻杀剑术', 描述: '被动，几率触发攻杀造成200%伤害，每级提高20%.' },
            { 图标: 2312, 名称: '半月弯刀', 描述: '被动,对周围目标造成150%伤害,每级提高15%.' },
        ]
    },
    1: { // 法师
        名称: '法师',
        技能: [
            { 图标: 36, 名称: '雷电术', 描述: '主动,对目标造成200%伤害,每级提高20%.' },
            { 图标: 853, 名称: '暴风雪', 描述: '主动,对目标3格敌人造成100%伤害,15%几率冰冻1秒,每级提升10%.' },
        ]
    },
    2: { // 道士
        名称: '道士',
        技能: [
            { 图标: 1735, 名称: '灵魂火符', 描述: '主动,对目标造成200%伤害,每级提高20%.' },
            { 图标: 324, 名称: '飓风破', 描述: '主动,对目标3格敌人造成120%伤害,每级提升12%.' },
        ]
    },
    3: { // 刺客
        名称: '刺客',
        技能: [
            { 图标: 678, 名称: '暴击术', 描述: '被动,对目标造成150%伤害,并且使你的暴击几率提高10%,每级提高15%伤害,1%几率.' },
            { 图标: 169, 名称: '霜月', 描述: '被动,对周围目标造成150%伤害,每级提高15%.' },
        ]
    },
    4: { // 弓箭
        名称: '弓箭',
        技能: [
            { 图标: 150, 名称: '精准剑术', 描述: '被动:对目标造成200%伤害,每级提高20%.' },
            { 图标: 694, 名称: '万箭齐发', 描述: '主动,对目标3格敌人造成120%伤害,每级提升12%.' },
        ]
    },
    5: { // 武僧
        名称: '武僧',
        技能: [
            { 图标: 1000, 名称: '罗汉棍法', 描述: '开启后,对直线4格内敌人造成150%伤害,每级提升15%.' },
            { 图标: 1030, 名称: '天雷阵', 描述: '开启后,对3格内敌人造成120%伤害,每级提升12%.' },
        ]
    },
}

// 获取本职业技能名称列表
function 获取本职业技能列表(jobId: number): string[] {
    const 数据 = 本职业数据[jobId]
    if (!数据) return []
    return 数据.技能.map(t => t.名称)
}

// 获取新职业技能名称列表
function 获取新职业技能列表(职业名: string): string[] {
    const 数据 = 职业数据[职业名 as keyof typeof 职业数据]
    if (!数据) return []
    return 数据.技能.map(t => t.名称)
}

// 主界面 - 默认显示天枢职业技能
export function Main(Npc: TNormNpc, Player: TPlayObject, _Args: TArgs): void {
    显示职业技能内部(Npc, Player, '天枢')
}

// 显示职业技能
export function 显示职业技能(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    const 职业名 = Args.Str[0] as keyof typeof 职业数据
    显示职业技能内部(Npc, Player, 职业名)
}


// 内部显示职业技能函数
function 显示职业技能内部(Npc: TNormNpc, Player: TPlayObject, 职业名: keyof typeof 职业数据): void {
    const 数据 = 职业数据[职业名]
    if (!数据) { Player.MessageBox('职业数据不存在!'); return }

    const 技能列表 = 数据.技能
    let 技能显示 = ''
    const Y基准 = 120

    for (let i = 0; i < 技能列表.length; i++) {
        const 技能 = 技能列表[i]
        const Y位置 = Y基准 + i * 40
        技能显示 += `{i=${技能.图标};f=magicon2.wzl;X=10;Y=${Y位置}}  {S=${技能.名称};X=40;Y=${Y位置};C=215}  {S=${技能.描述};X=90;Y=${Y位置};H=5;W=100;C=253}\\\\`
    }

    // 职业名称使用FS=14放大字体
    const S = `
                              请选择你的职业\\\\\\
    <{S=天枢;C=${职业名 === '天枢' ? 249 : 251};FS=13}/@显示职业技能(天枢)>       <{S=血神;C=${职业名 === '血神' ? 249 : 251};FS=13}/@显示职业技能(血神)>       <{S=暗影;C=${职业名 === '暗影' ? 249 : 251};FS=13}/@显示职业技能(暗影)>       <{S=烈焰;C=${职业名 === '烈焰' ? 249 : 251};FS=13}/@显示职业技能(烈焰)>       <{S=正义;C=${职业名 === '正义' ? 249 : 251};FS=13}/@显示职业技能(正义)>       <{S=不动;C=${职业名 === '不动' ? 249 : 251};FS=13}/@显示职业技能(不动)>\\\\
${技能显示}\\\\
                                     <{S=选择${职业名};X=350;Y=350}/@选择职业(${职业名})>\\\\\\
             <{S=重置系统职业;C=250;X=80;Y=350;FS=13;HINT=重置战士,法师,道士这类}/@重置本职业>    <{S=重置新职业;C=191;X=210;Y=350;FS=13;HINT=需要2000元宝}/@重置新职业>
    `
    Npc.SayEx(Player, 'NPC大窗口', S);
}

// 选择职业
export function 选择职业(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    const 职业 = Args.Str[0]
    if (Player.V.职业 != '') { Player.MessageBox('你已经选择过职业了!'); return }

    Player.V.职业 = 职业
    Player.AddSkill('心灵召唤', 3);
    Player.AddSkill('查看属性', 3);
    Player.CancelToMonster()

    // 添加本职业技能
    const jobId = Player.Job
    const 本职业技能 = 获取本职业技能列表(jobId)
    for (const 技能名 of 本职业技能) {
        Player.AddSkill(技能名)
    }

    // 添加新职业技能
    const 新职业技能 = 获取新职业技能列表(职业)
    for (const 技能名 of 新职业技能) {
        Player.AddSkill(技能名)
    }

    人物登录BUFF(Player)
    装备属性统计(Player)
    显示职业技能内部(Npc, Player, 职业 as keyof typeof 职业数据)
}


// 重置本职业 - 显示职业选择界面
export function 重置本职业(Npc: TNormNpc, Player: TPlayObject, _Args: TArgs): void {
    const S = `\\\\
        {S=选择本职业转职;X=165;Y=10}
        {S=请选择要转职的本职业;C=249;X=50;y=40}
        {S=转职将清空所有职业技能及技能等级;C=253;x=50;y=65}
    <{S=战士;C=251;FS=13;X=50;Y=100}/@选择本职业转职(0)>       <{S=法师;C=251;FS=13;X=150;Y=100}/@选择本职业转职(1)>       <{S=道士;C=251;FS=13;X=250;Y=100}/@选择本职业转职(2)>\\\\\\
    <{S=刺客;C=251;FS=13;X=50;Y=140}/@选择本职业转职(3)>       <{S=弓箭手;C=251;FS=13;X=150;Y=140}/@选择本职业转职(4)>       <{S=武僧;C=251;FS=13;X=250;Y=140}/@选择本职业转职(5)>\\\\\\
    <{S=返回;X=350;Y=165}/@Main>
    `
    Npc.SayEx(Player, 'NPC扁窗口', S);
}

// 选择本职业转职 - 显示确认界面
export function 选择本职业转职(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    const jobId = Number(Args.Str[0])
    const 本职业 = 本职业数据[jobId]
    if (!本职业) { Player.MessageBox('无效的职业ID!'); return }

    const 职业名 = 本职业.名称
    const 当前JobId = Player.Job

    // 如果是当前职业，不需要转职
    if (jobId === 当前JobId) {
        Player.MessageBox('你当前已经是该职业，无需转职!')
        return
    }

    const S = `
        {S=确认重置新职业;X=165;Y=10}\\\\
        {S=转职目标：【${职业名}】;C=249;X=50;Y=40}\\\\
        {S=转职将清空所有职业技能及技能等级;C=253;X=50;Y=70}\\\\
        {S=是否确认重置？;C=250;X=50;Y=130}
    <{S=确认转职;C=250;X=250;Y=165;HINT=转职将清空所有职业技能及技能等级}/@确认转职本职业(${jobId})>\\\\\\
    <{S=取消;X=350;Y=165}/@重置本职业>
    `
    Npc.SayEx(Player, 'npc扁窗口', S);
}

// 确认转职本职业
export function 确认转职本职业(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    const jobId = Number(Args.Str[0])
    const 本职业 = 本职业数据[jobId]
    if (!本职业) { Player.MessageBox('无效的职业ID!'); return }

    const vAny = Player.V as any
    const rAny = Player.R as any

    // 先保存新职业信息（如果存在）
    const 当前新职业 = Player.V.职业

    // 清除所有技能
    Player.ClearSkill()

    // 重置所有本职业技能等级和魔次
    for (const [key] of Object.entries(本职业数据)) {
        const 技能列表 = 获取本职业技能列表(Number(key))
        for (const 技能名 of 技能列表) {
            vAny[`${技能名}等级`] = 1
            rAny[`${技能名}魔次`] = '0'
        }
    }

    // 重置新职业技能等级和魔次（如果已选择新职业）
    if (当前新职业) {
        const 新职业技能 = 获取新职业技能列表(当前新职业)
        for (const 技能名 of 新职业技能) {
            vAny[`${技能名}等级`] = 1
            rAny[`${技能名}魔次`] = '0'
        }
    }

    // 设置新的职业
    Player.Job = jobId

    // 添加新职业的基础技能
    Player.AddSkill('心灵召唤', 3);
    Player.AddSkill('查看属性', 3);

    // 添加新本职业技能
    const 新本职业技能 = 获取本职业技能列表(jobId)
    for (const 技能名 of 新本职业技能) {
        Player.AddSkill(技能名, 1)
    }

    // 如果有新职业，重新添加新职业技能
    if (当前新职业) {
        const 新职业技能 = 获取新职业技能列表(当前新职业)
        for (const 技能名 of 新职业技能) {
            Player.AddSkill(技能名, 1)
        }
    }

    Player.SendMessage(`转职成功！已转为【${本职业.名称}】,所有技能已重置为1级!`)

    人物登录BUFF(Player)
    装备属性统计(Player)
    显示职业技能内部(Npc, Player, 当前新职业 ? (当前新职业 as keyof typeof 职业数据) : '天枢')
}

// 重置新职业 - 显示确认界面
export function 重置新职业(Npc: TNormNpc, Player: TPlayObject, _Args: TArgs): void {
    if (Player.V.职业 == '') {
        Player.MessageBox('你还未选择新职业,无法重置!');
        return
    }

    if (Player.GetGameGold() < 2000) {
        Player.MessageBox('元宝不足2000,重置失败!');
        return
    }

    const S = `
                        {S=确认重置新职业;X=165;Y=10}\\\\
                        {S=当前职业：【${Player.V.职业}】;C=249;X=50;Y=40}\\
                    {S=重置将清空新职业技能及技能等级;C=253;X=50;Y=70}\\\\
                    {S=需要消耗2000元宝;C=250;X=50;Y=100}\\\\
                    {S=是否确认重置？;C=250;X=50;Y=130}\\\\\\
    <{S=确认重置;C=250;X=250;Y=165;HINT=重置将清空新职业技能及技能等级}/@确认重置新职业>\\\\\\
    <{S=取消;X=350;Y=165}/@Main>
    `
    Npc.SayEx(Player, 'npc扁窗口', S);
}

// 确认重置新职业
export function 确认重置新职业(Npc: TNormNpc, Player: TPlayObject, _Args: TArgs): void {
    if (Player.GetGameGold() < 2000) {
        Player.MessageBox('元宝不足2000,重置失败!');
        return
    }

    if (Player.V.职业 == '') {
        Player.MessageBox('你还未选择新职业,无法重置!');
        return
    }

    const vAny = Player.V as any
    const rAny = Player.R as any

    // 先保存旧职业信息（必须在清空前获取）
    const 旧职业 = Player.V.职业

    // 获取旧职业技能列表（必须在清空前获取）
    const 旧职业技能 = 获取新职业技能列表(旧职业)

    // 扣除元宝
    Player.SetGameGold(Player.GetGameGold() - 2000)
    Player.GoldChanged()

    // 清除新职业技能
    for (const 技能名 of 旧职业技能) {
        Player.DelSkill(技能名)
        vAny[`${技能名}等级`] = 1
        rAny[`${技能名}魔次`] = '0'
    }

    // 清空新职业
    Player.V.职业 = ''

    Player.SendMessage('新职业已重置,所有新职业技能已清空!')

    人物登录BUFF(Player)
    装备属性统计(Player)
    显示职业技能内部(Npc, Player, '天枢')
}


/**
 * 地图成就系统
 * 
 * 功能：
 * 1. 击杀 TAG 5/6/7 怪物有几率获得当前地图对应难度的成就值
 * 2. 成就值达到要求后可解锁下一难度
 * 3. 可兑换高级成就值（200个简单 → 1个普通）
 * 4. 进图时检查成就值是否达标
 * 
 * 存储方式：
 * - Player.V.地图成就_浣熊市_简单 = 当前成就值
 * - Player.V.地图成就_浣熊市_普通 = 当前成就值
 * ...以此类推
 */

import { 完整地图配置 } from '../世界配置'

// ==================== 配置 ====================

// 难度列表（与世界配置保持一致）
const 难度列表 = ['简单', '普通', '困难', '精英', '炼狱'] as const
type 难度类型 = typeof 难度列表[number]

// 掉落几率配置（击杀TAG 5/6/7怪物）
const 掉落几率配置: Record<难度类型, number> = {
    '简单': 5,   // 1/20
    '普通': 15,   // 1/25
    '困难': 20,   // 1/30
    '精英': 25,   // 1/35
    '炼狱': 40,   // 1/40
}

// 升级需求配置
export const 升级需求配置: Record<难度类型, number> = {
    '简单': 50,
    '普通': 200,
    '困难': 300,
    '精英': 400,
    '炼狱': 500,
}

// 兑换比例配置（200个低级 → 1个高级）
const 兑换比例 = 200

// ==================== 工具函数 ====================

/** 获取成就值变量名 */
function 获取成就值变量名(地图名: string, 难度: 难度类型): string {
    return `地图成就_${地图名}_${难度}`
}

/** 获取玩家指定地图难度的成就值 */
export function 获取成就值(Player: TPlayObject, 地图名: string, 难度: 难度类型): number {
    const 变量名 = 获取成就值变量名(地图名, 难度)
    return (Player.V[变量名] as number) || 0
}

/** 设置玩家指定地图难度的成就值 */
function 设置成就值(Player: TPlayObject, 地图名: string, 难度: 难度类型, 数值: number): void {
    const 变量名 = 获取成就值变量名(地图名, 难度)
    Player.V[变量名] = 数值
}

/** 增加玩家指定地图难度的成就值 */
function 增加成就值(Player: TPlayObject, 地图名: string, 难度: 难度类型, 数量: number): void {
    const 当前值 = 获取成就值(Player, 地图名, 难度)
    设置成就值(Player, 地图名, 难度, 当前值 + 数量)
}

/** 检查是否达到升级要求 */
export function 检查升级要求(Player: TPlayObject, 地图名: string, 难度: 难度类型): boolean {
    const 当前值 = 获取成就值(Player, 地图名, 难度)
    const 需求值 = 升级需求配置[难度]
    return 当前值 >= 需求值
}

/** 获取难度索引 */
function 获取难度索引(难度: 难度类型): number {
    return 难度列表.indexOf(难度)
}

/** 检查是否可以进入指定难度（需要前置难度达标） */
export function 检查进图权限(Player: TPlayObject, 地图名: string, 难度: 难度类型): boolean {
    // 简单难度无需前置
    if (难度 === '简单') return true
    
    // 其他难度需要前一难度达标
    const 当前索引 = 获取难度索引(难度)
    if (当前索引 <= 0) return true
    
    const 前置难度 = 难度列表[当前索引 - 1]
    return 检查升级要求(Player, 地图名, 前置难度)
}

/** 获取玩家当前最高成就等级（返回地图名和难度） */
function 获取当前最高成就(Player: TPlayObject): { 地图名: string; 难度: 难度类型 } | null {
    let 最高地图名 = ''
    let 最高难度: 难度类型 = '简单'
    let 最高难度索引 = -1
    
    // 遍历所有地图
    for (const 地图配置 of 完整地图配置) {
        const 地图名 = 地图配置.地图名
        if (地图名 === '新手地图') continue
        
        // 从高到低检查难度
        for (let i = 难度列表.length - 1; i >= 0; i--) {
            const 难度 = 难度列表[i]
            const 当前值 = 获取成就值(Player, 地图名, 难度)
            const 需求值 = 升级需求配置[难度]
            
            // 如果达标且难度更高
            if (当前值 >= 需求值 && i > 最高难度索引) {
                最高地图名 = 地图名
                最高难度 = 难度
                最高难度索引 = i
            }
        }
    }
    
    if (最高难度索引 === -1) return null
    return { 地图名: 最高地图名, 难度: 最高难度 }
}

/** 获取玩家可进入的下一个难度 */
function 获取下一个可进入难度(Player: TPlayObject): { 地图名: string; 难度: 难度类型 } | null {
    const 当前最高 = 获取当前最高成就(Player)
    
    // 如果没有任何成就，返回第一个地图的简单难度
    if (!当前最高) {
        const 第一个地图 = 完整地图配置.find(cfg => cfg.地图名 !== '新手地图')
        if (第一个地图) {
            return { 地图名: 第一个地图.地图名, 难度: '简单' }
        }
        return null
    }
    
    const { 地图名, 难度 } = 当前最高
    const 当前难度索引 = 获取难度索引(难度)
    
    // 如果当前难度不是最高难度，返回下一难度
    if (当前难度索引 < 难度列表.length - 1) {
        return { 地图名, 难度: 难度列表[当前难度索引 + 1] }
    }
    
    // 如果当前难度已是最高，返回下一个地图的简单难度
    const 所有地图 = 完整地图配置.filter(cfg => cfg.地图名 !== '新手地图')
    const 当前地图索引 = 所有地图.findIndex(cfg => cfg.地图名 === 地图名)
    
    if (当前地图索引 < 所有地图.length - 1) {
        return { 地图名: 所有地图[当前地图索引 + 1].地图名, 难度: '简单' }
    }
    
    // 已完成所有成就
    return null
}

// ==================== 杀怪触发 ====================

/**
 * 杀怪时调用，有几率获得成就值
 * @param Player 玩家
 * @param 地图名 当前地图名（不含难度后缀）
 * @param 难度 当前难度
 * @param 怪物TAG 怪物TAG（5/6/7才触发）
 */
export function 杀怪触发成就(Player: TPlayObject, 地图名: string, 难度: 难度类型, 怪物TAG: number): void {
    // 只有TAG 5/6/7才掉落
    if (怪物TAG !== 5 && 怪物TAG !== 6 && 怪物TAG !== 7) return
    
    // 检查几率
    const 几率 = 掉落几率配置[难度]
    if (random(几率) !== 0) return
    
    // 增加成就值
    增加成就值(Player, 地图名, 难度, 1)
    
    const 当前值 = 获取成就值(Player, 地图名, 难度)
    const 需求值 = 升级需求配置[难度]
    
    // 提示玩家
    if (当前值 >= 需求值) {
        Player.SendMessage(`{S=【地图成就】获得 ${地图名}-${难度} 成就值 +1 (${当前值}/${需求值}) 已达标！;C=251}`, 1)
    } else {
        Player.SendMessage(`{S=【地图成就】获得 ${地图名}-${难度} 成就值 +1 (${当前值}/${需求值});C=250}`, 1)
    }
}

// ==================== NPC界面 ====================

/** 主界面 - 显示当前成就概览 */
export function Main(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    let S = `\\\\
{S=地图成就系统;C=254;X=180;Y=5}

{S=━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━;C=154;X=10;Y=25}

{S=【系统说明】;C=251;X=20;Y=45}
{S=击杀称号BOSS有几率获得成就值;C=154;X=20;Y=65}
{S=成就值达标后可进入下一难度;C=154;X=20;Y=85}
{S=可兑换高级成就值(200低级→1高级);C=154;X=20;Y=105}

{S=━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━;C=154;X=10;Y=125}

{S=【当前成就】;C=251;X=20;Y=145}
`
    
    let Y = 165
    
    // 获取当前最高成就
    const 当前最高 = 获取当前最高成就(Player)
    if (当前最高) {
        S += `\n{S=当前成就: ${当前最高.地图名} ${当前最高.难度};C=250;X=20;Y=${Y}}`
        Y += 22
    } else {
        S += `\n{S=当前成就: 无;C=154;X=20;Y=${Y}}`
        Y += 22
    }
    
    // 获取可进入的下一个难度
    const 下一难度 = 获取下一个可进入难度(Player)
    if (下一难度) {
        S += `\n{S=可进入地图: ${下一难度.地图名} ${下一难度.难度};C=249;X=20;Y=${Y}}`
        Y += 22
    } else {
        S += `\n{S=可进入地图: 已完成全部成就;C=251;X=20;Y=${Y}}`
        Y += 22
    }
    
    S += `\n\n<{S=[查看详情];C=250;X=150;Y=${Y + 10}}/@地图成就.查看成就值(0)>`
    
    Npc.SayEx(Player, 'NPC小窗口', S)
}

/** 查看成就值界面（带分页和兑换功能） */
export function 查看成就值(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    const 当前页 = Args.Int[0] || 0
    
    // 获取所有地图（排除新手地图）
    const 所有地图 = 完整地图配置.filter(cfg => cfg.地图名 !== '新手地图')
    
    // 每页显示2个地图（每个地图5个难度，共10项）
    const 每页地图数 = 2
    const 总页数 = Math.ceil(所有地图.length / 每页地图数)
    const 开始索引 = 当前页 * 每页地图数
    const 结束索引 = Math.min(开始索引 + 每页地图数, 所有地图.length)
    const 当前页地图 = 所有地图.slice(开始索引, 结束索引)
    
    let S = `\\\\
{S=地图成就详情 (第${当前页 + 1}/${总页数}页);C=254;X=150;Y=-5}

{S=━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━;C=154;X=0;Y=15}
`
    
    let Y = 45
    
    // 遍历当前页的地图
    for (const 地图配置 of 当前页地图) {
        const 地图名 = 地图配置.地图名
        
        S += `\n{S=${地图名};C=251;X=20;Y=${Y}}`
        Y += 22
        
        // 显示各难度成就值和兑换按钮
        for (let i = 0; i < 难度列表.length; i++) {
            const 难度 = 难度列表[i]
            const 当前值 = 获取成就值(Player, 地图名, 难度)
            const 需求值 = 升级需求配置[难度]
            const 颜色 = 当前值 >= 需求值 ? 250 : 154
            
            S += `\n{S=${难度}: ${当前值}/${需求值};C=${颜色};X=40;Y=${Y}}`
            
            // 如果不是最后一个难度，显示兑换按钮
            if (i < 难度列表.length - 1) {
                const 可兑换数 = Math.floor(当前值 / 兑换比例)
                const 兑换颜色 = 可兑换数 > 0 ? 249 : 154
                S += `<{S=[兑换];C=${兑换颜色};X=350;Y=${Y}}/@地图成就.兑换成就值(${地图名},${i},${当前页})>`
            }
            
            Y += 20
        }
        
        Y += 15
    }
    
    // 翻页按钮
    Y = 320
    S += `{S=━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━;C=154;X=0;Y=${Y}}`
    Y += 20
    
    if (当前页 > 0) {
        S += `\n<{S=[上一页];C=250;X=100;Y=${Y}}/@地图成就.查看成就值(${当前页 - 1})>`
    }
    
    // S += `<{S=[返回];C=253;X=220;Y=${Y}}/@地图成就.Main>`
    
    if (当前页 < 总页数 - 1) {
        S += `<{S=[下一页];C=250;X=340;Y=${Y}}/@地图成就.查看成就值(${当前页 + 1})>`
    }
    
    Npc.SayEx(Player, 'NPC大窗口', S)
}

/** 兑换成就值 */
export function 兑换成就值(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    const 地图名 = Args.Str[0]
    const 难度索引 = Args.Int[1]
    const 返回页码 = Args.Int[2] || 0
    
    if (!地图名 || 难度索引 < 0 || 难度索引 >= 难度列表.length - 1) {
        Player.MessageBox('参数错误')
        return
    }
    
    const 源难度 = 难度列表[难度索引]
    const 目标难度 = 难度列表[难度索引 + 1]
    
    const 源数量 = 获取成就值(Player, 地图名, 源难度)
    const 可兑换数 = Math.floor(源数量 / 兑换比例)
    
    if (可兑换数 <= 0) {
        Player.MessageBox(`${源难度}成就值不足，需要${兑换比例}个`)
        return
    }
    
    // 扣除源成就值
    设置成就值(Player, 地图名, 源难度, 源数量 - 兑换比例)
    
    // 增加目标成就值
    增加成就值(Player, 地图名, 目标难度, 1)
    
    Player.MessageBox(`{S=兑换成功！${源难度} -${兑换比例} → ${目标难度} +1;C=251}`)
    
    // 刷新界面，返回原页码
    Args.Int[0] = 返回页码
    查看成就值(Npc, Player, Args)
}

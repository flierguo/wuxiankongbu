/**
 * 神器系统
 * 三栏布局：左侧套装列表(竖列) -> 中间组件列表(2列) -> 右侧详细信息
 * 布局参考图片样式，使用坐标定位
 */

// 套装数据结构
interface 神器套装数据 {
    套装名称: string;
    单件属性: string[];      // 每个组件的属性加成（相同）
    套装属性: string[];      // 全套激活效果
    来源: string;
    组件列表: string[];
}

// 套装配置数据
const 神器套装列表: 神器套装数据[] = [
    {
        套装名称: "蜂巢生存套",
        单件属性: ["全体技能魔次提高 200 "],
        套装属性: ["爆率提高 100%"],
        来源: "蜂巢深层探索掉落",
        组件列表: ["蜂巢门禁卡", "荧光战术灯", "多功能工兵铲", "便携氧气罐", "伤口应急喷", "声波探测器", "防水战术包"]
    },
    {
        套装名称: "丧尸近战套",
        单件属性: ["全体技能魔次提高 200 "],
        套装属性: ["回收倍率 提高 200% "],
        来源: "丧尸巢穴BOSS掉落",
        组件列表: ["锰钢斩尸刀", "高压电击棍", "战术护臂腿", "脚挂式飞斧", "负重格斗靴", "速干止血带", "战术钢指虎", "气味屏蔽剂"]
    },
    {
        套装名称: "舔食远程套",
        单件属性: ["全体技能魔次提高 1000 "],
        套装属性: ["狂化 丶 融合 等级 + 2"],
        来源: "舔食者狩猎任务奖励",
        组件列表: ["改装弩箭枪", "穿甲爆破箭", "红外瞄准镜", "震动感应雷", "神经烟雾弹", "便携弹药包"]
    },
    {
        套装名称: "病毒研究套",
        单件属性: ["全体技能魔次提高 1000 "],
        套装属性: ["迅疾 丶 念力 等级 + 2"],
        来源: "保护伞公司实验室",
        组件列表: ["病毒样本管", "便携测序仪", "抗体催化剂", "病毒检测仪", "轻型防护服", "数据存储盘", "PH调节原液"]
    },
    {
        套装名称: "应急逃生套",
        单件属性: ["全体技能魔次提高 1000 "],
        套装属性: ["甲壳 丶 协作 等级 + 2"],
        来源: "逃生挑战副本奖励",
        组件列表: ["破片手雷弹", "绳索钩爪枪", "烟雾掩护弹", "应急信号枪", "多功能工具钳", "高浓缩能量棒", "备用电池组", "团队通讯耳"]
    },
    {
        套装名称: "团队支援套",
        单件属性: ["全体技能魔次提高 2000 "],
        套装属性: ["解锁基因锁一级,对2大陆及以上的所有怪增伤 5000%"],
        来源: "团队副本通关奖励",
        组件列表: ["医疗急救箱", "蜂巢战术图", "生命监测仪", "临时强化针", "丧尸诱饵弹", "主神兑换券"]
    }
];

// 布局常量
const 左侧起始X = 30;
const 左侧起始Y = 60;
const 左侧行高 = 25;
const 左侧宽度 = 120;

const 中间起始X = 200;
const 中间起始Y = 100;
const 中间列宽 = 110;
const 中间行高 = 25;

const 右侧起始X = 200;
const 右侧起始Y = 300;
const 每行最大字符数 = 30; // 右侧区域每行最大字符数（中文算2个）

/**
 * 主入口 - 显示神器系统界面
 */
export function Main(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    显示主界面(Npc, Player, 0, -1);
}

/**
 * 显示主界面
 * @param 选中套装索引 当前选中的套装索引
 * @param 选中组件索引 当前选中的组件索引，-1表示未选中
 */
function 显示主界面(Npc: TNormNpc, Player: TPlayObject, 选中套装索引: number, 选中组件索引: number): void {
    let S = '';
    
    // 标题
    // S += `{S=神器系统;C=253;X=280;Y=15;FS=14}`;
    
    // ========== 左侧：套装列表 ==========
    // S += `{S=套装名称;C=249;FS=13;X=${左侧起始X};Y=${左侧起始Y - 20}}`;
    
    for (let i = 0; i < 神器套装列表.length; i++) {
        const 套装 = 神器套装列表[i];
        const Y坐标 = 左侧起始Y + i * 左侧行高;
        const 颜色 = i === 选中套装索引 ? 249 : 251;
        const 前缀 = i === 选中套装索引 ? '▶' : '　';
        S += `<&{S=${前缀}「${套装.套装名称}」;C=${颜色};X=${左侧起始X};Y=${Y坐标+5};H=${左侧行高}}{M=295,295,295;F=新UI素材文件.data;X=25;Y=${Y坐标}}/@选择套装(${i})>`;
    }
    
    // ========== 中间：组件列表 ==========
    const 当前套装 = 神器套装列表[选中套装索引];
    S += `{S=${当前套装.套装名称}组件:;C=249;X=${中间起始X};Y=${中间起始Y - 40};FS=13}`;
    
    for (let i = 0; i < 当前套装.组件列表.length; i++) {
        const 组件名称 = 当前套装.组件列表[i];
        const 炼化次数 = Player.V[组件名称] || 0;
        const 已获得 = 炼化次数 > 0;
        
        // 计算位置：每行2个
        const 行号 = Math.floor(i / 3);
        const 列号 = i % 3;
        const X坐标 = 中间起始X + 列号 * 中间列宽;
        const Y坐标 = 中间起始Y + 行号 * 中间行高;
        
        // 颜色：选中=金色，已获得=绿色，未获得=灰色
        let 颜色: number;
        if (i === 选中组件索引) {
            颜色 = 249; // 金色-选中
        } else if (已获得) {
            颜色 = 250; // 绿色-已获得
        } else {
            颜色 = 251; // 白色-未获得
        }
        
        const 状态标记 = 已获得 ? '✓' : '✗';
        S += `<&{S=${状态标记}${组件名称};C=${颜色};X=${X坐标};Y=${Y坐标};H=${中间行高}}/@选择组件(${选中套装索引},${i})>`;
    }
    
    // ========== 右侧：详细信息 ==========
    let 右侧Y = 右侧起始Y;
    
    // 属性加成标题
    S += `{S=属性加成:;C=249;X=${右侧起始X};Y=${右侧Y - 20}}`;
    
    // 单件属性
    for (const 属性 of 当前套装.单件属性) {
        S += `{S=${属性};C=250;X=${右侧起始X};Y=${右侧Y}}`;
        右侧Y += 20;
    }
    
    右侧Y += 15;
    
    // 全套激活效果标题
    S += `{S=全套激活效果:;C=249;X=${右侧起始X};Y=${右侧Y}}`;
    右侧Y += 25;
    
    // 套装属性
    for (const 属性 of 当前套装.套装属性) {
        const 换行文本 = 自动换行(属性);
        for (const 行 of 换行文本) {
            S += `{S=${行};C=191;X=${右侧起始X};Y=${右侧Y}}`;
            右侧Y += 20;
        }
    }
    
    右侧Y += 15;
    
    // 获取信息
    S += `{S=获取:;C=252;X=${右侧起始X};Y=${右侧Y}}{S=${当前套装.来源};C=251;X=${右侧起始X + 40};Y=${右侧Y}}`;
    右侧Y += 25;
    
    // 如果选中了组件，显示该组件的状态
    if (选中组件索引 >= 0 && 选中组件索引 < 当前套装.组件列表.length) {
        const 组件名称 = 当前套装.组件列表[选中组件索引];
        const 炼化次数 = Player.V[组件名称] || 0;
        const 获得状态 = 炼化次数 > 0 ? '已获得' : '未获得';
        const 状态颜色 = 炼化次数 > 0 ? 250 : 251;
        
        S += `{S=状态:;C=146;X=${右侧起始X};Y=${右侧Y}}{S=${获得状态};C=${状态颜色};X=${右侧起始X + 40};Y=${右侧Y}}`;
        // 右侧Y += 25;
        // 右侧起始X += 200;
        S += `{S=已炼化:;C=146;X=${右侧起始X + 115};Y=${右侧Y}}{S=${炼化次数}次;C=249;X=${右侧起始X + 160};Y=${右侧Y}}`;
    }
    
    Npc.SayEx(Player, '神器界面大', S);
}

/**
 * 选择套装
 */
export function 选择套装(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    const 套装索引 = Args.Int[0];
    if (套装索引 >= 0 && 套装索引 < 神器套装列表.length) {
        显示主界面(Npc, Player, 套装索引, -1);
    }
}

/**
 * 选择组件
 */
export function 选择组件(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    const 套装索引 = Args.Int[0];
    const 组件索引 = Args.Int[1];
    
    if (套装索引 >= 0 && 套装索引 < 神器套装列表.length) {
        const 套装 = 神器套装列表[套装索引];
        if (组件索引 >= 0 && 组件索引 < 套装.组件列表.length) {
            显示主界面(Npc, Player, 套装索引, 组件索引);
        }
    }
}

/**
 * 获取玩家已收集的组件数量
 */
export function 获取收集进度(Player: TPlayObject, 套装索引: number): { 已收集: number; 总数: number } {
    if (套装索引 < 0 || 套装索引 >= 神器套装列表.length) {
        return { 已收集: 0, 总数: 0 };
    }
    
    const 套装 = 神器套装列表[套装索引];
    let 已收集 = 0;
    
    for (const 组件名称 of 套装.组件列表) {
        const 炼化次数 = Player.V[组件名称] || 0;
        if (炼化次数 > 0) {
            已收集++;
        }
    }
    
    return { 已收集, 总数: 套装.组件列表.length };
}


/**
 * 自动换行处理
 * @param 文本 原始文本
 * @param 最大宽度 每行最大字符数（中文算2个字符）
 * @returns 换行后的文本数组
 */
function 自动换行(文本: string, 最大宽度: number = 每行最大字符数): string[] {
    const 结果: string[] = [];
    let 当前行 = '';
    let 当前宽度 = 0;
    
    for (let i = 0; i < 文本.length; i++) {
        const 字符 = 文本[i];
        // 中文字符宽度为2，其他为1
        const 字符宽度 = 字符.charCodeAt(0) > 127 ? 2 : 1;
        
        if (当前宽度 + 字符宽度 > 最大宽度) {
            结果.push(当前行);
            当前行 = 字符;
            当前宽度 = 字符宽度;
        } else {
            当前行 += 字符;
            当前宽度 += 字符宽度;
        }
    }
    
    if (当前行.length > 0) {
        结果.push(当前行);
    }
    
    return 结果;
}


/**
 * 检查套装是否激活
 */
export function 检查套装激活(Player: TPlayObject, 套装索引: number): boolean {
    const 进度 = 获取收集进度(Player, 套装索引);
    return 进度.已收集 >= 进度.总数;
}

/**
 * 增加组件炼化次数
 */
export function 增加炼化次数(Player: TPlayObject, 组件名称: string, 次数: number = 1): void {
    const 当前次数 = Player.V[组件名称] || 0;
    Player.V[组件名称] = 当前次数 + 次数;
}

/**
 * 获取所有套装列表（供外部调用）
 */
export function 获取套装列表(): 神器套装数据[] {
    return 神器套装列表;
}

/**
 * 根据名称获取套装索引
 */
export function 获取套装索引(套装名称: string): number {
    return 神器套装列表.findIndex(套装 => 套装.套装名称 === 套装名称);
}

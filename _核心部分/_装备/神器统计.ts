/**
 * 神器统计模块
 * 
 * 功能：
 * - 神器组件使用与属性加成
 * - 套装激活检测与效果应用
 * - 第一次使用全额属性，后续减半
 * - 每个组件最多使用10次
 */

import { 智能计算 } from "../../大数值/核心计算方法";

// ==================== 套装数据结构 ====================
interface 神器套装数据 {
    套装名称: string;
    单件属性值: number;      // 全体魔次加成数值
    套装属性类型: '爆率' | '回收' | '阶数' | '基因锁';
    套装属性值: number | string;
    套装阶数目标?: string[]; // 阶数类型时的目标属性
    组件列表: string[];
}

// 套装配置（与神器系统保持一致）
const 神器套装配置: 神器套装数据[] = [
    {
        套装名称: "蜂巢生存套",
        单件属性值: 200,
        套装属性类型: '爆率',
        套装属性值: 100,
        组件列表: ["蜂巢门禁卡", "荧光战术灯", "多功能工兵铲", "便携氧气罐", "伤口应急喷", "声波探测器", "防水战术包"]
    },
    {
        套装名称: "丧尸近战套",
        单件属性值: 200,
        套装属性类型: '回收',
        套装属性值: 200,
        组件列表: ["锰钢斩尸刀", "高压电击棍", "战术护臂腿", "脚挂式飞斧", "负重格斗靴", "速干止血带", "战术钢指虎", "气味屏蔽剂"]
    },
    {
        套装名称: "舔食远程套",
        单件属性值: 1000,
        套装属性类型: '阶数',
        套装属性值: 2,
        套装阶数目标: ['狂化阶数', '融合阶数'],
        组件列表: ["改装弩箭枪", "穿甲爆破箭", "红外瞄准镜", "震动感应雷", "神经烟雾弹", "便携弹药包"]
    },
    {
        套装名称: "病毒研究套",
        单件属性值: 1000,
        套装属性类型: '阶数',
        套装属性值: 2,
        套装阶数目标: ['迅疾阶数', '念力阶数'],
        组件列表: ["病毒样本管", "便携测序仪", "抗体催化剂", "病毒检测仪", "轻型防护服", "数据存储盘", "PH调节原液"]
    },
    {
        套装名称: "应急逃生套",
        单件属性值: 1000,
        套装属性类型: '阶数',
        套装属性值: 2,
        套装阶数目标: ['甲壳阶数', '协作阶数'],
        组件列表: ["破片手雷弹", "绳索钩爪枪", "烟雾掩护弹", "应急信号枪", "多功能工具钳", "高浓缩能量棒", "备用电池组", "团队通讯耳"]
    },
    {
        套装名称: "团队支援套",
        单件属性值: 2000,
        套装属性类型: '基因锁',
        套装属性值: '5000',
        组件列表: ["医疗急救箱", "蜂巢战术图", "生命监测仪", "临时强化针", "丧尸诱饵弹", "主神兑换券"]
    }
];

// 组件名称到套装的映射（预计算，避免重复查找）
const 组件套装映射 = new Map<string, 神器套装数据>();
for (const 套装 of 神器套装配置) {
    for (const 组件 of 套装.组件列表) {
        组件套装映射.set(组件, 套装);
    }
}

// ==================== 核心统计函数 ====================

/**
 * 神器属性统计 - 在装备属性统计时调用
 * 统计所有神器组件的属性加成
 */
export function 神器属性统计(Player: TPlayObject): void {
    // 初始化神器相关R变量（已在清空变量中初始化，这里确保存在）
    Player.R.全体魔次 ??= '0';
    Player.R.狂化阶数 ??= 0;
    Player.R.融合阶数 ??= 0;
    Player.R.迅疾阶数 ??= 0;
    Player.R.念力阶数 ??= 0;
    Player.R.甲壳阶数 ??= 0;
    Player.R.协作阶数 ??= 0;
    Player.R.神器爆率加成 ??= 0;
    Player.R.神器回收加成 ??= 0;
    Player.R.神器增伤加成 ??= '0';
    Player.R.基因锁等级 ??= 0;

    // 遍历所有套装统计属性
    for (const 套装 of 神器套装配置) {
        统计套装属性(Player, 套装);
    }
    
    // 将全体魔次加成应用到所有技能魔次
    const 全体魔次 = Player.R.全体魔次;
    if (全体魔次 && 全体魔次 !== '0') {
        应用全体魔次加成(Player, 全体魔次);
    }
}

/**
 * 将全体魔次加成应用到所有技能
 */
function 应用全体魔次加成(Player: TPlayObject, 魔次值: string): void {
    // 基础技能
    Player.R.攻杀剑术魔次 = 智能计算(Player.R.攻杀剑术魔次 || '0', 魔次值, 1);
    Player.R.半月弯刀魔次 = 智能计算(Player.R.半月弯刀魔次 || '0', 魔次值, 1);
    Player.R.雷电术魔次 = 智能计算(Player.R.雷电术魔次 || '0', 魔次值, 1);
    Player.R.暴风雪魔次 = 智能计算(Player.R.暴风雪魔次 || '0', 魔次值, 1);
    Player.R.灵魂火符魔次 = 智能计算(Player.R.灵魂火符魔次 || '0', 魔次值, 1);
    Player.R.飓风破魔次 = 智能计算(Player.R.飓风破魔次 || '0', 魔次值, 1);
    Player.R.暴击术魔次 = 智能计算(Player.R.暴击术魔次 || '0', 魔次值, 1);
    Player.R.霜月魔次 = 智能计算(Player.R.霜月魔次 || '0', 魔次值, 1);
    Player.R.精准箭术魔次 = 智能计算(Player.R.精准箭术魔次 || '0', 魔次值, 1);
    Player.R.万箭齐发魔次 = 智能计算(Player.R.万箭齐发魔次 || '0', 魔次值, 1);
    Player.R.罗汉棍法魔次 = 智能计算(Player.R.罗汉棍法魔次 || '0', 魔次值, 1);
    Player.R.天雷阵魔次 = 智能计算(Player.R.天雷阵魔次 || '0', 魔次值, 1);
    // 天枢技能
    Player.R.怒斩魔次 = 智能计算(Player.R.怒斩魔次 || '0', 魔次值, 1);
    Player.R.人之怒魔次 = 智能计算(Player.R.人之怒魔次 || '0', 魔次值, 1);
    Player.R.地之怒魔次 = 智能计算(Player.R.地之怒魔次 || '0', 魔次值, 1);
    Player.R.天之怒魔次 = 智能计算(Player.R.天之怒魔次 || '0', 魔次值, 1);
    Player.R.神之怒魔次 = 智能计算(Player.R.神之怒魔次 || '0', 魔次值, 1);
    // 血神技能
    Player.R.血气献祭魔次 = 智能计算(Player.R.血气献祭魔次 || '0', 魔次值, 1);
    Player.R.血气燃烧魔次 = 智能计算(Player.R.血气燃烧魔次 || '0', 魔次值, 1);
    // 暗影技能
    Player.R.暗影袭杀魔次 = 智能计算(Player.R.暗影袭杀魔次 || '0', 魔次值, 1);
    Player.R.暗影剔骨魔次 = 智能计算(Player.R.暗影剔骨魔次 || '0', 魔次值, 1);
    Player.R.暗影风暴魔次 = 智能计算(Player.R.暗影风暴魔次 || '0', 魔次值, 1);
    Player.R.暗影附体魔次 = 智能计算(Player.R.暗影附体魔次 || '0', 魔次值, 1);
    // 烈焰技能
    Player.R.火焰追踪魔次 = 智能计算(Player.R.火焰追踪魔次 || '0', 魔次值, 1);
    Player.R.烈焰护甲魔次 = 智能计算(Player.R.烈焰护甲魔次 || '0', 魔次值, 1);
    Player.R.爆裂火冢魔次 = 智能计算(Player.R.爆裂火冢魔次 || '0', 魔次值, 1);
    Player.R.烈焰突袭魔次 = 智能计算(Player.R.烈焰突袭魔次 || '0', 魔次值, 1);
    // 正义技能
    Player.R.圣光魔次 = 智能计算(Player.R.圣光魔次 || '0', 魔次值, 1);
    Player.R.行刑魔次 = 智能计算(Player.R.行刑魔次 || '0', 魔次值, 1);
    Player.R.洗礼魔次 = 智能计算(Player.R.洗礼魔次 || '0', 魔次值, 1);
    // 不动技能
    Player.R.如山魔次 = 智能计算(Player.R.如山魔次 || '0', 魔次值, 1);
    Player.R.金刚掌魔次 = 智能计算(Player.R.金刚掌魔次 || '0', 魔次值, 1);
}

/**
 * 统计单个套装的属性加成
 */
function 统计套装属性(Player: TPlayObject, 套装: 神器套装数据): void {
    let 已激活组件数 = 0;
    
    // 统计每个组件的属性加成
    for (const 组件名称 of 套装.组件列表) {
        const 使用次数 = Player.V[组件名称] || 0;
        if (使用次数 <= 0) continue;
        
        已激活组件数++;
        
        // 计算该组件的全体魔次加成
        // 第一次：全额，第2-10次：减半
        const 有效次数 = Math.min(使用次数, 10);
        const 首次加成 = 套装.单件属性值;
        const 后续加成 = Math.floor(套装.单件属性值 / 2);
        const 后续次数 = 有效次数 - 1;
        
        const 总加成 = 首次加成 + 后续加成 * 后续次数;
        Player.R.全体魔次 = 智能计算(Player.R.全体魔次, String(总加成), 1);
    }
    
    // 检查套装是否完整激活（所有组件至少使用1次）
    const 套装激活标记 = `${套装.套装名称}_已激活`;
    if (已激活组件数 >= 套装.组件列表.length && !Player.V[套装激活标记]) {
        // 首次激活套装效果
        应用套装效果(Player, 套装);
        Player.V[套装激活标记] = 1;
    } else if (Player.V[套装激活标记]) {
        // 已激活过，重新应用效果（用于属性刷新）
        应用套装效果(Player, 套装);
    }
}

/**
 * 应用套装激活效果
 */
function 应用套装效果(Player: TPlayObject, 套装: 神器套装数据): void {
    switch (套装.套装属性类型) {
        case '爆率':
            Player.R.神器爆率加成 += Number(套装.套装属性值);
            break;
        case '回收':
            Player.R.神器回收加成 += Number(套装.套装属性值);
            break;
        case '阶数':
            if (套装.套装阶数目标) {
                for (const 目标 of 套装.套装阶数目标) {
                    Player.R[目标] = (Player.R[目标] || 0) + Number(套装.套装属性值);
                }
            }
            break;
        case '基因锁':
            // 解锁基因锁一级
            if (Player.R.基因锁等级 < 1) {
                Player.R.基因锁等级 = 1;
            }
            // 对2大陆及以上怪物增伤5000%
            Player.R.神器增伤加成 = 智能计算(
                Player.R.神器增伤加成, 
                String(套装.套装属性值), 
                1
            );
            break;
    }
}

// ==================== 组件使用接口 ====================

/**
 * 使用神器组件
 * @returns 是否使用成功
 */
export function 使用神器组件(Player: TPlayObject, 组件名称: string): boolean {
    const 套装 = 组件套装映射.get(组件名称);
    if (!套装) {
        Player.SendMessage(`未知的神器组件: ${组件名称}`, 1);
        return false;
    }
    
    const 当前次数 = Player.V[组件名称] || 0;
    if (当前次数 >= 10) {
        Player.SendMessage(`${组件名称} 已达到最大炼化次数(10次)`, 1);
        return false;
    }
    
    // 增加使用次数
    Player.V[组件名称] = 当前次数 + 1;
    
    // 计算本次获得的属性
    const 是首次 = 当前次数 === 0;
    const 本次加成 = 是首次 ? 套装.单件属性值 : Math.floor(套装.单件属性值 / 2);
    
    Player.SendMessage(`成功炼化 ${组件名称}，全体魔次 +${本次加成}`, 1);
    
    // 检查是否激活套装
    检查套装激活(Player, 套装);
    
    return true;
}

/**
 * 检查并激活套装效果
 */
function 检查套装激活(Player: TPlayObject, 套装: 神器套装数据): void {
    const 套装激活标记 = `${套装.套装名称}_已激活`;
    if (Player.V[套装激活标记]) return; // 已激活
    
    // 检查所有组件是否都至少使用1次
    for (const 组件名称 of 套装.组件列表) {
        if ((Player.V[组件名称] || 0) <= 0) return;
    }
    
    // 激活套装
    Player.V[套装激活标记] = 1;
    Player.SendMessage(`恭喜！${套装.套装名称} 已激活！`, 1);
    
    // 显示套装效果
    switch (套装.套装属性类型) {
        case '爆率':
            Player.SendMessage(`套装效果：爆率提高 ${套装.套装属性值}%`, 1);
            break;
        case '回收':
            Player.SendMessage(`套装效果：回收倍率提高 ${套装.套装属性值}%`, 1);
            break;
        case '阶数':
            Player.SendMessage(`套装效果：${套装.套装阶数目标?.join('、')} 等级 +${套装.套装属性值}`, 1);
            break;
        case '基因锁':
            Player.SendMessage(`套装效果：解锁基因锁一级，对2大陆及以上怪物增伤 ${套装.套装属性值}%`, 1);
            break;
    }
}

// ==================== 查询接口 ====================

/**
 * 获取组件使用次数
 */
export function 获取组件使用次数(Player: TPlayObject, 组件名称: string): number {
    return Player.V[组件名称] || 0;
}

/**
 * 获取套装激活状态
 */
export function 获取套装激活状态(Player: TPlayObject, 套装名称: string): boolean {
    return !!Player.V[`${套装名称}_已激活`];
}

/**
 * 获取套装收集进度
 */
export function 获取套装进度(Player: TPlayObject, 套装名称: string): { 已收集: number; 总数: number } {
    const 套装 = 神器套装配置.find(s => s.套装名称 === 套装名称);
    if (!套装) return { 已收集: 0, 总数: 0 };
    
    let 已收集 = 0;
    for (const 组件名称 of 套装.组件列表) {
        if ((Player.V[组件名称] || 0) > 0) 已收集++;
    }
    
    return { 已收集, 总数: 套装.组件列表.length };
}

/**
 * 获取玩家全体魔次总加成
 */
export function 获取全体魔次加成(Player: TPlayObject): string {
    return Player.R.全体魔次 || '0';
}

/**
 * 获取所有套装配置（供外部调用）
 */
export function 获取神器套装配置(): 神器套装数据[] {
    return 神器套装配置;
}

/**
 * 进阶系统 - 数值平衡配置
 * 
 * 核心设计目标：
 * - 玩家在当前地图TAG7获得约25件装备后
 * - 穿上这些装备能快速击杀下一地图TAG1的怪物
 * 
 * 伤害公式: (主属性 - 生物防御) * (技能魔次 - 生物魔次抵抗)
 * 
 * 数值平衡原则：
 * - TAG7装备主属性 ≈ 下一地图TAG1生物防御 × 1.5~2倍
 * - 这样伤害 = (1.5~2倍防御 - 防御) × 魔次 = 0.5~1倍防御 × 魔次
 * - 确保能造成有效伤害，快速击杀
 */

import { 地图配置 } from './世界配置'

// ==================== TAG顺序配置 ====================

/** TAG难度顺序（6是大陆BOSS放最后） */
export const TAG顺序 = [1, 2, 3, 4, 5, 7, 6] as const

// ==================== 装备属性倍数配置 ====================
/**
 * TAG装备属性倍数
 * 设计原则：TAG7装备 能让玩家快速击杀下一地图TAG1
 * 
 * 计算示例（地图1 TAG7 → 地图2 TAG1）：
 * - 地图1 TAG7装备主属性 = 地图等级 × TAG倍数(12) × 随机
 * - 地图2 TAG1生物防御 = 地图等级 × TAG倍数(1) × 地图递增
 * - 需要：装备属性 > 生物防御 × 1.5
 */
export const TAG装备倍数: Record<number, number> = {
    1: 1,       // 基础
    2: 1.5,     // 1.5倍
    3: 2.5,     // 2.5倍
    4: 4,       // 4倍
    5: 7,       // 7倍
    7: 12,      // 12倍（特殊BOSS，关键进阶点）
    6: 20,      // 20倍（大陆BOSS最强）
}

// ==================== 生物属性倍数配置 ====================
/**
 * TAG生物属性倍数
 * 设计原则：下一地图TAG1 ≈ 当前地图TAG7 × 0.6~0.8
 * 
 * 这样穿上TAG7装备后：
 * - 主属性 > 下一地图TAG1防御
 * - 能造成有效伤害
 */
export const TAG生物倍数: Record<number, number> = {
    1: 1,       // 基础
    2: 1.8,     // 1.8倍
    3: 3,       // 3倍
    4: 5,       // 5倍
    5: 8,       // 8倍
    7: 15,      // 15倍（特殊BOSS）
    6: 30,      // 30倍（大陆BOSS最强）
}

// ==================== 地图递增配置 ====================
/**
 * 地图间难度递增倍数
 * 每个地图的基础难度相对于上一个地图的倍数
 * 
 * 设计：地图2的TAG1 ≈ 地图1的TAG7 × 地图递增倍数
 * 设置为0.7意味着下一地图TAG1比当前地图TAG7弱30%
 */
export const 地图递增倍数 = 0.7

// ==================== 工具函数 ====================

/** 获取TAG在顺序中的索引 */
export function 获取TAG索引(tag: number): number {
    return TAG顺序.indexOf(tag as typeof TAG顺序[number])
}

/** 获取地图索引 */
export function 获取地图索引(地图名: string): number {
    return 地图配置.findIndex(m => m.地图名 === 地图名)
}

/**
 * 计算装备属性倍数（基于地图和TAG）
 * @param 地图索引 地图在配置中的索引
 * @param 怪物TAG 怪物TAG
 */
export function 计算装备属性倍数(地图索引: number, 怪物TAG: number): number {
    const TAG倍数 = TAG装备倍数[怪物TAG] || 1
    // 地图基础倍数：每个地图递增
    const 地图基础 = Math.pow(1 / 地图递增倍数, 地图索引)
    return TAG倍数 * 地图基础
}

/**
 * 计算生物属性倍数（基于地图和TAG）
 * @param 地图索引 地图在配置中的索引
 * @param 怪物TAG 怪物TAG
 */
export function 计算生物属性倍数(地图索引: number, 怪物TAG: number): number {
    const TAG倍数 = TAG生物倍数[怪物TAG] || 1
    // 地图基础倍数
    const 地图基础 = Math.pow(1 / 地图递增倍数, 地图索引)
    return TAG倍数 * 地图基础
}

// ==================== 数值平衡验证（开发调试用） ====================
/**
 * 验证数值平衡是否合理
 * 检查：当前地图TAG7装备 vs 下一地图TAG1生物
 */
export function 验证数值平衡(): string[] {
    const 结果: string[] = []
    
    for (let i = 0; i < 地图配置.length - 1; i++) {
        const 当前地图 = 地图配置[i]
        const 下一地图 = 地图配置[i + 1]
        
        // 当前地图TAG7装备倍数
        const 装备倍数 = 计算装备属性倍数(i, 7)
        // 下一地图TAG1生物倍数
        const 生物倍数 = 计算生物属性倍数(i + 1, 1)
        
        // 比值：装备/生物，应该 > 1.5 才能快速击杀
        const 比值 = 装备倍数 / 生物倍数
        
        结果.push(`${当前地图.地图名}TAG7(${装备倍数.toFixed(1)}) → ${下一地图.地图名}TAG1(${生物倍数.toFixed(1)}) 比值:${比值.toFixed(2)}`)
    }
    
    return 结果
}

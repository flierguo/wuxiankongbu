/*æœºå™¨äºº*/
import { è·å–ç©å®¶èŒƒå›´å†…ç›®æ ‡, è·å–ç›®æ ‡èŒƒå›´å†…ç›®æ ‡ } from "./MagicNpc"


import {
    _P_N_ç›‘ç‹±è®¡æ—¶, _P_N_å¯å¤æ´»æ¬¡æ•°, æŠ€èƒ½ID
} from "../_æ ¸å¿ƒéƒ¨åˆ†/åŸºç¡€å¸¸é‡"
import * as åŸºç¡€å¸¸é‡ from "../_æ ¸å¿ƒéƒ¨åˆ†/åŸºç¡€å¸¸é‡"
import * as ç”Ÿç‰©åˆ·æ–° from "../_æ ¸å¿ƒéƒ¨åˆ†/_ç”Ÿç‰©/ç”Ÿç‰©åˆ·æ–°"

import { å¤§æ•°å€¼æ•´æ•°ç®€å†™, å®æ—¶å›è¡€, è¡€é‡æ˜¾ç¤º } from "../_æ ¸å¿ƒéƒ¨åˆ†/å­—ç¬¦è®¡ç®—"
import { æ™ºèƒ½è®¡ç®—, è½¬å¤§æ•°å€¼, js_ç™¾åˆ†æ¯”, js_èŒƒå›´éšæœº, js_war, å¤§äºç­‰äº, å¤§äº, å°äºç­‰äº } from "../_å¤§æ•°å€¼/æ ¸å¿ƒè®¡ç®—æ–¹æ³•";

import * as åœ°å›¾ from '../_æ ¸å¿ƒéƒ¨åˆ†/_åœ°å›¾/åœ°å›¾'



// å¯¼å…¥è£…å¤‡å±æ€§ç»Ÿè®¡ä¼˜åŒ–


import { ä¸€é”®å­˜å…¥æ‰€æœ‰ææ–™ } from "../_æ ¸å¿ƒéƒ¨åˆ†/_æœåŠ¡/ææ–™ä»“åº“"
import { RobotPlugIn } from "../_æ ¸å¿ƒéƒ¨åˆ†/_æœåŠ¡/_GN_Monitoring";
import { æ£€æŸ¥æ´¥è´´çŠ¶æ€, æ´¥è´´æ—¶é—´æ‰£é™¤ } from "../_æ ¸å¿ƒéƒ¨åˆ†/_æœåŠ¡/ä¸»ç¥æ´¥è´´"
import { è£…å¤‡å±æ€§ç»Ÿè®¡ } from "../_æ ¸å¿ƒéƒ¨åˆ†/_è£…å¤‡/å±æ€§ç»Ÿè®¡"
import { è‡ªåŠ¨å›æ”¶æç¤º } from "../_æ ¸å¿ƒéƒ¨åˆ†/_è£…å¤‡/è£…å¤‡å›æ”¶"




/*ä¸€ç§’æ‰§è¡Œ*/
export function ä¸ªäºº1ç§’(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {

    // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨è®¡æ•°å™¨å‡å°‘é«˜é¢‘æ“ä½œçš„æ‰§è¡Œé¢‘ç‡
    Player.R.æ€§èƒ½è®¡æ•°å™¨ ??= 0
    Player.R.æ€§èƒ½è®¡æ•°å™¨++

    // ==================== åœ£è€€å‰¯æœ¬çˆ†ç‡æ£€æµ‹ ====================
    // æ¯ç§’æ£€æµ‹ç©å®¶æ˜¯å¦ç¦»å¼€åœ£è€€å‰¯æœ¬ï¼Œå–æ¶ˆçˆ†ç‡åŠ æˆ
    åœ°å›¾.ç¦»å¼€åœ£è€€å‰¯æœ¬æ£€æµ‹(Player)

    // ==================== ç‰¹æ®ŠBOSSå‡»æ€è¿›åº¦æ˜¾ç¤º ====================
    // æ¯ç§’æ›´æ–°æ˜¾ç¤ºå½“å‰åœ°å›¾çš„å‡»æ€è¿›åº¦
    const åœ°å›¾ID = Player.GetMapName()
    const å‡»æ€è¿›åº¦ = ç”Ÿç‰©åˆ·æ–°.è·å–å‡»æ€è¿›åº¦(åœ°å›¾ID)
    if (å‡»æ€è¿›åº¦.éœ€è¦å‡»æ€ > 0) {
        let è¿›åº¦æç¤º = ''
        if (å‡»æ€è¿›åº¦.ç‰¹æ®ŠBOSSå­˜æ´») {
            è¿›åº¦æç¤º = `{S=ç‰¹æ®ŠBOSSå·²åˆ·æ–°!;C=251}`
        } else {
            const ç™¾åˆ†æ¯” = Math.floor((å‡»æ€è¿›åº¦.å½“å‰å‡»æ€ / å‡»æ€è¿›åº¦.éœ€è¦å‡»æ€) * 100)
            è¿›åº¦æç¤º = `{S=ç‰¹æ®ŠBOSSè¿›åº¦: ${å‡»æ€è¿›åº¦.å½“å‰å‡»æ€}/${å‡»æ€è¿›åº¦.éœ€è¦å‡»æ€} (${ç™¾åˆ†æ¯”}%)}`
        }
        let å‡»æ€è¿›åº¦Buff = Player.AddIntervalBuff(99, TBuffIntervalType.biNone, 0, 0, 0, 0)
        Player.SetBuffIcon(å‡»æ€è¿›åº¦Buff.Handle, 'magicon.wzl', 2330, 2330, ``, '', è¿›åº¦æç¤º, false, false)
    }

    if (Player.V.å¼€å¯æŒ‚æœº && Player.R.æ€§èƒ½è®¡æ•°å™¨ % 5 === 0) {
        Player.ReloadBag()
    }
    if (Player.V.è‡ªåŠ¨åƒåœ£å¢Ÿç‚¹æ•° && Player.R.æ€§èƒ½è®¡æ•°å™¨ % 60 === 0) {
        è‡ªåŠ¨åƒåœ£å¢Ÿç‚¹æ•°(Npc, Player, Args)
    }
    // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šè‡ªåŠ¨åƒé“å…·æ”¹ä¸ºæ¯2ç§’æ‰§è¡Œä¸€æ¬¡
    if (Player.R.æ€§èƒ½è®¡æ•°å™¨ % 2 === 0) {
        if (Player.V.è‡ªåŠ¨åƒå…ƒå®) {
            è‡ªåŠ¨åƒå…ƒå®ä¼˜åŒ–ç‰ˆ(Npc, Player, Args)
        }
        if (Player.V.è‡ªåŠ¨åƒç­‰çº§ä¸¹) {
            è‡ªåŠ¨åƒç­‰çº§ä¸¹ä¼˜åŒ–ç‰ˆ(Npc, Player, Args)
        }

    }

    if (Player.GetGold() >= 2000000000) {
        if (GameLib.ServerName.includes('åŒ…åŒº')) {
            Player.SetGold(Player.GetGold() - 2000000000)
            Player.SetGameGold(Player.GetGameGold() + 1800000)
            Player.GoldChanged()
            Player.SendMessage(`ä½¿ç”¨{S=2000000000é‡‘å¸;C=154}æˆåŠŸå…‘æ¢äº†{S=1800000å…ƒå®;C=154}`, 1)
        } else if (GameLib.V.æ˜¯æ–°åŒº == true) {
            Player.SetGold(Player.GetGold() - 2000000000)
            Player.SetGameGold(Player.GetGameGold() + 1600000)
            Player.GoldChanged()
            Player.SendMessage(`ä½¿ç”¨{S=2000000000é‡‘å¸;C=154}æˆåŠŸå…‘æ¢äº†{S=1600000å…ƒå®;C=154}`, 1)
        } else {
            Player.SetGold(Player.GetGold() - 2000000000)
            Player.SetGameGold(Player.GetGameGold() + 1200000)
            Player.GoldChanged()
            Player.SendMessage(`ä½¿ç”¨{S=2000000000é‡‘å¸;C=154}æˆåŠŸå…‘æ¢äº†{S=1200000å…ƒå®;C=154}`, 1)
        }
    }

    if (Player.GetGameGold() >= 1800000000) {
        Player.SetGameGold(Player.GetGameGold() - 1800000000)
        Player.SetGamePoint(Player.GetGamePoint() + 15000000)   //å…‘æ¢15000000ç‚¹ç¤¼å·
        Player.GoldChanged()
        Player.SendMessage(`ä½¿ç”¨{S=1800000000å…ƒå®;C=154}æˆåŠŸå…‘æ¢äº†{S=15000000ç‚¹ç¤¼å·;C=154}`, 1)
    }

    å¤æ´»è§¦å‘(Npc, Player, Args)
    // Player.SetHP(Player.GetMaxHP())
    è‡ªåŠ¨æ–½æ³•(Npc, Player, Args)


    //æµ‹è¯•ç”¨ 
    // Player.R.ä¼¤å®³æç¤º = true;
    // Player.V.å®£ä¼ å›æ”¶ = 0;
    // äººç‰©é¢å¤–å±æ€§è®¡ç®—(Player);
    //     Debug( Player.GetName() +'::' + Player.V.é­å°¸å‡ ç‡   + '/' + Player.V.é­å°¸å‡ ç‡_é­”æˆ’  +` + ` + Player.V.çœŸå®å……å€¼ + ` + `+ Player.V.æ°¸ä¹…æå“ç‡ );
    // å±æ€§æŒ‰é’®(Npc,Player)
    // weaponCaption(Npc, Player, Args)


    //æµ‹è¯•ç”¨


    if (Player.R.å¼€å¯æŒ‚æœº && Player.V.è‡ªåŠ¨éšæœº && Player.V.éšæœºè¯»ç§’ > 0) {
        Player.R.éšæœºç§’æ•° ??= 0
        Player.R.éšæœºç§’æ•°++
        if (Player.R.éšæœºç§’æ•° >= Player.V.éšæœºè¯»ç§’) {
            Player.R.éšæœºç§’æ•° = 0
            Player.RandomMove(Player.GetMapName())
        }
    }

    let Magic: TUserMagic
    Magic = Player.FindSkill('éšèº«å¼€å…³');
    if (Player.GetJewelrys(4) != null && Player.GetJewelrys(4).GetName() == 'ç”˜é“å¤«ä¹‹æˆ’') {
        if (Magic == null) {
            Player.AddSkill('éšèº«å¼€å…³');
        }
    } else {
        if (Magic) {
            Player.DelSkill('éšèº«å¼€å…³');
            Player.AddStatusBuff(6, TBuffStatusType.stObserverForMon, -1, 0, 0)
        }
    }

    if (Player.R.æ¢å¤ç‚¹æ•° > 0 && js_war(Player.GetSVar(91), Player.GetSVar(92)) < 0) {
        let æ¢å¤è¡€é‡ = 0
        Player.V.æ¢å¤ä¸“ç²¾æ¿€æ´» ? æ¢å¤è¡€é‡ = Player.R.æ¢å¤ç‚¹æ•° / 1000 * 2 : æ¢å¤è¡€é‡ = Player.R.æ¢å¤ç‚¹æ•° / 1000
        let è¡€é‡åŠ æˆ = æ™ºèƒ½è®¡ç®—(Player.GetSVar(92), String(æ¢å¤è¡€é‡), 3)
        å®æ—¶å›è¡€(Player, è¡€é‡åŠ æˆ)
    }


    if (Player.Charm != null && js_war(Player.GetSVar(91), Player.GetSVar(92)) < 0) {
        let a = 0
        switch (Player.Charm.GetName()) {
            case 'è£èª‰è¡€çŸ³': a = 0.01; break
            case 'åˆ—å…µè¡€çŸ³': a = 0.02; break
            case 'å†›å£«è¡€çŸ³': a = 0.03; break
            case 'å£«å®˜è¡€çŸ³': a = 0.04; break
            case 'éª‘å£«è¡€çŸ³': a = 0.05; break
            case 'æ ¡å°‰è¡€çŸ³': a = 0.06; break
            case 'å°†å†›è¡€çŸ³': a = 0.07; break
            case 'å…ƒå¸…è¡€çŸ³': a = 0.08; break
        }
        Player.R.å›è¡€2ç§’ ??= 0
        Player.R.å›è¡€2ç§’ = Player.R.å›è¡€2ç§’ + 1
        let å›è¡€ = æ™ºèƒ½è®¡ç®—(Player.GetSVar(92), String(a), 3)
        if (Player.R.å›è¡€2ç§’ >= 2) {
            å®æ—¶å›è¡€(Player, å›è¡€)
            Player.R.å›è¡€2ç§’ = 0
        }
    }
}


export function æµ‹è¯•5ç§’(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // åœ°å›¾.åˆ†é’Ÿæ£€æµ‹å‰¯æœ¬ç©å®¶æ•°é‡()
    // _M_Robot.æŒ‰åˆ†é’Ÿæ£€æµ‹(Player)
    Player = GameLib.FindPlayer('é¸¿ç¦'); //æŸ¥æ‰¾ç©å®¶
    if (Player != null) {
        // Player.SetSVar(92, è½¬å¤§æ•°å€¼('1e100'))
        // // Player.SetSVar(91 , '1e100') 
        // å®æ—¶å›è¡€(Player, '1e100')
        // è¡€é‡æ˜¾ç¤º(Player);
        const Magic = Player.FindSkill('æš—å½±é™„ä½“');
        // console.log(`cd:${Magic.GetUseTime()}ssssss${Magic.CDTime}`)
        // // Magic.SetUseTime(0)
        // Magic.GetKey
        // console.log(Magic.GetKey())
        // GameLib.SetClientSpeed(1000)
        // GameLib.SendChangeClientSpeed()
    }

    //    // GameLib.MonGenEx( Player.Map , 'å¤šé’©çŒ«', 30, 120, 120, 30, 0, 0, 1, true, true, true, true)

    // _M_Robot.æŒ‰åˆ†é’Ÿæ£€æµ‹(Player)


}

export function å…¨å±€1ç§’(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // æ–°åˆ·æ€ªç³»ç»Ÿï¼šæ£€æµ‹ç©å®¶é¦–æ¬¡è¿›å…¥åœ°å›¾ï¼Œ10ç§’ååˆ·å…¨æ€ª
    ç”Ÿç‰©åˆ·æ–°.ç§’é’Ÿæ£€æµ‹é¦–æ¬¡åˆ·æ€ª()

}
/*åç§’æ‰§è¡Œ*/
export function ä¸ªäºº10ç§’(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {

    // è£…å¤‡å±æ€§ç»Ÿè®¡(Player);
    /*ç›‘æ§å¤–æŒ‚*/
    RobotPlugIn(Player);

    // æ£€æŸ¥ä¸»ç¥æ´¥è´´çŠ¶æ€
    æ£€æŸ¥æ´¥è´´çŠ¶æ€(Player);

    // è‡ªåŠ¨å›æ”¶æç¤ºï¼ˆç´¯è®¡10ç§’å†…çš„å›æ”¶æ•°æ®ï¼‰
    if (Player.R.ç´¯è®¡å›æ”¶é‡‘å¸ > 0) {
        è‡ªåŠ¨å›æ”¶æç¤º(Player);
    }
    if (Player.V.å¼€å¯æŒ‚æœº) {
        Player.ReloadBag()
    }
    if (Player.V.ææ–™å…¥ä»“) {
        ä¸€é”®å­˜å…¥æ‰€æœ‰ææ–™(Npc, Player, Args)
    }

}

/*æ¯åˆ†é’Ÿæ‰§è¡Œï¼ˆä¸ªäººï¼‰*/
export function ä¸ªäºº1åˆ†é’Ÿ(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // æ‰£é™¤ä¸»ç¥æ´¥è´´æ—¶é—´ï¼ˆæ¯åˆ†é’Ÿ-1ï¼‰
    æ´¥è´´æ—¶é—´æ‰£é™¤(Player);

}
/*æ¯30Sæ£€æµ‹ä¸€æ¬¡*/
export function å…¨å±€30ç§’(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // æ–°åˆ·æ€ªç³»ç»Ÿï¼šå®šæ—¶è¡¥æ€ªæ£€æµ‹
    ç”Ÿç‰©åˆ·æ–°.å®šæ—¶è¡¥æ€ªæ£€æµ‹()
    // æ–°åˆ·æ€ªç³»ç»Ÿï¼šç‰¹æ®ŠBOSSåˆ·æ–°æ£€æµ‹(å‡»æ€2000æ€ªè§¦å‘)
    ç”Ÿç‰©åˆ·æ–°.ç‰¹æ®ŠBOSSåˆ·æ–°æ£€æµ‹()

    // ; 
}

/*æ¯1åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡*/
export function å…¨å±€1åˆ†é’Ÿ(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {

    åœ°å›¾.å‰¯æœ¬æ¸…ç†()

    // ==================== åœ£è€€å‰¯æœ¬æ¸…ç† ====================
    // æ¯åˆ†é’Ÿæ£€æµ‹åœ£è€€å‰¯æœ¬ï¼š24å°æ—¶åˆ°æœŸæˆ–æ— äºº30åˆ†é’Ÿååˆ é™¤
    åœ°å›¾.åœ£è€€å‰¯æœ¬æ¸…ç†()

    // ==================== æ–°åˆ·æ€ªç³»ç»Ÿï¼šæ— äººåœ°å›¾æ¸…ç† ====================
    ç”Ÿç‰©åˆ·æ–°.æ¸…ç†æ— äººåœ°å›¾æ€ªç‰©()

    // ==================== å¤§é™†BOSSåˆ·æ–°æ£€æµ‹(TAG 6) ====================
    // æ¯2å°æ—¶åœ¨å½“å‰å¤§é™†æ‰€æœ‰åœ°å›¾åˆ·æ–°
    ç”Ÿç‰©åˆ·æ–°.å¤§é™†BOSSåˆ·æ–°æ£€æµ‹()

    // ==================== äº”åˆ†é’Ÿå…¨é¢è¡¥æ€ª ====================
    GameLib.R.äº”åˆ†é’Ÿè¡¥æ€ªè®¡æ•° ??= 0
    GameLib.R.äº”åˆ†é’Ÿè¡¥æ€ªè®¡æ•° += 1
    if (GameLib.R.äº”åˆ†é’Ÿè¡¥æ€ªè®¡æ•° >= 5) {
        ç”Ÿç‰©åˆ·æ–°.äº”åˆ†é’Ÿå…¨é¢è¡¥æ€ª()
        GameLib.R.äº”åˆ†é’Ÿè¡¥æ€ªè®¡æ•° = 0
    }

    // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå¤§å¹…å‡å°‘è„šæœ¬é‡è½½é¢‘ç‡ï¼Œä»5åˆ†é’Ÿæ”¹ä¸º30åˆ†é’Ÿ
    GameLib.R.å®šæœŸåŠ è½½ ??= 0
    GameLib.R.å®šæœŸåŠ è½½ += 1
    if (GameLib.R.å®šæœŸåŠ è½½ >= 10) { // ä»5æ”¹ä¸º30åˆ†é’Ÿï¼Œå‡å°‘CPUæ¶ˆè€—
        // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šä»…åœ¨å¿…è¦æ—¶é‡è½½è„šæœ¬å¼•æ“
        GameLib.ReLoadScriptEngine();
        GameLib.R.å®šæœŸåŠ è½½ = 0
    }

    // ==================== æ–°åŒºçŠ¶æ€æ£€æµ‹ï¼ˆæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰ ====================
    // ä½¿ç”¨åˆ†é’Ÿè®¡æ•°å™¨ï¼Œ7å¤© = 7 * 24 * 60 = 10080 åˆ†é’Ÿ
    GameLib.V.æ˜¯æ–°åŒº ??= true

    if (GameLib.V.æ˜¯æ–°åŒº === true) {
        // åˆå§‹åŒ–å¼€åŒºåˆ†é’Ÿè®¡æ•°å™¨
        GameLib.V.å¼€åŒºåˆ†é’Ÿæ•° ??= 0
        GameLib.V.å¼€åŒºåˆ†é’Ÿæ•°++

        // 7å¤© = 10080åˆ†é’Ÿ
        if (GameLib.V.å¼€åŒºåˆ†é’Ÿæ•° >= 1440 * 7) {
            GameLib.V.æ˜¯æ–°åŒº = false
            GameLib.BroadcastTopMessage(`æœåŠ¡å™¨å·²å¼€åŒºæ»¡7å¤©ï¼Œæ–°åŒºçŠ¶æ€å·²å–æ¶ˆï¼`)
            console.log(`[ç³»ç»Ÿ] æœåŠ¡å™¨å¼€åŒº${Math.floor(GameLib.V.å¼€åŒºåˆ†é’Ÿæ•° / 1440)}å¤©ï¼Œæ–°åŒºçŠ¶æ€å·²å–æ¶ˆ`)
        }
    }

}

/*1ç§’æ‰§è¡Œå¤æ´»æ¬¡æ•°*/
export function å¤æ´»è§¦å‘(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {

    if (Player.GetJewelrys(4) && Player.GetJewelrys(4).GetName() == 'ç”˜é“å¤«ä¹‹æˆ’') {
        let AItem = Player.GetJewelrys(4)
        let å¤æ´»å†·å´æ—¶é—´ = 180 - AItem.GetOutWay3(40) * 10
        let n = Object.keys(GameLib.V[Player.PlayerID])
        if (n.length > 0) {
            for (let v = 0; v <= n.length - 1; v++) {
                // console.log(Trunc((GameLib.TickCount - GameLib.V[Player.PlayerID][n[v]]) / 1000))
                let è®¡ç®—å¤æ´»å†·å´æ—¶é—´ = Trunc((GameLib.TickCount - GameLib.V[Player.PlayerID][n[v]]) / 1000)
                if (è®¡ç®—å¤æ´»å†·å´æ—¶é—´ >= å¤æ´»å†·å´æ—¶é—´) {
                    Player.SetNVar(_P_N_å¯å¤æ´»æ¬¡æ•°, Player.GetNVar(_P_N_å¯å¤æ´»æ¬¡æ•°) + 1)
                    delete GameLib.V[Player.PlayerID][n[v]]
                }
            }
            // Player.SendMessage(`ä½ å½“å‰å¯å¤æ´»æ¬¡æ•°ï¼š${Player.GetNVar(_P_N_å¯å¤æ´»æ¬¡æ•°)}æ¬¡...`, 1)
        } else {
            Player.SetNVar(_P_N_å¯å¤æ´»æ¬¡æ•°, AItem.GetOutWay3(40))
            // Player.SendMessage(`ä½ å½“å‰å¯å¤æ´»æ¬¡æ•°ï¼š${AItem.GetOutWay3(40)}æ¬¡...`, 1)
        }
    }
    // console.log(GameLib.V[Player.PlayerID])

    // Player.RemoveExtendButton('å¤æ´»')
    // Player.AddExtendButton('å¤æ´»', '{S=å½“å‰å¯å¤æ´»æ¬¡æ•°:;C=254}' + '{S=[;C=243}' + Player.GetNVar(_P_N_å¯å¤æ´»æ¬¡æ•°) + '{S=];C=243}', '', 186, 1, -600)

}

export function å…¨å±€æ¯æ—¥æ¸…ç†(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    delete GameLib.V.æ¯æ—¥å›æ”¶ç¥å™¨æ¬¡æ•°
    delete GameLib.V.æ¯æ—¥å®£ä¼ å…‘æ¢æ¬¡æ•°

}

export function ä¸ªäººæ¯æ—¥æ¸…ç†(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {

    Player.V.æ¯æ—¥å®£ä¼ å…‘æ¢æ¬¡æ•° = 0
    Player.V.ä»Šæ—¥ç¥å™¨å›æ”¶ = 0
}


const åœ£å¢Ÿç‚¹æ•°é“å…·é…ç½® = [
    { åç§°: 'åœ£å¢Ÿ10ç‚¹', æ•°å€¼: 10, ç±»å‹: 'åœ£å¢Ÿç‚¹æ•°' },
    { åç§°: 'åœ£å¢Ÿ20ç‚¹', æ•°å€¼: 20, ç±»å‹: 'åœ£å¢Ÿç‚¹æ•°' },
    { åç§°: 'åœ£å¢Ÿ50ç‚¹', æ•°å€¼: 50, ç±»å‹: 'åœ£å¢Ÿç‚¹æ•°' },
]
export function è‡ªåŠ¨åƒåœ£å¢Ÿç‚¹æ•°(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    for (const é“å…· of åœ£å¢Ÿç‚¹æ•°é“å…·é…ç½®) {
        if (Player.GetItemCount(é“å…·.åç§°) > 0) {
            const æ•°é‡ = Player.GetItemCount(é“å…·.åç§°)
            Npc.Take(Player, é“å…·.åç§°, æ•°é‡)
            Player.V.åœ£å¢Ÿç‚¹æ•° += (é“å…·.æ•°å€¼ * æ•°é‡)
            Player.SendMessage(`å½“å‰ä½¿ç”¨{S=${æ•°é‡}ä¸ª${é“å…·.åç§°};C=253},å¢åŠ ç‚¹æ•°{S=${é“å…·.æ•°å€¼ * æ•°é‡};C=250},åœ£å¢Ÿç‚¹æ•°ä¸º{S=${Player.V.åœ£å¢Ÿç‚¹æ•°};C=250}`, 1)
        }
    }
}

// ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šä¼˜åŒ–ç‰ˆçš„è‡ªåŠ¨åƒç­‰çº§ä¸¹ï¼Œä½¿ç”¨æ•°æ®é©±åŠ¨å‡å°‘é‡å¤ä»£ç 
const ç­‰çº§çŸ³é…ç½® = [
    10000, 9500, 9000, 8500, 8000, 7500, 7000, 6500, 6000, 5500,
    5000, 4500, 4000, 3500, 3000, 2500, 2000, 1500, 1000, 500
];

export function è‡ªåŠ¨åƒç­‰çº§ä¸¹ä¼˜åŒ–ç‰ˆ(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // ğŸš€ æŒ‰ç­‰çº§è¦æ±‚ä»é«˜åˆ°ä½æ£€æŸ¥ï¼Œæ‰¾åˆ°å¯ç”¨çš„ç­‰çº§çŸ³
    for (const ç­‰çº§ä¸Šé™ of ç­‰çº§çŸ³é…ç½®) {
        const é“å…·å = `ç­‰çº§çŸ³(${ç­‰çº§ä¸Šé™})`
        if (Player.Level <= ç­‰çº§ä¸Šé™ && Player.GetItemCount(é“å…·å) > 0) {
            // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡å¤„ç†ç­‰çº§çŸ³ï¼Œæ¯æ¬¡æœ€å¤šä½¿ç”¨5ä¸ª
            const å¯ç”¨æ•°é‡ = Player.GetItemCount(é“å…·å)
            const æ‰¹é‡æ•°é‡ = Math.min(å¯ç”¨æ•°é‡, 5, ç­‰çº§ä¸Šé™ - Player.Level)

            for (let i = 0; i < æ‰¹é‡æ•°é‡; i++) {
                if (Player.Level <= ç­‰çº§ä¸Šé™) {
                    Npc.Take(Player, é“å…·å, 1)
                    Player.Level += 1
                } else {
                    break
                }
            }
            break; // æ‰¾åˆ°å¹¶å¤„ç†åé€€å‡º
        }
    }
}

// ä¿ç•™åŸå‡½æ•°ä¾›å…¼å®¹æ€§
export function è‡ªåŠ¨åƒç­‰çº§ä¸¹(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    è‡ªåŠ¨åƒç­‰çº§ä¸¹ä¼˜åŒ–ç‰ˆ(Npc, Player, Args)
}


// ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šä¼˜åŒ–ç‰ˆçš„è‡ªåŠ¨åƒå…ƒå®ï¼Œä½¿ç”¨æ•°æ®é©±åŠ¨å‡å°‘é‡å¤ä»£ç 
const å…ƒå®é“å…·é…ç½® = [
    { åç§°: '10000å…ƒå®', æ•°å€¼: 10000, ç±»å‹: 'gold' },
    { åç§°: '5000å…ƒå®', æ•°å€¼: 5000, ç±»å‹: 'gold' },
    { åç§°: '2000å…ƒå®', æ•°å€¼: 2000, ç±»å‹: 'gold' },
    { åç§°: '1000å…ƒå®', æ•°å€¼: 1000, ç±»å‹: 'gold' },
    { åç§°: '500å…ƒå®', æ•°å€¼: 500, ç±»å‹: 'gold' },
    { åç§°: '200å…ƒå®', æ•°å€¼: 200, ç±»å‹: 'gold' },
    { åç§°: '100å…ƒå®', æ•°å€¼: 100, ç±»å‹: 'gold' },
    { åç§°: '50å…ƒå®', æ•°å€¼: 50, ç±»å‹: 'gold' },
    { åç§°: '20å…ƒå®', æ•°å€¼: 20, ç±»å‹: 'gold' },
    { åç§°: '5å…ƒå®', æ•°å€¼: 5, ç±»å‹: 'gold' },
    { åç§°: '1å…ƒå®', æ•°å€¼: 1, ç±»å‹: 'gold' },
    { åç§°: '100ç¤¼åˆ¸', æ•°å€¼: 100, ç±»å‹: 'point' },
    { åç§°: '10ç¤¼åˆ¸', æ•°å€¼: 10, ç±»å‹: 'point' },
    { åç§°: '1ç¤¼åˆ¸', æ•°å€¼: 1, ç±»å‹: 'point' }
];

export function è‡ªåŠ¨åƒå…ƒå®ä¼˜åŒ–ç‰ˆ(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    let æœ‰æ›´æ–° = false

    // ğŸš€ æŒ‰ä»·å€¼ä»å¤§åˆ°å°å¤„ç†ï¼Œå‡å°‘å¾ªç¯æ¬¡æ•°
    for (const é“å…· of å…ƒå®é“å…·é…ç½®) {
        const æ•°é‡ = Player.GetItemCount(é“å…·.åç§°)
        if (æ•°é‡ > 0) {
            // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡å¤„ç†ç›¸åŒé“å…·ï¼Œå‡å°‘è°ƒç”¨æ¬¡æ•°
            const æ‰¹é‡å¤„ç†æ•°é‡ = Math.min(æ•°é‡, 10) // æ¯æ¬¡æœ€å¤šå¤„ç†10ä¸ª
            for (let i = 0; i < æ‰¹é‡å¤„ç†æ•°é‡; i++) {
                Npc.Take(Player, é“å…·.åç§°, 1)
                if (é“å…·.ç±»å‹ === 'gold') {
                    Player.SetGameGold(Player.GetGameGold() + é“å…·.æ•°å€¼)
                } else {
                    Player.SetGamePoint(Player.GetGamePoint() + é“å…·.æ•°å€¼)
                }
            }
            æœ‰æ›´æ–° = true
            break; // å¤„ç†å®Œä¸€ç§é“å…·åé€€å‡ºï¼Œä¸‹æ¬¡å†å¤„ç†å…¶ä»–
        }
    }

    if (æœ‰æ›´æ–°) {
        Player.GoldChanged()
    }
}

// ä¿ç•™åŸå‡½æ•°ä¾›å…¼å®¹æ€§
export function è‡ªåŠ¨åƒå…ƒå®(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    è‡ªåŠ¨åƒå…ƒå®ä¼˜åŒ–ç‰ˆ(Npc, Player, Args)
}


export function è‡ªåŠ¨æ–½æ³•(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    Player.R.æ–½æ³•è¯»ç§’ ??= 0
    Player.R.æ–½æ³•è¯»ç§’++

    const V = Player.V;
    const R = Player.R;
    let Magic: TUserMagic;
    let AActorList: TActorList;

    // ==================== é€šç”¨å˜é‡åˆå§‹åŒ– ====================
    const æœ€å¤§è¡€é‡ = Player.GetSVar(92);
    const å½“å‰è¡€é‡ = Player.GetSVar(91);
    // mode 5 = é™¤æ³•ä¿ç•™2ä½å°æ•°ï¼Œé¿å…æ•´æ•°é™¤æ³•æˆªæ–­
    const å‰©ä½™è¡€é‡ç™¾åˆ†æ¯” = æ™ºèƒ½è®¡ç®—(æ™ºèƒ½è®¡ç®—(å½“å‰è¡€é‡, æœ€å¤§è¡€é‡, 5), '100', 3);

    // ==================== å…­å¤§æ–°èŒä¸šè‡ªåŠ¨æ–½æ³• ====================
    // æ ¹æ®æŠ€èƒ½æè¿°å®ç°æŒç»­æ€§æŠ€èƒ½çš„è‡ªåŠ¨æ–½æ³•

    // ============================================================
    // ==================== å¤©æ¢èŒä¸š ====================
    // ============================================================
    if (V.èŒä¸š === 'å¤©æ¢' && !Player.InSafeZone) {
        // æ€’æ–©ï¼šå¯¹å‘¨å›´8ç å†…æœ€è¿‘çš„æ•Œäººæ–½æ³•ï¼ˆæ¯ç§’ï¼‰
        if (V.è‡ªåŠ¨_æ€’æ–©) {
            Magic = Player.FindSkill('æ€’æ–©');
            if (Magic) {
                const æœ€è¿‘ç›®æ ‡ = è·å–å‘¨å›´æœ€è¿‘ç›®æ ‡(Player, 8);
                if (æœ€è¿‘ç›®æ ‡) {
                    Player.MagicAttack(æœ€è¿‘ç›®æ ‡, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.å¤©æ¢.æ€’æ–©);
                }
            }
        }
    }

    // ============================================================
    // ==================== è¡€ç¥èŒä¸š ====================
    // ============================================================
    if (V.èŒä¸š === 'è¡€ç¥' && !Player.InSafeZone) {

        // ---------- è¡€æ°”çŒ®ç¥­ï¼šå¯¹å‘¨å›´8ç å†…æœ€è¿‘çš„æ•Œäººæ–½æ³•ï¼ˆæ¯ç§’ï¼‰ ----------
        // æ¡ä»¶ï¼šè¡€é‡ >= 5%
        if (V.è‡ªåŠ¨_è¡€æ°”çŒ®ç¥­ && å¤§äºç­‰äº(å‰©ä½™è¡€é‡ç™¾åˆ†æ¯”, '5')) {
            Magic = Player.FindSkill('è¡€æ°”çŒ®ç¥­');
            if (Magic) {
                const æœ€è¿‘ç›®æ ‡ = è·å–å‘¨å›´æœ€è¿‘ç›®æ ‡(Player, 8);
                if (æœ€è¿‘ç›®æ ‡) {
                    Player.MagicAttack(æœ€è¿‘ç›®æ ‡, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.è¡€ç¥.è¡€æ°”çŒ®ç¥­);
                }
            }
        }

        // ---------- è¡€é­”ä¸´èº«ï¼šè‡ªåŠ¨é‡Šæ”¾ + æ¯ç§’å›è¡€æ•ˆæœ ----------
        // æè¿°ï¼šå¼€å¯å,æ¯ç§’å›è¡€1%,æŒç»­æ—¶é—´30S(æ¯5çº§å›å¤æé«˜1%,æ¯5çº§å¢åŠ 1S,æœ€é«˜180S)
        // CD: 180ç§’åå¯å†æ¬¡é‡Šæ”¾
        Player.R.è¡€é­”ä¸´èº«CD ??= 0;
        Player.R.è¡€é­”ä¸´èº«æŒç»­CD ??= 0;
        if (V.è‡ªåŠ¨_è¡€é­”ä¸´èº« && !R.è¡€é­”ä¸´èº«) {
            Player.R.è¡€é­”ä¸´èº«CD += 1;
            if (Player.R.è¡€é­”ä¸´èº«CD >= 180) {
                Magic = Player.FindSkill('è¡€é­”ä¸´èº«');
                if (Magic) {
                    R.è¡€é­”ä¸´èº« = true;
                    Player.R.è¡€é­”ä¸´èº«CD = 0;
                    // æ¿€æ´»æ—¶è®¡ç®—å¹¶è®¾ç½®æŒç»­æ—¶é—´
                    const æŠ€èƒ½ç­‰çº§ = Player.V.è¡€é­”ä¸´èº«ç­‰çº§ || 1;
                    const æŒç»­æ—¶é—´ = Math.min(30 + Math.floor(æŠ€èƒ½ç­‰çº§ / 5), 180);
                    Player.R.è¡€é­”ä¸´èº«æŒç»­CD = æŒç»­æ—¶é—´;
                    Player.MagicAttack(Player, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.è¡€ç¥.è¡€é­”ä¸´èº«, true);
                    Player.SetCustomEffect(åŸºç¡€å¸¸é‡.æ°¸ä¹…ç‰¹æ•ˆ.è¡€é­”ä¸´èº«, åŸºç¡€å¸¸é‡.ç‰¹æ•ˆ.è¡€é­”ä¸´èº«);
                    Player.SendMessage(`è¡€é­”ä¸´èº«å¼€å¯ï¼ŒæŒç»­${æŒç»­æ—¶é—´}ç§’`, 2);
                }
            }
        }

        // è¡€é­”ä¸´èº«æŒç»­æ•ˆæœï¼šæ¯ç§’å›è¡€
        if (R.è¡€é­”ä¸´èº«) {
            Player.R.è¡€é­”ä¸´èº«CD += 1;
            const æŠ€èƒ½ç­‰çº§ = Player.V.è¡€é­”ä¸´èº«ç­‰çº§ || 1;
            // const æŒç»­æ—¶é—´ = Math.min(30 + Math.floor(æŠ€èƒ½ç­‰çº§ / 5), 180);
            // Player.R.è¡€é­”ä¸´èº«æŒç»­CD = æŒç»­æ—¶é—´;
            if (Player.R.è¡€é­”ä¸´èº«æŒç»­CD > 0) {
                const å›è¡€ç™¾åˆ†æ¯” = 1 + Math.floor(æŠ€èƒ½ç­‰çº§ / 5);
                // åªæœ‰è¡€é‡æœªæ»¡æ—¶æ‰å›è¡€
                if (js_war(å½“å‰è¡€é‡, æœ€å¤§è¡€é‡) < 0) {
                    const å›è¡€é‡ = æ™ºèƒ½è®¡ç®—(æœ€å¤§è¡€é‡, String(å›è¡€ç™¾åˆ†æ¯” / 100), 3);
                    å®æ—¶å›è¡€(Player, å›è¡€é‡);
                    Player.R.è¡€é­”ä¸´èº«æŒç»­CD--;
                }
            } else {
                // æŒç»­æ—¶é—´ç»“æŸï¼Œå…³é—­è¡€é­”ä¸´èº«
                R.è¡€é­”ä¸´èº« = false;
                Player.SetCustomEffect(åŸºç¡€å¸¸é‡.æ°¸ä¹…ç‰¹æ•ˆ.è¡€é­”ä¸´èº«, -1);
                Player.SendMessage('è¡€é­”ä¸´èº«æ•ˆæœå·²ç»“æŸ!', 2);
            }
        }
        // ---------- è¡€æ°”ç‡ƒçƒ§ï¼šå¼€å¯ + æŒç»­æ•ˆæœ ----------
        // æè¿°ï¼šå¼€å¯å,æ¯ç§’å¯¹å‘¨å›´5ç èŒƒå›´å†…æ•Œäººé€ æˆ150%çš„ä¼¤å®³,æ¯çº§æé«˜15%
        // æ¯ç§’æ¶ˆè€—1%è¡€é‡ï¼Œè¡€é‡ä½äº10%æ—¶è‡ªåŠ¨å…³é—­
        if (V.è‡ªåŠ¨_è¡€æ°”ç‡ƒçƒ§ && !R.è¡€æ°”ç‡ƒçƒ§ && å¤§äº(å‰©ä½™è¡€é‡ç™¾åˆ†æ¯”, '10')) {
            R.è¡€æ°”ç‡ƒçƒ§ = true;
            Player.SetCustomEffect(åŸºç¡€å¸¸é‡.æ°¸ä¹…ç‰¹æ•ˆ.è¡€æ°”ç‡ƒçƒ§, åŸºç¡€å¸¸é‡.ç‰¹æ•ˆ.è¡€æ°”ç‡ƒçƒ§);
            Player.SendMessage('è¡€æ°”ç‡ƒçƒ§å¼€å¯', 2);
        }

        // è¡€æ°”ç‡ƒçƒ§æŒç»­æ•ˆæœ
        if (R.è¡€æ°”ç‡ƒçƒ§) {
            let å½“å‰è¡€é‡_ç‡ƒçƒ§ = Player.GetSVar(91);
            let æœ€å¤§è¡€é‡_ç‡ƒçƒ§ = Player.GetSVar(92);
            // æ£€æŸ¥è¡€é‡æ˜¯å¦ä½äº10%ï¼Œè‡ªåŠ¨å…³é—­
            if (js_war(å½“å‰è¡€é‡_ç‡ƒçƒ§, æ™ºèƒ½è®¡ç®—(æœ€å¤§è¡€é‡_ç‡ƒçƒ§, '10', 4)) <= 0) {
                R.è¡€æ°”ç‡ƒçƒ§ = false;
                Player.SetCustomEffect(åŸºç¡€å¸¸é‡.æ°¸ä¹…ç‰¹æ•ˆ.è¡€æ°”ç‡ƒçƒ§, -1);
                Player.SendMessage('è¡€é‡ä½äº10%,è¡€æ°”ç‡ƒçƒ§è‡ªåŠ¨å…³é—­!', 2);
            } else {
                // æ¶ˆè€—1%è¡€é‡
                å½“å‰è¡€é‡_ç‡ƒçƒ§ = æ™ºèƒ½è®¡ç®—(å½“å‰è¡€é‡_ç‡ƒçƒ§, æ™ºèƒ½è®¡ç®—(æœ€å¤§è¡€é‡_ç‡ƒçƒ§, '100', 4), 2);
                Player.SetSVar(91, å½“å‰è¡€é‡_ç‡ƒçƒ§);
                è¡€é‡æ˜¾ç¤º(Player);
                // å¯¹å‘¨å›´æ•Œäººé€ æˆä¼¤å®³
                const èŒƒå›´ = 5 + (R.è¡€æ°”ç‡ƒçƒ§èŒƒå›´ || 0);
                const ç›®æ ‡åˆ—è¡¨ = è·å–ç©å®¶èŒƒå›´å†…ç›®æ ‡(Player, èŒƒå›´);
                for (const ç›®æ ‡ of ç›®æ ‡åˆ—è¡¨) {
                    Player.Damage(ç›®æ ‡, 1, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.è¡€ç¥.è¡€æ°”ç‡ƒçƒ§);
                }
            }
        }
    }

    // ============================================================
    // ==================== æš—å½±èŒä¸š ====================
    // ============================================================
    if (V.èŒä¸š === 'æš—å½±' && !Player.InSafeZone) {

        // ---------- æš—å½±è¢­æ€ ----------
        // R.æš—å½±è¢­æ€èŒƒå›´ > 0 æ—¶å¯¹ç›®æ ‡èŒƒå›´å†…æ•Œäººé€ æˆä¼¤å®³ï¼Œå¦åˆ™æ”»å‡»æœ€è¿‘ç›®æ ‡
        if (V.è‡ªåŠ¨_æš—å½±è¢­æ€) {
            Magic = Player.FindSkill('æš—å½±è¢­æ€');
            if (Magic) {
                const æœ€è¿‘ç›®æ ‡ = è·å–å‘¨å›´æœ€è¿‘ç›®æ ‡(Player, 8);
                if (æœ€è¿‘ç›®æ ‡) {
                    if (R.æš—å½±è¢­æ€èŒƒå›´ > 0) {
                        // AOEæ¨¡å¼ï¼šä»¥æœ€è¿‘ç›®æ ‡ä¸ºä¸­å¿ƒå¯¹èŒƒå›´å†…æ•Œäººé€ æˆä¼¤å®³
                        const ç›®æ ‡åˆ—è¡¨ = è·å–ç›®æ ‡èŒƒå›´å†…ç›®æ ‡(Player, æœ€è¿‘ç›®æ ‡, R.æš—å½±è¢­æ€èŒƒå›´);
                        for (const ç›®æ ‡ of ç›®æ ‡åˆ—è¡¨) {
                            Player.MagicAttack(ç›®æ ‡, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.æš—å½±.æš—å½±è¢­æ€, true);
                        }
                    } else {
                        // å•ä½“æ¨¡å¼
                        Player.MagicAttack(æœ€è¿‘ç›®æ ‡, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.æš—å½±.æš—å½±è¢­æ€, true);
                    }
                }
            }
        }

        // ---------- æš—å½±é£æš´ï¼šæœ‰CDï¼ˆ20ç§’ï¼‰ ----------
        // æ¶ˆè€—5ç‚¹æš—å½±å€¼
        Player.R.æš—å½±é£æš´CD ??= 0;
        if (V.è‡ªåŠ¨_æš—å½±é£æš´) {
            Player.R.æš—å½±é£æš´CD += 1;
            if (Player.R.æš—å½±é£æš´CD >= 20 && R.æš—å½±å€¼ >= 5) {
                Magic = Player.FindSkill('æš—å½±é£æš´');
                if (Magic) {
                    const æœ€è¿‘ç›®æ ‡ = è·å–å‘¨å›´æœ€è¿‘ç›®æ ‡(Player, 8);
                    if (æœ€è¿‘ç›®æ ‡) {
                        Player.MagicAttack(æœ€è¿‘ç›®æ ‡, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.æš—å½±.æš—å½±é£æš´, true);
                        Player.R.æš—å½±é£æš´CD = 0;
                    }
                }
            }
        }

        // ---------- æš—å½±é™„ä½“ï¼šæœ‰CDï¼ˆ180ç§’ï¼‰ ----------
        // æ¶ˆè€—180ç‚¹æš—å½±å€¼
        Player.R.æš—å½±é™„ä½“CD ??= 0;
        if (V.è‡ªåŠ¨_æš—å½±é™„ä½“ && !R.æš—å½±é™„ä½“) {
            Player.R.æš—å½±é™„ä½“CD += 1;
            if (Player.R.æš—å½±é™„ä½“CD >= 180 && R.æš—å½±å€¼ >= 180) {
                Magic = Player.FindSkill('æš—å½±é™„ä½“');
                if (Magic) {
                    let æš—å½±Buff = Player.AddIntervalBuff(1, TBuffIntervalType.biNone, 0, 0, 0, 0);
                    Player.SetBuffIcon(æš—å½±Buff.Handle, 'magicon.wzl', 2312, 2312, '', '', `{S=å½“å‰æš—å½±å€¼: ${R.æš—å½±å€¼} ç‚¹}`, true, true);
                    Player.MagicAttack(Player, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.æš—å½±.æš—å½±é™„ä½“, true);
                    Player.R.æš—å½±é™„ä½“CD = 0;
                }
            }
        }

        // ---------- æš—å½±å‰”éª¨ï¼šå¼€å¯ + æŒç»­æ•ˆæœ ----------
        // æè¿°ï¼šå¼€å¯åå¯¹å‘¨å›´6ç èŒƒå›´å†…æ•Œäººé€ æˆ300%ä¼¤å®³,æ¯çº§æé«˜30%,æ¯ç§’æ¶ˆè€—1ç‚¹æš—å½±å€¼
        if (V.è‡ªåŠ¨_æš—å½±å‰”éª¨ && !R.æš—å½±å‰”éª¨ && R.æš—å½±å€¼ >= 1) {
            R.æš—å½±å‰”éª¨ = true;
            Player.SetCustomEffect(åŸºç¡€å¸¸é‡.æ°¸ä¹…ç‰¹æ•ˆ.æš—å½±å‰”éª¨, åŸºç¡€å¸¸é‡.ç‰¹æ•ˆ.æš—å½±å‰”éª¨);
            Player.SendMessage('æš—å½±å‰”éª¨å¼€å¯', 2);
        }

        // æš—å½±å‰”éª¨æŒç»­æ•ˆæœ
        if (R.æš—å½±å‰”éª¨) {
            if (R.æš—å½±å€¼ < 1) {
                // æš—å½±å€¼ä¸è¶³ï¼Œè‡ªåŠ¨å…³é—­
                R.æš—å½±å‰”éª¨ = false;
                Player.SetCustomEffect(åŸºç¡€å¸¸é‡.æ°¸ä¹…ç‰¹æ•ˆ.æš—å½±å‰”éª¨, -1);
                Player.SendMessage('æš—å½±å€¼ä¸è¶³,æš—å½±å‰”éª¨è‡ªåŠ¨å…³é—­!', 2);
            } else {
                // æ¶ˆè€—1ç‚¹æš—å½±å€¼
                R.æš—å½±å€¼ = R.æš—å½±å€¼ - 1;
                è£…å¤‡å±æ€§ç»Ÿè®¡(Player);
                let æš—å½±Buff = Player.AddIntervalBuff(1, TBuffIntervalType.biNone, 0, 0, 0, 0);
                Player.SetBuffIcon(æš—å½±Buff.Handle, 'magicon.wzl', 2312, 2312, '', '', `{S=å½“å‰æš—å½±å€¼: ${R.æš—å½±å€¼} ç‚¹}`, true, true);
                // å¯¹å‘¨å›´æ•Œäººé€ æˆä¼¤å®³
                const èŒƒå›´ = 6 + (R.æš—å½±å‰”éª¨èŒƒå›´ || 0);
                const ç›®æ ‡åˆ—è¡¨ = è·å–ç©å®¶èŒƒå›´å†…ç›®æ ‡(Player, èŒƒå›´);
                for (const ç›®æ ‡ of ç›®æ ‡åˆ—è¡¨) {
                    Player.Damage(ç›®æ ‡, 1, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.æš—å½±.æš—å½±å‰”éª¨);
                }
            }
        }
    }

    // ============================================================
    // ==================== çƒˆç„°èŒä¸š ====================
    // ============================================================
    if (V.èŒä¸š === 'çƒˆç„°' && !Player.InSafeZone) {

        // ---------- ç«ç„°è¿½è¸ªï¼šå¯¹å‘¨å›´10ç å†…æœ€è¿‘çš„æ•Œäººæ–½æ³•ï¼ˆæ¯ç§’ï¼‰ ----------
        if (V.è‡ªåŠ¨_ç«ç„°è¿½è¸ª) {
            Magic = Player.FindSkill('ç«ç„°è¿½è¸ª');
            if (Magic) {
                const æœ€è¿‘ç›®æ ‡ = è·å–å‘¨å›´æœ€è¿‘ç›®æ ‡(Player, 10);
                if (æœ€è¿‘ç›®æ ‡) {
                    Player.MagicAttack(æœ€è¿‘ç›®æ ‡, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.çƒˆç„°.ç«ç„°è¿½è¸ª);
                }
            }
        }

        if (V.è‡ªåŠ¨_çƒˆç„°æŠ¤ç”²) {
            if (!Player.R.çƒˆç„°æŠ¤ç”²) {
                Player.R.çƒˆç„°æŠ¤ç”² = true;
                Player.SetCustomEffect(åŸºç¡€å¸¸é‡.æ°¸ä¹…ç‰¹æ•ˆ.çƒˆç„°æŠ¤ç”², åŸºç¡€å¸¸é‡.ç‰¹æ•ˆ.çƒˆç„°æŠ¤ç”²);
                Player.SendMessage('çƒˆç„°æŠ¤ç”²å¼€å¯', 2);
            }
        }
        // ---------- çƒˆç„°æŠ¤ç”²ï¼šæŒç»­æ•ˆæœï¼ˆæ¯2ç§’ï¼‰ ----------
        // æè¿°ï¼šå¼€å¯å,æ¯2ç§’å¯¹å‘¨å›´4æ ¼å†…çš„ç›®æ ‡é€ æˆ300%ä¼¤å®³,æ¯çº§æé«˜30%
        if (R.çƒˆç„°æŠ¤ç”² && R.æ–½æ³•è¯»ç§’ % 2 === 0) {
            AActorList = Player.Map.GetActorListInRange(Player.MapX, Player.MapY, 4);
            for (let i = 0; i < AActorList.Count; i++) {
                const Actor = AActorList.Actor(i);
                if (Actor && !Actor.GetDeath() && !Actor.IsNPC() && Actor.GetHandle() !== Player.GetHandle() && !Actor.IsPlayer() && !Actor.Master) {
                    // Actor.ShowEffectEx2(åŸºç¡€å¸¸é‡.ç‰¹æ•ˆ.çƒˆç„°æŠ¤ç”², -10, 20, true, 1);
                    Player.Damage(Actor, 1, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.çƒˆç„°.çƒˆç„°æŠ¤ç”²);
                }
            }
        }
    }

    // ============================================================
    // ==================== æ­£ä¹‰èŒä¸š ====================
    // ============================================================
    if (V.èŒä¸š === 'æ­£ä¹‰' && !Player.InSafeZone) {

        if (V.è‡ªåŠ¨_æ­£ä¹‰ && !Player.R.åœ£å…‰) {
            Player.R.åœ£å…‰ = true;
            Player.SetCustomEffect(åŸºç¡€å¸¸é‡.æ°¸ä¹…ç‰¹æ•ˆ.åœ£å…‰, åŸºç¡€å¸¸é‡.ç‰¹æ•ˆ.åœ£å…‰);
            Player.SendMessage('åœ£å…‰å…‰ç¯å¼€å¯', 2);
        }
        // ---------- åœ£å…‰ï¼ˆæ­£ä¹‰å…‰ç¯ï¼‰ï¼šæŒç»­æ•ˆæœï¼ˆæ¯ç§’ï¼‰ ----------
        // æè¿°ï¼šå¼€å¯å,æ¯ç§’å¯¹å‘¨å›´5ç å†…æ‰€æœ‰ç›®æ ‡é€ æˆ200%ä¼¤å®³,æ¯çº§æé«˜20%
        if (R.åœ£å…‰) {
            const èŒƒå›´ = 6 + (R.æ­£ä¹‰èŒƒå›´ || 0);
            const ç›®æ ‡åˆ—è¡¨ = è·å–ç©å®¶èŒƒå›´å†…ç›®æ ‡(Player, èŒƒå›´);
            for (const ç›®æ ‡ of ç›®æ ‡åˆ—è¡¨) {
                // ç›®æ ‡.ShowEffectEx2(åŸºç¡€å¸¸é‡.ç‰¹æ•ˆ.åœ£å…‰, -10, 20, true, 1);
                Player.Damage(ç›®æ ‡, 1, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.æ­£ä¹‰.åœ£å…‰);
            }
        }
    }

    // ============================================================
    // ==================== ä¸åŠ¨èŒä¸š ====================
    // ============================================================
    if (V.èŒä¸š === 'ä¸åŠ¨' && !Player.InSafeZone) {
        // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šæ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé¿å…undefinedå¯¼è‡´çš„é”™è¯¯
        const æŠ¤ç›¾å€¼ = Player.R.äººç‹ç›¾æŠ¤ç›¾å€¼ || '0'
        let æš—å½±çŒå– = Player.AddIntervalBuff(1, TBuffIntervalType.biNone, 0, 0, 0, 0)
        Player.SetBuffIcon(æš—å½±çŒå–.Handle, 'magicon.wzl', 2201, 2201, ``, '', `{S=å½“å‰äººç‹ç›¾: }{S=${å¤§æ•°å€¼æ•´æ•°ç®€å†™(æŠ¤ç›¾å€¼)};C=21}{S= ç‚¹}`, true, true)
        // ---------- äººç‹ç›¾ï¼šè‡ªåŠ¨é‡Šæ”¾ ----------
        // æ¡ä»¶ï¼šå¼€å¯è‡ªåŠ¨æ–½æ³• ä¸” æŠ¤ç›¾å€¼ä¸º0æ—¶è‡ªåŠ¨é‡Šæ”¾
        if (R.äººç‹ç›¾è‡ªåŠ¨æ–½æ³• && !Player.R.äººç‹ç›¾å¼€å¯) {
            R.äººç‹ç›¾CD ??= 0;
            R.äººç‹ç›¾CD++;
            if (R.äººç‹ç›¾CD >= 10) {
                R.äººç‹ç›¾CD = 0;
                Magic = Player.FindSkill('äººç‹ç›¾');
                if (Magic) {
                    Player.R.äººç‹ç›¾å¼€å¯ = true;
                    Player.MagicAttack(Player, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.ä¸åŠ¨.äººç‹ç›¾);

                }
            }
        }
        // ---------- é‡‘åˆšæŒï¼šå¯¹å‘¨å›´8ç å†…æœ€è¿‘çš„æ•Œäººæ–½æ³• ----------
        if (R.é‡‘åˆšæŒè‡ªåŠ¨æ–½æ³•) {
            Magic = Player.FindSkill('é‡‘åˆšæŒ');
            if (Magic) {
                const æœ€è¿‘ç›®æ ‡ = è·å–å‘¨å›´æœ€è¿‘ç›®æ ‡(Player, 8);
                if (æœ€è¿‘ç›®æ ‡) {
                    Player.MagicAttack(æœ€è¿‘ç›®æ ‡, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.ä¸åŠ¨.é‡‘åˆšæŒ);
                }
            }
        }

        // ---------- å¦‚å±±ï¼šæŒç»­æ•ˆæœï¼ˆæ¯ç§’ï¼‰ ----------
        // æè¿°ï¼šå¼€å¯å,æ¯ç§’å¯¹å‘¨å›´5ç å†…é€ æˆ400%ä¼¤å®³,æ¯çº§æé«˜40%
        if (R.å¦‚å±±) {
            const èŒƒå›´ = 5 + (R.å¦‚å±±èŒƒå›´ || 0);
            const ç›®æ ‡åˆ—è¡¨ = è·å–ç©å®¶èŒƒå›´å†…ç›®æ ‡(Player, èŒƒå›´);
            for (const ç›®æ ‡ of ç›®æ ‡åˆ—è¡¨) {
                Player.Damage(ç›®æ ‡, 1, åŸºç¡€å¸¸é‡.æŠ€èƒ½ID.ä¸åŠ¨.å¦‚å±±);
            }
        }
    }
}





//ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»
export function å–ä¸¤ç‚¹è·ç¦»(x1: number, y1: number, x2: number, y2: number): number {
    let dx: number, dy: number
    dx = x1 - x2;
    dy = y1 - y2;
    return Math.sqrt(dx * dx + dy * dy);
}

/**
 * è·å–ç©å®¶å‘¨å›´æŒ‡å®šèŒƒå›´å†…æœ€è¿‘çš„ä¸€ä¸ªç›®æ ‡
 * @param Player ç©å®¶å¯¹è±¡
 * @param èŒƒå›´ æœç´¢èŒƒå›´ï¼ˆç ï¼‰
 * @returns æœ€è¿‘çš„ç›®æ ‡ï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™è¿”å›null
 */
export function è·å–å‘¨å›´æœ€è¿‘ç›®æ ‡(Player: TPlayObject, èŒƒå›´: number): TActor | null {
    if (èŒƒå›´ <= 0) return null;

    const AActorList = Player.Map.GetActorListInRange(Player.MapX, Player.MapY, èŒƒå›´);
    let æœ€è¿‘ç›®æ ‡: TActor | null = null;
    let æœ€è¿‘è·ç¦» = Infinity;
    const playerHandle = Player.GetHandle();

    for (let i = 0; i < AActorList.Count; i++) {
        const Actor = AActorList.Actor(i);
        if (Actor && !Actor.GetDeath() && !Actor.IsNPC() && Actor.GetHandle() !== playerHandle && !Actor.IsPlayer() && !Actor.Master) {
            const è·ç¦» = å–ä¸¤ç‚¹è·ç¦»(Player.MapX, Player.MapY, Actor.MapX, Actor.MapY);
            if (è·ç¦» < æœ€è¿‘è·ç¦») {
                æœ€è¿‘è·ç¦» = è·ç¦»;
                æœ€è¿‘ç›®æ ‡ = Actor;
            }
        }
    }

    return æœ€è¿‘ç›®æ ‡;
}
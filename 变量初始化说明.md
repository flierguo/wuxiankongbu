# 变量初始化说明文档

## 概述
本文档说明了项目中变量初始化的统一管理方案，避免 `undefined` 导致的运行时错误。

## 已修复的问题

### 1. 核心计算函数空值检查
**文件**: `_大数值/核心计算方法.ts`
**修复**: 在 `智能计算` 函数开头添加空值检查
```typescript
if (!n1 || n1 === '' || n1 === 'undefined' || n1 === 'null') {
    n1 = '0'
}
if (!n2 || n2 === '' || n2 === 'undefined' || n2 === 'null') {
    n2 = '0'
}
```

### 2. 大数值整数简写空值检查
**文件**: `_核心部分/字符计算.ts`
**修复**: 在 `大数值整数简写` 函数开头添加空值检查
```typescript
if (!num || num === '' || num === 'undefined' || num === 'null') {
    return '0'
}
```

### 3. 神器统计变量初始化
**文件**: `_核心部分/_装备/神器统计.ts`
**修复**: 在调用 `智能计算` 时添加默认值
- `Player.R.全体魔次 || '0'`
- `Player.R.神器增伤加成 || '0'`

### 4. 人王盾护盾值初始化
**文件**: `系统固定NPC/RobotManageNpc.ts`
**修复**: 在显示护盾值前添加默认值
```typescript
const 护盾值 = Player.R.人王盾护盾值 || '0'
```

## 统一初始化函数

### 位置
`_核心部分/_玩家/登录触发.ts` - `自定义变量` 函数

### 调用时机
1. 玩家登录时 (`PlayerRegister` 函数)
2. 玩家注册时 (`GiveNewPlayer` 函数)

### 初始化的变量分类

#### 1. 基础属性 (Player.R)
- 生命、防御、攻击、魔法、道术、射术、刺术、武术
- 各属性百分比倍数
- 自定属性数组 (161-168)

#### 2. 技能相关 (Player.V / Player.R)
- 43个技能的等级、魔次、范围、自动施法、CD
- 技能开启状态（血气燃烧、血魔临身等）
- 职业魔次加成（天枢、血神、暗影、烈焰、正义、不动）
- 全体魔次加成

#### 3. 神器相关 (Player.R)
- 六大基因阶数（狂化、迅疾、甲壳、融合、念力、协作）
- 暴击几率、暴击伤害、无视防御、基因增加伤害
- 神器爆率加成、神器回收加成、神器增伤加成
- 基因锁等级

#### 4. 战斗相关 (Player.R)
- 暴击倍率、伤害吸收
- 人王盾护盾值、人王盾开启状态

#### 5. 爆率回收相关 (Player.R)
- 爆率加成、经验加成、鞭尸几率、鞭尸次数
- 极品倍率、最终极品倍率
- 回收倍率、最终回收倍率
- 最终爆率加成、最终鞭尸次数
- 本职装备几率

#### 6. 圣耀副本相关 (Player.R)
- 圣耀地图爆率加成
- 圣耀副本倍率
- 圣耀副本爆率加成

#### 7. 玩家状态 (Player.V)
- 职业状态（暴怒、血神、暗影、烈焰、正义、不动）
- 血统、血统等级
- 基因类型
- 今日神器回收次数
- 主神津贴状态
- 捐献点数

#### 8. 宣传赞助 (Player.V)
- 宣传爆率、宣传回收、宣传极品率、宣传次数
- 赞助爆率、赞助回收、赞助极品、赞助鞭尸、赞助极品率

#### 9. 其他功能 (Player.V)
- 幸运值
- 全屏拾取、自动拾取、自动回收、自动存材料
- 时装、种族、职业
- 我要秒怪
- 经验等级、杀怪数量

#### 10. 性能计数器 (Player.R)
- 性能计数器（用于定时器优化）

## 最佳实践

### 1. 使用 `??=` 运算符
```typescript
// ✅ 推荐：只在未定义时赋值
Player.R.全体魔次 ??= '0'

// ❌ 不推荐：每次都赋值
Player.R.全体魔次 = '0'
```

### 2. 调用前添加默认值保护
```typescript
// ✅ 推荐：调用时提供默认值
智能计算(Player.R.全体魔次 || '0', 魔次值, 1)

// ❌ 不推荐：直接使用可能为undefined的值
智能计算(Player.R.全体魔次, 魔次值, 1)
```

### 3. 函数参数空值检查
```typescript
// ✅ 推荐：在函数开头检查参数
export function 智能计算(n1: string, n2: string, mode: number): string {
    if (!n1 || n1 === '' || n1 === 'undefined' || n1 === 'null') {
        n1 = '0'
    }
    // ... 其他逻辑
}
```

## 注意事项

1. **登录时自动初始化**: 所有玩家登录时都会调用 `自定义变量` 函数，确保变量有默认值
2. **属性统计时重置**: `装备属性统计` 函数会重置部分变量，然后重新计算
3. **性能优化**: 使用 `??=` 运算符只在未定义时赋值，避免重复赋值
4. **类型安全**: 大数值相关变量统一使用字符串类型 `'0'`，数值类型使用 `0`

## 相关文件

- `_大数值/核心计算方法.ts` - 核心计算函数
- `_核心部分/字符计算.ts` - 字符串处理函数
- `_核心部分/_玩家/登录触发.ts` - 玩家初始化
- `_核心部分/_装备/属性统计.ts` - 装备属性统计
- `_核心部分/_装备/神器统计.ts` - 神器属性统计
- `系统固定NPC/RobotManageNpc.ts` - 定时器管理

## 更新日志

### 2025-01-29
- 修复 `智能计算` 函数空值检查
- 修复 `大数值整数简写` 函数空值检查
- 优化 `自定义变量` 函数，添加更完善的初始化逻辑
- 修复神器统计中的未初始化变量
- 修复人王盾护盾值显示问题
- 移除高频BUFF事件中的装备属性统计调用

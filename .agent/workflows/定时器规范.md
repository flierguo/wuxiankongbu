---
description: 定时器/延时调用的使用规范，包含秒级和毫秒级定时器的用法
---
## 定时器规范

在编写需要定时执行或延时调用的功能时，请参考以下规范：

### 定时器类型对比

| 方法 | 时间单位 | 可循环 | 适用场景 |
|------|----------|--------|----------|
| `DelayGoto` | **秒** | ✅ 是 | 需要反复执行的定时任务（如每秒回血） |
| `DelayGotoMS` | **毫秒** | ✅ 是 | 需要更精细控制的反复执行任务 |
| `DelayCallMethod` | **毫秒** | ❌ 一次性 | 一次性延时调用，执行后自动删除 |

---

### 1. DelayGoto（秒级定时器）

**特点**: 时间单位为秒，可反复执行，需要在 `TimeManageNpc.ts` 中实现回调

**使用方式**:
```typescript
// 启动定时器
// 参数: 时钟ID, 执行间隔(秒), 切换地图是否失效, 是否只执行一次
Player.DelayGoto(100, 60, true, false);  // 每60秒执行一次，切换地图失效

// 启动只执行一次的定时器
Player.DelayGoto(101, 60, false, true);  // 60秒后执行一次，切换地图不失效

// 停止定时器
Player.ClearDelayGoto(100);

// 检查是否有定时器
GameLib.HasDelayGoto(100);
Player.HasDelayGoto(100);
```

**回调实现** (在 `TimeManageNpc.ts` 中):
```typescript
GameLib.onPrivyEventExecute = (Player: TPlayObject, TimeID: number): void => {
    switch (TimeID) {
        case 100:
            // 定时器ID 100 的处理逻辑
            break;
        case 101:
            // 定时器ID 101 的处理逻辑
            break;
    }
}
```

---

### 2. DelayGotoMS（毫秒级定时器）

**特点**: 时间单位为毫秒，用于需要更精细控制的场景

**使用方式**:
```typescript
// 参数: 时钟ID, 执行间隔(毫秒), 切换地图是否失效, 是否只执行一次
Actor.DelayGotoMS(100, 500, true, false);  // 每500毫秒执行一次
```

**回调实现**: 同 `DelayGoto`，在 `TimeManageNpc.ts` 中处理

---

### 3. DelayCallMethod（毫秒级延时调用）

**特点**: 时间单位为毫秒，一次性执行后自动删除，**推荐用于技能效果**

**使用方式**:
```typescript
// 延时调用指定函数
// 参数: 函数名(单元名.函数名), 延迟时间(毫秒), 切换地图是否删除
Player.DelayCallMethod('MagicNpc.天雷阵效果', 500, false);

// 删除延时调用（在不需要时主动取消）
Player.DeleteDelayCallMethod('MagicNpc.天雷阵效果');
```

**回调函数定义**:
```typescript
// 在对应的单元文件中定义函数（如 MagicNpc.ts）
export function 天雷阵效果(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 执行逻辑
}
```

**实现循环效果**（模拟持续技能）:
```typescript
export function 天雷阵效果(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 检查技能是否仍然开启
    if (!Player.R.天雷阵开启) return;
    
    // 执行技能效果（对周围造成伤害等）
    const 目标列表 = 获取玩家范围内目标(Player, 3);
    for (const 目标 of 目标列表) {
        Player.Damage(目标, 1, 技能ID.基础技能.天雷阵);
    }
    
    // 500毫秒后再次执行（实现循环）
    Player.DelayCallMethod('MagicNpc.天雷阵效果', 500, true);
}

// 开启技能时启动循环
export function 天雷阵开启(Player: TPlayObject): void {
    Player.R.天雷阵开启 = true;
    Player.DelayCallMethod('MagicNpc.天雷阵效果', 500, true);
}

// 关闭技能时停止循环
export function 天雷阵关闭(Player: TPlayObject): void {
    Player.R.天雷阵开启 = false;
    Player.DeleteDelayCallMethod('MagicNpc.天雷阵效果');
}
```

---

### 常用定时器ID规划

| ID范围 | 用途 |
|--------|------|
| 1-99 | 系统定时器（如自动保存、全服公告等） |
| 100-199 | 玩家状态定时器（如BUFF效果、持续技能等） |
| 200-299 | 副本/活动定时器 |
| 300+ | 预留 |

---

### 注意事项

1. **避免ID冲突**: 不同功能使用不同的定时器ID
2. **及时清理**: 功能结束时记得调用 `ClearDelayGoto` 或 `DeleteDelayCallMethod`
3. **切换地图处理**: 根据需求设置是否在切换地图时失效
4. **性能考虑**: 毫秒级定时器间隔不要设置过小（建议 >= 200ms）

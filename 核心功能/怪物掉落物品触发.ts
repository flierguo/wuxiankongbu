// =================================== 导入依赖 ===================================
import { js_numberRandom, js_numberRandom2 } from "../全局脚本[公共单元]/utils/计算方法"
import { js_number, js_war } from "../全局脚本[公共单元]/utils/计算方法_优化版"
import { TAG, 怪物颜色 } from "../功能脚本组/[怪物]/_M_Base"
import { 随机小数 } from "../功能脚本组/[服务]/延时跳转"


import {
    基础属性分割,
    基础属性第一条,
    基础属性第十条,
    尾部名字,
    职业分割,
    职业第一条,
    装备特效,
    装备颜色,
    装备需求
} from "../功能脚本组/[装备]/_ITEM_Base"
import { 数字转单位2, 数字转单位3 } from "./字符计算"
import * as 地图 from '../_核心部分/_地图/地图';

// =================================== 类型定义 ===================================
interface 装备属性记录 {
    职业属性_职业: number[]
    职业属性_属性: string[]
    职业属性_生肖: string[]
}

interface 装备生成上下文 {
    翻倍: number
    基础极品倍率: number
    技能极品倍率: number
    末尾: string
    颜色: number
    星星数量: string
    装备属性记录: 装备属性记录
}

interface 职业属性上下文 extends 装备生成上下文 {
    职业: string
    职业技能条数: number
    Monster: TActor
    下面几率: number
}

// 装备品质枚举
enum 装备品质 {
    普通 = 1,
    精良 = 2,
    优秀 = 3,
    稀有 = 4,
    史诗 = 5,
    传说 = 6,
    神话 = 7,
    远古 = 8,
    不朽 = 9
}

// 怪物品质枚举
enum 怪物品质 {
    蝼蚁白 = 1,
    平凡绿 = 2,
    野蛮浅绿 = 3,
    劲敌蓝 = 4,
    精英黄 = 5,
    骑士橙 = 6,
    头领紫 = 7,
    深渊粉 = 8,
    洪荒灰 = 9,
    灭世BOSS红 = 10
}

// =================================== 游戏配置常量 ===================================

// 常量定义
const CONSTANTS = {
    // 有效装备类型
    VALID_EQUIPMENT_TYPES: [5, 6, 10, 11, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 68, 35],

    // 神器几率阈值
    ARTIFACT_THRESHOLD: 2,

    // 神器倍数范围
    ARTIFACT_MULTIPLIER_RANGE: 20,

    // 极品几率计算常量
    EXCELLENT_CHANCE_BASE: 20,
    EXCELLENT_RANDOM_RANGE: 2000,

    // 随机波动系数
    LEVEL_VARIATION: { min: 0.9, max: 1.2 },

    // 技能翻倍值衰减
    SKILL_MULTIPLIER_DECAY: 1.2
} as const

// 优化：将地图等级配置提取为常量，避免每次函数调用时重新创建对象
const 地图等级配置: Record<string, number> = {
    '荒芜山谷': 1,
    '试炼之地': 40,
    '血之炼狱': 100,
    '竞技洞窟': 150,
    '血路之颠': 200,  //1大陆
    '沙漠绿洲': 300,
    '凄凉之地': 450,
    '狂风峭壁': 600,
    '崎岖索道': 750,
    '风暴峡谷': 900,  //2大陆
    '古船遗迹': 1100,
    '森林迷宫': 1300,
    '古之城墙': 1500,
    '暗影迷宫': 1800,
    '失落暗殿': 2000,  //3大陆
    '神秘古国': 2200,
    '海岛遗迹': 2400,
    '魔之莽道': 2600,
    '盘蛇古迹': 2800,
    '泗水祭坛': 3000,  //4大陆
    '铁血魔域': 3200,
    '血腥森林': 3400,
    '蛮荒丛林': 3600,
    '血狱皇陵': 3800,
    '星空廊道': 4000,  //5大陆
    '黑暗森林': 4200,
    '郊外平原': 4400,
    '天然洞穴': 4600,
    '矿区山谷': 4800,
    '祖玛回廊': 5000,
    '万妖森林': 5200,
    '万妖峡谷': 5400,
    '万妖之巢': 5600,
    '万妖迷宫': 5800,
    '万妖祭坛': 6000,
    '邪恶洞穴': 6200,
    '蛇妖山谷': 6400,
    '沃玛寺庙': 6600,
    '暗黑蛇谷': 6800,
    '沉息之地': 7000,
    '神域冰谷': 7200,
    '纷争之地': 7400,
    '上古禁地': 7600,
    '封印之城': 7800,
    '神庙主殿': 8000,
} as const;

/**
 * 根据地图名获取掉落等级
 * @param mapName 地图名称
 * @returns 掉落等级
 */
function 获取地图掉落等级(mapName: string): number {
    // 优化：直接查找地图名中包含的关键词
    for (const key in 地图等级配置) {
        if (mapName.includes(key)) {
            return 地图等级配置[key];
        }
    }

    // 如果没有匹配到，使用默认计算方式
    const baseLevel = Math.min(100 + mapName.length * 30, 1000);
    return Math.max(40, baseLevel);
}
// 属性调整比例配置 - 根据装备等级调整属性值
const 属性调整比例配置 = [
    { maxLevel: 50, ratio: '1.5' },       // 一大陆
    { maxLevel: 100, ratio: '1.2' },      // 一大陆
    { maxLevel: 200, ratio: '1' },       // 一大陆
    { maxLevel: 1000, ratio:  '0.9' },    // 二大陆
    { maxLevel: 2000, ratio:  '0.5' },    // 三大陆
    { maxLevel: 3000, ratio:  '0.05' },    // 四大陆
    { maxLevel: 4000, ratio:  '0.01' },    // 五大陆
    { maxLevel: 5000, ratio:  '0.005' },    // 六大陆
    { maxLevel: 6000, ratio:  '0.0001' },   // 七大陆
    { maxLevel: 7000, ratio:  '0.00005' },   // 八大陆
    { maxLevel: 8000, ratio:  '0.00001' },   // 九大陆
    { maxLevel: 9000, ratio:  '0.000005' },   // 十大陆
    { maxLevel: 10000, ratio: '0.000000005' },
    { maxLevel: Infinity, ratio: '0.0000000000000000000001' }
] as const

const 职业列表 = [
    '战神', '骑士', '火神', '冰法', '驯兽师', '牧师',
    '刺客', '鬼舞者', '神射手', '猎人', '武僧', '罗汉'
] as const

// 怪物品质与装备品质对应关系配置
const 怪物品质装备掉落配置 = {
    [怪物品质.蝼蚁白]: {
        可掉落品质: [装备品质.普通, 装备品质.精良, 装备品质.优秀, 装备品质.稀有, 装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: { // 基础几率，会受Player.R.极品率影响
            [装备品质.普通]: 1000,
            [装备品质.精良]: 500,
            [装备品质.优秀]: 300,
            [装备品质.稀有]: 100,
            [装备品质.史诗]: 50,
            [装备品质.传说]: 20,
            [装备品质.神话]: 10,
            [装备品质.远古]: 5,
            [装备品质.不朽]: 1
        },
        翻倍几率: 1,
        白条数几率: 1
    },
    [怪物品质.平凡绿]: {
        可掉落品质: [装备品质.普通, 装备品质.精良, 装备品质.优秀, 装备品质.稀有, 装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: {
            [装备品质.普通]: 900,
            [装备品质.精良]: 600,
            [装备品质.优秀]: 400,
            [装备品质.稀有]: 150,
            [装备品质.史诗]: 70,
            [装备品质.传说]: 30,
            [装备品质.神话]: 15,
            [装备品质.远古]: 8,
            [装备品质.不朽]: 1
        },
        翻倍几率: 1.2,
        白条数几率: 1.2
    },
    [怪物品质.野蛮浅绿]: {
        可掉落品质: [装备品质.精良, 装备品质.优秀, 装备品质.稀有, 装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: {
            [装备品质.精良]: 700,
            [装备品质.优秀]: 500,
            [装备品质.稀有]: 200,
            [装备品质.史诗]: 100,
            [装备品质.传说]: 50,
            [装备品质.神话]: 25,
            [装备品质.远古]: 12,
            [装备品质.不朽]: 1
        },
        翻倍几率: 1.5,
        白条数几率: 1.5
    },
    [怪物品质.劲敌蓝]: {
        可掉落品质: [装备品质.精良, 装备品质.优秀, 装备品质.稀有, 装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: {
            [装备品质.精良]: 600,
            [装备品质.优秀]: 550,
            [装备品质.稀有]: 250,
            [装备品质.史诗]: 150,
            [装备品质.传说]: 80,
            [装备品质.神话]: 40,
            [装备品质.远古]: 20,
            [装备品质.不朽]: 1
        },
        翻倍几率: 1.8,
        白条数几率: 1.8
    },
    [怪物品质.精英黄]: {
        可掉落品质: [装备品质.优秀, 装备品质.稀有, 装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: {
            [装备品质.优秀]: 600,
            [装备品质.稀有]: 300,
            [装备品质.史诗]: 200,
            [装备品质.传说]: 100,
            [装备品质.神话]: 50,
            [装备品质.远古]: 25,
            [装备品质.不朽]: 1
        },
        翻倍几率: 2,
        白条数几率: 2
    },
    [怪物品质.骑士橙]: {
        可掉落品质: [装备品质.优秀, 装备品质.稀有, 装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: {
            [装备品质.优秀]: 500,
            [装备品质.稀有]: 400,
            [装备品质.史诗]: 250,
            [装备品质.传说]: 150,
            [装备品质.神话]: 80,
            [装备品质.远古]: 40,
            [装备品质.不朽]: 1
        },
        翻倍几率: 2.3,
        白条数几率: 2.3
    },
    [怪物品质.头领紫]: {
        可掉落品质: [装备品质.稀有, 装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: {
            [装备品质.稀有]: 500,
            [装备品质.史诗]: 300,
            [装备品质.传说]: 200,
            [装备品质.神话]: 100,
            [装备品质.远古]: 50,
            [装备品质.不朽]: 1
        },
        翻倍几率: 2.6,
        白条数几率: 2.6
    },
    [怪物品质.深渊粉]: {
        可掉落品质: [装备品质.稀有, 装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: {
            [装备品质.稀有]: 400,
            [装备品质.史诗]: 350,
            [装备品质.传说]: 250,
            [装备品质.神话]: 150,
            [装备品质.远古]: 80,
            [装备品质.不朽]: 2
        },
        翻倍几率: 3,
        白条数几率: 3
    },
    [怪物品质.洪荒灰]: {
        可掉落品质: [装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: {
            [装备品质.史诗]: 400,
            [装备品质.传说]: 300,
            [装备品质.神话]: 200,
            [装备品质.远古]: 100,
            [装备品质.不朽]: 3
        },
        翻倍几率: 3.5,
        白条数几率: 3.5
    },
    [怪物品质.灭世BOSS红]: {
        可掉落品质: [装备品质.史诗, 装备品质.传说, 装备品质.神话, 装备品质.远古, 装备品质.不朽],
        品质几率: {
            [装备品质.史诗]: 300,
            [装备品质.传说]: 350,
            [装备品质.神话]: 250,
            [装备品质.远古]: 150,
            [装备品质.不朽]: 5
        },
        翻倍几率: 4,
        白条数几率: 4
    }
};

// 装备品质翻倍值配置
const 装备品质翻倍值配置 = {
    [装备品质.普通]: { min: 1, max: 5 },
    [装备品质.精良]: { min: 2, max: 10 },
    [装备品质.优秀]: { min: 3, max: 15 },
    [装备品质.稀有]: { min: 4, max: 20 },
    [装备品质.史诗]: { min: 5, max: 25 },
    [装备品质.传说]: { min: 6, max: 30 },
    [装备品质.神话]: { min: 7, max: 35 },
    [装备品质.远古]: { min: 8, max: 40 },
    [装备品质.不朽]: { min: 10, max: 50 }
};

// 白色条数配置，范围1-6，随装备品质提高而增多
const 白色条数配置 = {
    普通: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3],
    精良: [1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3],
    优秀: [1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4],
    稀有: [1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4],
    史诗: [1, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5],
    传说: [2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5],
    神话: [2, 2, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 6],
    远古: [2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6],
    不朽: [3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6],
};

// 职业属性词条数配置，范围0-6，随装备品质提高而增多
const 职业属性词条数 = {
    普通: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4],
    精良: [1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4],
    优秀: [1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4],
    稀有: [2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5],
    史诗: [2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6],
    传说: [2, 2, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 6],
    神话: [3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 6, 6, 6],
    远古: [3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6],
    不朽: [3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6],

};

// 装备品质与装备颜色的映射
const 装备品质颜色映射 = {
    [装备品质.普通]: 装备颜色.普通颜色,
    [装备品质.精良]: 装备颜色.精良颜色,
    [装备品质.优秀]: 装备颜色.优秀颜色,
    [装备品质.稀有]: 装备颜色.稀有颜色,
    [装备品质.史诗]: 装备颜色.史诗颜色,
    [装备品质.传说]: 装备颜色.传说颜色,
    [装备品质.神话]: 装备颜色.神话颜色,
    [装备品质.远古]: 装备颜色.远古颜色,
    [装备品质.不朽]: 装备颜色.不朽颜色
};

// 装备品质与白色条数数组的映射
const 装备品质白条映射 = {
    [装备品质.普通]: 白色条数配置.普通,
    [装备品质.精良]: 白色条数配置.精良,
    [装备品质.优秀]: 白色条数配置.优秀,
    [装备品质.稀有]: 白色条数配置.稀有,
    [装备品质.史诗]: 白色条数配置.史诗,
    [装备品质.传说]: 白色条数配置.传说,
    [装备品质.神话]: 白色条数配置.神话,
    [装备品质.远古]: 白色条数配置.远古,
    [装备品质.不朽]: 白色条数配置.不朽
};

// 装备品质与职业属性词条数组的映射
const 装备品质职业词条映射 = {
    [装备品质.普通]: 职业属性词条数.普通,
    [装备品质.精良]: 职业属性词条数.精良,
    [装备品质.优秀]: 职业属性词条数.优秀,
    [装备品质.稀有]: 职业属性词条数.稀有,
    [装备品质.史诗]: 职业属性词条数.史诗,
    [装备品质.传说]: 职业属性词条数.传说,
    [装备品质.神话]: 职业属性词条数.神话,
    [装备品质.远古]: 职业属性词条数.远古,
    [装备品质.不朽]: 职业属性词条数.不朽
};

const 颜色配置: Record<number, any> = {};

// 混沌颜色配置
颜色配置[装备颜色.不朽颜色] = {
    翻倍范围: { min: 20, max: 80 },
    下面几率: 50,
    特效: 装备特效.混沌颜色,
    白条数组: 白色条数配置.不朽,
    职业词条数组: 职业属性词条数.不朽
};

// 造化颜色配置
颜色配置[装备颜色.远古颜色] = {
    翻倍范围: { min: 1, max: 1 },
    下面几率: 35,
    特效: 装备特效.远古颜色,
    白条数组: 白色条数配置.远古,
    职业词条数组: 职业属性词条数.远古
};

// 神话颜色配置
颜色配置[装备颜色.神话颜色] = {
    翻倍范围: { min: 1, max: 1 },
    下面几率: 30,
    特效: 装备特效.神话颜色,
    白条数组: 白色条数配置.神话,
    职业词条数组: 职业属性词条数.神话
};

// 传说颜色配置
颜色配置[装备颜色.传说颜色] = {
    翻倍范围: { min: 1, max: 1 },
    下面几率: 25,
    特效: 装备特效.传说颜色,
    白条数组: 白色条数配置.传说,
    职业词条数组: 职业属性词条数.传说
};

// 史诗颜色配置
颜色配置[装备颜色.史诗颜色] = {
    翻倍范围: { min: 1, max: 1 },
    下面几率: 20,
    特效: 装备特效.史诗颜色,
    白条数组: 白色条数配置.史诗,
    职业词条数组: 职业属性词条数.史诗
};

// 稀有颜色配置
颜色配置[装备颜色.稀有颜色] = {
    翻倍范围: { min: 1, max: 1 },
    下面几率: 15,
    特效: 装备特效.稀有颜色,
    白条数组: 白色条数配置.稀有,
    职业词条数组: 职业属性词条数.稀有
};

// 优秀颜色配置
颜色配置[装备颜色.优秀颜色] = {
    翻倍范围: { min: 1, max: 1 },
    下面几率: 10,
    特效: 0,
    白条数组: 白色条数配置.优秀,
    职业词条数组: 职业属性词条数.优秀
};

// 精良颜色配置
颜色配置[装备颜色.精良颜色] = {
    翻倍范围: { min: 1, max: 1 },
    下面几率: 8,
    特效: 0,
    白条数组: 白色条数配置.精良,
    职业词条数组: 职业属性词条数.精良
};

// 普通颜色配置
颜色配置[装备颜色.普通颜色] = {
    翻倍范围: { min: 1, max: 1 },
    下面几率: 5,
    特效: 0,
    白条数组: 白色条数配置.普通,
    职业词条数组: 职业属性词条数.普通
};

// =================================== 工具函数 ===================================

/**
 * 设置装备属性
 * @param 物品 装备对象
 * @param 索引 属性索引
 * @param 属性ID 属性ID
 * @param 属性值 属性值
 * @param 记录 装备属性记录
 */
function 设置装备属性(物品: TUserItem, 索引: number, 属性ID: number, 属性值: string, 记录: 装备属性记录): void {
    const 计算位数 = (num: string) => num.toString().replace(/\.\d+/, '').length;
    // const 新位数 = 属性值.e
    
    // 优化：缓存转换结果
    const 前端数字 = 数字转单位2(属性值);
    const 后端单位 = 数字转单位3(属性值);
    const 前端数字值 = Number(前端数字);
    const 后端单位值 = Number(后端单位);
    const 位数 = 计算位数(属性值)

    物品.SetOutWay1(索引, 属性ID);
    物品.SetOutWay2(索引, 前端数字值);
    物品.SetOutWay3(索引, 后端单位值);
    // if (位数 >= 16){
    物品.SetCustomValue(属性ID-30,位数)
    // }
    记录.职业属性_职业.push(属性ID);
    记录.职业属性_属性.push(属性值);

    console.log(`索引 : ${索引}  位数 : ${位数}` + ` 属性ID : ${属性ID}` + ` 属性值 : ${属性值}` )
}


/**
 * 获取属性调整比例
 * @param level 装备等级
 * @returns 调整比例字符串
 */
function 获取属性调整比例(level: number): string {
    // 优化：使用for循环代替find，性能更好
    for (const config of 属性调整比例配置) {
        if (level <= config.maxLevel) {
            return config.ratio;
        }
    }
    return '0.05';
}

/**
 * 初始化装备属性记录
 * @param UserItem 装备对象
 * @returns 装备属性记录对象，如果装备已处理完成则返回null
 */
function 初始化装备属性记录(UserItem: TUserItem): 装备属性记录 | null {
    const 现有描述 = UserItem.GetCustomDesc()

    if (现有描述 && 现有描述.length > 0) {
        try {
            const 装备属性记录 = JSON.parse(现有描述) as 装备属性记录
            // 如果装备已经处理过且有完整属性，则直接返回null（避免重复处理）
            if (装备属性记录.职业属性_职业?.length > 0 &&
                UserItem.DisplayName !== UserItem.Name) {
                return null
            }
            return 装备属性记录
        } catch (e) {
            // 解析失败，重新初始化
        }
    }

    // 返回新的记录对象
    return { 职业属性_职业: [], 职业属性_属性: [], 职业属性_生肖: [] }
}

/**
 * 计算极品倍率
 * @param 极品率 玩家极品率
 * @param 几率提升倍数 几率提升倍数，默认为1
 * @returns 基础和技能极品倍率
 */
function 计算极品倍率(极品率: number, 几率提升倍数: number = 1): { 基础极品倍率: number, 技能极品倍率: number } {
    const 极品几率 = ((极品率 > 20) ? 极品率 / 10 + CONSTANTS.EXCELLENT_CHANCE_BASE : CONSTANTS.EXCELLENT_CHANCE_BASE) * 几率提升倍数

    let 基础极品倍率 = 0

    let 技能极品倍率 = 0

    if (random(CONSTANTS.EXCELLENT_RANDOM_RANGE) < 极品几率) {
        基础极品倍率 = 1 + random(5 + Math.floor(极品率 / 50))
        技能极品倍率 = 1 + random(10 + Math.floor(极品率 / 100))
    }
    else {
        基础极品倍率 = 1
        技能极品倍率 = 1
    }

    return { 基础极品倍率, 技能极品倍率 }
}


/**
 * 根据装备品质获取末尾和颜色
 * @param 装备品质值 装备品质
 * @returns 末尾名称和颜色
 */
function 获取装备末尾和颜色(装备品质值: number): { 末尾: string, 颜色: number } {
    switch (装备品质值) {
        case 装备品质.不朽:
            return { 末尾: 尾部名字.不朽名字, 颜色: 装备颜色.不朽颜色 };
        case 装备品质.远古:
            return { 末尾: 尾部名字.远古名字, 颜色: 装备颜色.远古颜色 };
        case 装备品质.神话:
            return { 末尾: 尾部名字.神话名字, 颜色: 装备颜色.神话颜色 };
        case 装备品质.传说:
            return { 末尾: 尾部名字.传说名字, 颜色: 装备颜色.传说颜色 };
        case 装备品质.史诗:
            return { 末尾: 尾部名字.史诗名字, 颜色: 装备颜色.史诗颜色 };
        case 装备品质.稀有:
            return { 末尾: 尾部名字.稀有名字, 颜色: 装备颜色.稀有颜色 };
        case 装备品质.优秀:
            return { 末尾: 尾部名字.优秀名字, 颜色: 装备颜色.优秀颜色 };
        case 装备品质.精良:
            return { 末尾: 尾部名字.精良名字, 颜色: 装备颜色.精良颜色 };
        case 装备品质.普通:
        default:
            return { 末尾: 尾部名字.普通名字, 颜色: 装备颜色.普通颜色 };
    }
}

function 获取随机职业(player: TPlayObject): string {
    try {
        // 优化：缓存player.V和player.R
        const V = player.V;
        const R = player.R;

        const 职业触发 = 职业列表.find(z => V?.[z]);
        if (职业触发) {
            const 充值金额 = V?.真实充值 || 0;
            const rate = (充值金额 >= 10000) ? 200 : (充值金额 >= 1000 ? 50 : 10);
            const 本职几率 = R?.本职装备几率 || 0;
            if (random(1500) < rate + 本职几率) {
                return 职业触发;
            }
        }

        // 安全地获取随机职业
        const randomIndex = random(职业列表.length);
        return 职业列表[randomIndex] || '战神'; // 提供默认值
    } catch (error) {
        // 发生错误时返回默认职业
        return '战神';
    }
}

function 获取翻倍值(config: any, chance: number): number {
    // 不再使用翻倍几率表，直接返回1
    return 1;
}

// 专属符文属性已移除

// =================================== 辅助函数 End ===================================

/**
 * 根据怪物品质获取装备品质
 * @param 怪物品质值 怪物品质
 * @param 极品率 玩家极品率
 * @returns 选中的装备品质
 */
function 获取装备品质(怪物品质值: number, 极品率: number): number {
    // 优化：边界检查和默认值处理
    const 安全极品率 = Math.max(0, Math.min(极品率, 100000)); // 限制极品率范围
    const 怪物配置 = 怪物品质装备掉落配置[怪物品质值] || 怪物品质装备掉落配置[怪物品质.蝼蚁白];
    const 可掉落品质 = 怪物配置.可掉落品质;

    if (!可掉落品质 || 可掉落品质.length === 0) {
        return 装备品质.普通; // 安全默认值
    }

    // 根据极品率调整随机值
    const 调整因子 = Math.floor(安全极品率 / 100) + 1;
    const 随机值 = random(Math.max(1000, 3000 - 调整因子));

    // 优化：累计几率选择品质
    let 累计几率 = 0;
    const 品质几率 = 怪物配置.品质几率;
    for (const 品质 of 可掉落品质) {
        累计几率 += 品质几率[品质] || 0;
        if (随机值 <= 累计几率) {
            return 品质;
        }
    }

    // 默认返回第一个品质
    return 可掉落品质[0] || 装备品质.普通;
}

/**
 * 获取装备翻倍值
 * @param 装备品质值 装备品质
 * @param 怪物品质值 怪物品质
 * @returns 翻倍值
 */
function 获取装备翻倍值(装备品质值: number, 怪物品质值: number): number {
    // 获取基础翻倍值范围
    const 翻倍值范围 = 装备品质翻倍值配置[装备品质值] || { min: 1, max: 5 };

    // 获取怪物品质翻倍几率
    const 怪物配置 = 怪物品质装备掉落配置[怪物品质值] || 怪物品质装备掉落配置[怪物品质.蝼蚁白];
    const 翻倍几率 = 怪物配置.翻倍几率;

    // 计算实际翻倍值范围
    const 最小翻倍值 = Math.floor(翻倍值范围.min);
    const 最大翻倍值 = Math.floor(翻倍值范围.max);

    // 在范围内随机选择一个值
    return 最小翻倍值 + random(最大翻倍值 - 最小翻倍值);
}

/**
 * 获取白条数几率
 * @param 怪物品质值 怪物品质
 * @returns 白条数几率
 */
function 获取白条数几率(怪物品质值: number): number {
    const 怪物配置 = 怪物品质装备掉落配置[怪物品质值] || 怪物品质装备掉落配置[怪物品质.蝼蚁白];
    return 怪物配置.白条数几率;
}

/**
 * 获取怪物品质
 * @param 怪物颜色值 怪物颜色
 * @returns 怪物品质
 */
function 获取怪物品质(怪物颜色值: number): number {
    switch (怪物颜色值) {
        case 怪物颜色.蝼蚁白: return 怪物品质.蝼蚁白;
        case 怪物颜色.平凡绿: return 怪物品质.平凡绿;
        case 怪物颜色.野蛮浅绿: return 怪物品质.野蛮浅绿;
        case 怪物颜色.劲敌蓝: return 怪物品质.劲敌蓝;
        case 怪物颜色.精英黄: return 怪物品质.精英黄;
        case 怪物颜色.骑士橙: return 怪物品质.骑士橙;
        case 怪物颜色.头领紫: return 怪物品质.头领紫;
        case 怪物颜色.深渊粉: return 怪物品质.深渊粉;
        case 怪物颜色.洪荒灰: return 怪物品质.洪荒灰;
        case 怪物颜色.灭世BOSS红: return 怪物品质.灭世BOSS红;
        default: return 怪物品质.蝼蚁白;
    }
}

/**
 * 怪物掉落物品触发主函数
 * 
 * 该函数负责处理怪物掉落装备的属性生成，包括：
 * 1. 装备类型和怪物信息验证
 * 2. 装备品质和神器判定
 * 3. 基础属性和职业属性生成
 * 4. 神器倍数应用
 * 5. 装备重命名和最终处理
 * 
 * @param Player 玩家对象
 * @param Monster 怪物对象
 * @param UserItem 装备对象
 * @description 处理怪物掉落装备的属性生成
 */
export function 怪物掉落物品触发(Player: TPlayObject, Monster: TActor, UserItem: TUserItem): void {
    // 优化：验证装备类型和怪物信息
    if (!GameLib.R.怪物信息[`${Monster.Handle}`] ||
        !CONSTANTS.VALID_EQUIPMENT_TYPES.includes(UserItem.StdMode as any)) {
        return; // 无效装备或怪物信息，不处理
    }

    // 初始化或解析装备属性记录
    const 装备属性记录 = 初始化装备属性记录(UserItem);
    if (!装备属性记录) return; // 装备已处理完成或无法处理

    // 优化：缓存常用属性
    const PR = Player.R;
    const 地图名称 = 地图.ID取地图名(Monster.GetMapName());
    const 掉落等级 = 获取地图掉落等级(地图名称);
    const 属性调整比例 = 获取属性调整比例(掉落等级);

    // 计算怪物星级
    let 怪物星级 = js_number(Monster.GetSVar(94), 随机小数(0.05, 0.08).toFixed(2), 3);
    怪物星级 = js_number(怪物星级, '0.1', 3);

    const 取尾数 = Monster.GetNVar(TAG) % 10;

    // 优化：使用switch代替多个if-else
    switch (取尾数) {
        case 1:
            怪物星级 = js_number(怪物星级, String(随机小数(0.01, 0.05)), 3);
            break;
        case 2:
            怪物星级 = js_number(怪物星级, String(随机小数(0.02, 0.06)), 3);
            break;
        case 3:
            怪物星级 = js_number(怪物星级, String(随机小数(0.03, 0.08)), 3);
            break;
        case 4:
            怪物星级 = js_number(怪物星级, String(随机小数(0.1, 0.4)), 3);
            break;
        case 5:
            怪物星级 = js_number(怪物星级, String(随机小数(0.5, 0.9)), 3);
            break;
    }

    // 计算星星数量
    let 星星数量 = 怪物星级;
    星星数量 = (星星数量 === '0' || js_war(星星数量, '0') < 0) ? '1' : 星星数量;

    const 怪物颜色值 = Monster.GetNameColor();

    // 计算掉落等级和品质
    const 当前怪物品质 = 获取怪物品质(怪物颜色值);
    const 当前装备品质 = 获取装备品质(当前怪物品质, PR.极品率);
    const { 末尾, 颜色 } = 获取装备末尾和颜色(当前装备品质);

    // 计算各种倍率和参数
    const 翻倍值 = 获取装备翻倍值(当前装备品质, 当前怪物品质);

    // 地图等级低级地图奖励：如果地图等级 <= 150，神器几率和极品几率提高2倍
    const 是低级地图 = 掉落等级 <= 150;
    const 几率提升倍数 = 是低级地图 ? 2 : 1;

    const { 基础极品倍率, 技能极品倍率 } = 计算极品倍率(PR.极品率, 几率提升倍数);
    const 神器几率 = random(Math.max(30, Math.floor((2000 - PR.极品率) / 几率提升倍数)));

    // 神器判定
    const 是否神器 = 神器几率 < 1;
    const 神器倍数 = 是否神器 ? 1 + random(CONSTANTS.ARTIFACT_MULTIPLIER_RANGE) : 0;

    // 设置装备基本属性
    if (是否神器) {
        UserItem.Rename(`[神器]${神器倍数}倍${UserItem.GetName()}${末尾}`);
    } else {
        UserItem.Rename(`${UserItem.GetName()}${末尾}`);
    }
    UserItem.SetColor(颜色);

    // 优化：设置装备等级需求（带随机波动）
    let 最终等级: number;

    if (掉落等级 < 500) {
        // 小于500级：波动为 *(0.9-1.1)
        const 波动系数 = 0.9 + random(21) / 100; // 0.9-1.1
        最终等级 = Math.floor(掉落等级 * 波动系数);
    } else {
        // 500级及以上：每逢500波动为-100到整500，其余时候为100以内随机值
        const 余数 = 掉落等级 % 500;

        if (余数 === 0) {
            // 正好是500的倍数：波动为-100到整500
            最终等级 = 掉落等级;
        } else {
            // 不是500的倍数：100以内的随机值
            最终等级 = 掉落等级 + random(100);
        }
    }

    // 确保最终等级不为负数
    最终等级 = Math.max(1, 最终等级);

    UserItem.SetNeedLevel(最终等级);

    UserItem.SetOutWay1(装备需求, 801);
    UserItem.SetOutWay2(装备需求, 最终等级);

    // 设置基础属性
    UserItem.SetOutWay1(基础属性分割, 19);
    UserItem.SetOutWay2(基础属性分割, 基础极品倍率);
    UserItem.SetOutWay3(基础属性分割, 翻倍值);
    装备属性记录.职业属性_职业.push(19);
    装备属性记录.职业属性_属性.push(星星数量);

    // 设置职业分割
    const 是底材 = 末尾 === 尾部名字.底材名字;
    if (!是底材) {
        UserItem.SetOutWay1(职业分割, 21);
        UserItem.SetOutWay2(职业分割, 技能极品倍率);
    }

    // 获取词条数和配置 - 根据装备品质决定白条数
    const 白条数组 = 装备品质白条映射[当前装备品质] || 白色条数配置.普通;
    const 白条数 = 白条数组[random(白条数组.length)];

    // 添加基础属性词条
    添加基础属性词条(UserItem, 白条数, 星星数量, 怪物星级, 翻倍值, 基础极品倍率, 属性调整比例, Monster, 装备属性记录);

    // 添加职业属性
    if (!是底材) {
        const 职业 = 获取随机职业(Player);
        const 下面几率 = 10; // 默认下面几率为10

        // 获取职业属性词条数 - 根据装备品质决定职业词条数
        const 职业词条数组 = 装备品质职业词条映射[当前装备品质] || 职业属性词条数.普通;
        const 职业词条数 = 职业词条数组[random(职业词条数组.length)];

        const attrCtx: 职业属性上下文 = {
            翻倍: 翻倍值,
            基础极品倍率,
            技能极品倍率,
            末尾,
            颜色,
            星星数量,
            装备属性记录,
            职业,
            职业技能条数: 职业词条数,
            Monster,
            下面几率
        };

        // 添加职业属性
        add职业属性(UserItem, attrCtx);
    }

    // 设置特效和最终属性
    const 装备特效显示 = (当前装备品质 === 装备品质.不朽 || 是否神器) ? 装备特效.神器特效 : 0;

    UserItem.SetCustomEffect(装备特效显示);

    // 设置最终名称和描述
    const 职业 = 获取随机职业(Player);
    if (是否神器) {
        UserItem.Rename(`[神器]${神器倍数}倍·${职业}·${UserItem.GetName()}·[${末尾}]`);
    } else {
        UserItem.Rename(`${职业}·${UserItem.GetName()}·[${末尾}]`);
    }
    UserItem.SetColor(颜色);
    UserItem.SetCustomDesc(JSON.stringify(装备属性记录));
    Player.UpdateItem(UserItem);

    // 广播掉落信息
    广播掉落信息(Player, Monster, UserItem);

    // 如果是神器，在所有属性设置完成后应用额外倍数
    if (是否神器) {
        // 在所有基础属性和技能属性设置完成后应用神器倍数
        统一属性计算_应用神器倍数(UserItem, 神器倍数, 装备属性记录);
        // 重新更新装备
        Player.UpdateItem(UserItem);
    }

    // 圣墟属性翻倍系统
    const 圣墟翻倍结果 = 应用圣墟属性翻倍(Player, UserItem, 装备属性记录);

    // 如果触发了圣墟翻倍，更新装备名称、特效和颜色
    if (圣墟翻倍结果.是否触发翻倍) {
        // 获取装备的基础名称（去掉职业和品质后缀）
        const 当前名称 = UserItem.GetName();
        const 名称部分 = 当前名称.split('·');
        const 装备基础名 = 名称部分.length >= 2 ? 名称部分[1] : 名称部分[0];
        
        // 设置圣墟装备特效和颜色
        UserItem.SetCustomEffect(装备特效.神器特效); // 使用神器特效
        UserItem.SetColor(154); // 青色
        
        if (是否神器) {
            // 神器+圣墟：[圣墟][神器]倍数·职业·装备名·[品质]
            UserItem.Rename(`[圣墟][神器]${神器倍数}倍·${职业}·${装备基础名}·[${末尾}]`);
        } else {
            // 纯圣墟：[圣墟]条数条·职业·装备名·[品质]
            UserItem.Rename(`[圣墟]${圣墟翻倍结果.翻倍属性数量}条·${职业}·${装备基础名}·[${末尾}]`);
        }
        Player.UpdateItem(UserItem);
        
        // 输出圣墟翻倍信息
        // console.log(`[圣墟翻倍成功] 装备: ${装备基础名}, 翻倍属性: ${圣墟翻倍结果.翻倍属性数量}条, 翻倍倍率: ${圣墟翻倍结果.翻倍倍率}倍, 特效: 神器特效, 颜色: 青色(154)`);
    }

    // 装备属性处理完成
}


// 在辅助函数部分添加统一的属性计算函数
/**
 * 统一的属性计算函数 - 用于计算基础属性、技能伤害和生肖数值
 * 
 * 该函数根据不同的类型使用不同的计算策略：
 * - basic: 基础属性计算，受翻倍值、极品倍率和属性调整比例影响
 * - skill: 技能伤害计算，主要受极品倍率影响，有随机加成
 * - zodiac: 生肖数值计算，使用特殊系数，确保最小值
 * 
 * @param 怪物星级 怪物的星级字符串
 * @param 翻倍值 装备翻倍值（1-90之间有效）
 * @param 极品倍率 极品倍率（1-100之间有效）
 * @param 属性调整比例 属性调整比例字符串
 * @param 类型 计算类型：'basic' | 'skill' | 'zodiac'
 * @returns 计算后的属性值字符串
 */
function 统一属性计算(怪物星级: string, 翻倍值: number, 极品倍率: number, 属性调整比例: string, 类型: 'basic' | 'skill' | 'zodiac'): string {
    // 限制翻倍值和极品倍率以保证数值合理
    const 有效翻倍值 = Math.min(翻倍值, 90);
    const 有效极品倍率 = Math.min(极品倍率, 100);

    // 生成随机系数 (0.4-0.8)
    let 随机系数 = 随机小数(0.05, 0.3).toFixed(2);
    let 基础值 = 怪物星级;
    let 属性值;
    // if (js_war(基础值, '10') < 0) 基础值 = js_numberRandom('10', '100');
    // 根据类型使用不同的计算方式
    switch (类型) {
        case 'basic': // 基础属性计算
            // 基础属性使用较小的基础系数
            // 基础值 = js_number(基础值, String(random(100)+ 200), 3);
            属性值 = js_number(基础值, 随机系数, 3);

            // 应用翻倍值
            属性值 = js_number(属性值, String(有效翻倍值), 3);

            // 应用极品倍率
            属性值 = js_number(属性值, String(有效极品倍率), 3);

            // 应用属性调整比例
            属性值 = js_number(属性值, 属性调整比例, 3);
            // 应用随机加成
            if (random(200) < 1) {
                属性值 = js_number(属性值, String(random(5) + 1), 3);
            }
            if (js_war(属性值, '10000') < 0) 属性值 = js_numberRandom('10000', '100000');
            break;

        case 'skill': // 技能伤害计算
            // 技能伤害使用较大的基础系数
            if (js_war(基础值, '10') < 0) 基础值 = js_numberRandom('10', '100');
            // 基础值 = js_number(基础值, String(random(400)+ 1000), 3);
            属性值 = js_number(基础值, 随机系数, 3);
            // 应用翻倍值
            属性值 = js_number(属性值, String(有效翻倍值), 3);
            // 应用极品倍率
            // 属性值 = js_number(属性值, String(Math.max(有效极品倍率, 1)), 3);
            属性值 = js_number(属性值, String(有效极品倍率), 3);

            // 应用属性调整比例
            属性值 = js_number(属性值, 属性调整比例, 3);
            // 应用属性调整比例
            属性值 = js_number(属性值, 随机小数(0.01, 0.2).toFixed(2), 3);
            // 应用随机加成
            if (random(400) < 1) {
                属性值 = js_number(属性值, String(random(5) + 1), 3);
            }
            // 确保最小值
            if (js_war(属性值, '1000000') < 0) 属性值 = js_numberRandom('1000000', '2000000');
            break;

        case 'zodiac': // 生肖数值计算
            // 生肖数值使用特殊系数
            基础值 = js_number(基础值, `1000`, 3);
            属性值 = js_number(基础值, 随机系数, 3);

            // 应用翻倍值
            属性值 = js_number(属性值, String(有效翻倍值), 3);

            // 应用极品倍率，生肖数值使用更高的极品倍率
            属性值 = js_number(属性值, String(有效极品倍率 * 1.2), 3);

            // 确保最小值
            if (js_war(属性值, '8000') < 0) 属性值 = js_numberRandom('8000', '15000');
            break;

        default:
            属性值 = '10';
    }

    return 属性值;
}

// 添加基础属性词条
function 添加基础属性词条(UserItem: TUserItem, 词条数: number, 星星数量: string, 怪物星级: string, 翻倍值: number, 基础极品倍率: number, 属性调整比例: string, Monster: TActor, 装备属性记录: 装备属性记录): void {
    // 确保至少一个全属性词条
    let 有全属性 = false;
    let 全属性ID = 30 + random(9); // 随机选择一个属性ID

    for (let i = 基础属性第一条; i < 基础属性第一条 + 词条数; i++) {
        // 确定属性ID - 确保有至少一个全属性词条
        let 随机额外属性;
        if (!有全属性) {
            随机额外属性 = 全属性ID;
            有全属性 = true;
        } else {
            随机额外属性 = 31 + random(8); // 其他属性
        }

        // 使用统一计算函数计算属性值
        let 额外属性的值 = 统一属性计算(怪物星级, 翻倍值, 基础极品倍率, 属性调整比例, 'basic');

        // 特殊处理低等级装备
        if (UserItem.NeedLevel < 100) {
            if (js_war(额外属性的值, '500') < 0) 额外属性的值 = js_numberRandom('500', '1000');
            额外属性的值 = js_number(额外属性的值, String(random(5) + 10), 3);
        } 
        
        if (随机额外属性 === 31) {  //生命
            额外属性的值 = js_number(额外属性的值, String(random(5) + 5), 3);
        }
        if (随机额外属性 === 32) {  //防御
            额外属性的值 = js_number(额外属性的值, 随机小数(0.4,0.6).toFixed(2), 3);
        }
        
        // // 特殊处理boss掉落，提高属性值
        // if (Monster.Name.includes('boss') || Monster.Name.includes('BOSS')) {
        //     // boss掉落加成，但仍然控制在合理范围
        //     额外属性的值 = js_number(额外属性的值, '1.5', 3);
        // }

        设置装备属性(UserItem, i, 随机额外属性, 额外属性的值, 装备属性记录);
    }
}

// 修改职业属性函数，使用新的统一属性计算函数
function add职业属性(UserItem: TUserItem, ctx: 职业属性上下文): void {
    const { 职业, 职业技能条数, 翻倍, 技能极品倍率, Monster, 装备属性记录 } = ctx;

    const hasAllBuffs = UserItem.StdMode === 5 || UserItem.StdMode === 6;
    const skillConfig = hasAllBuffs ? 职业技能重数有全倍攻 : 职业技能重数没全倍攻;
    const professionConfig = skillConfig.find(c => c.职业 === 职业);

    if (!professionConfig) return;

    // 优化：计算怪物星级（避免重复计算）
    let 怪物星级 = js_number(Monster.GetSVar(94), 随机小数(0.05, 0.08).toFixed(2), 3);
    怪物星级 = js_number(怪物星级, '0.1', 3);

    const 取尾数 = Monster.GetNVar(TAG) % 10;

    // 优化：使用switch代替多个if-else
    switch (取尾数) {
        case 1:
            怪物星级 = js_number(怪物星级, String(随机小数(0.01, 0.05)), 3);
            break;
        case 2:
            怪物星级 = js_number(怪物星级, String(随机小数(0.02, 0.06)), 3);
            break;
        case 3:
            怪物星级 = js_number(怪物星级, String(随机小数(0.03, 0.08)), 3);
            break;
        case 4:
            怪物星级 = js_number(怪物星级, String(随机小数(0.1, 0.4)), 3);
            break;
        case 5:
            怪物星级 = js_number(怪物星级, String(随机小数(0.5, 0.9)), 3);
            break;
    }

    // 优化：缓存地图名称和掉落等级
    const 地图名称 = 地图.ID取地图名(Monster.GetMapName());
    const 掉落等级 = 获取地图掉落等级(地图名称);
    const 属性调整比例 = 获取属性调整比例(掉落等级);
    const 倍攻配置 = 倍攻几率.find(m => m.地图名字 === 地图名称);

    for (let i = 职业第一条; i < 职业第一条 + 职业技能条数; i++) {
        // 处理倍攻属性
        if (random(200) < 4 && professionConfig.倍攻.length > 0 && 倍攻配置) {
            const 随机额外属性 = professionConfig.倍攻[random(professionConfig.倍攻.length)];

            let 技能倍功: string;
            const 基础倍功 = js_numberRandom2(String(倍攻配置.固定), String(倍攻配置.最高几率));
            const 倍攻加成 = random(倍攻配置.最高几率 / 2);

            if (random(200) < 5) {
                技能倍功 = js_number(基础倍功, String(倍攻加成), 1);
            } else if (random(200) < 20) {
                技能倍功 = String(倍攻加成);
            } else {
                技能倍功 = String(倍攻配置.固定);
            }

            // 倍攻属性不应用翻倍值和神器倍数
            设置装备属性(UserItem, i, 随机额外属性, 技能倍功, 装备属性记录);
        }
        // 处理技能重数属性
        else {
            const 随机额外属性 = professionConfig.技能重数[random(professionConfig.技能重数.length)];
            // 使用统一计算函数计算技能伤害 - 将翻倍值设为原翻倍值的一半以控制技能伤害
            const 技能翻倍值 = Math.max(1, Math.floor(翻倍 / CONSTANTS.SKILL_MULTIPLIER_DECAY));
            const 技能伤害 = 统一属性计算(怪物星级, 技能翻倍值, 技能极品倍率, 属性调整比例, 'skill');

            设置装备属性(UserItem, i, 随机额外属性, 技能伤害, 装备属性记录);
        }
    }
}


// 广播掉落信息
function 广播掉落信息(Player: TPlayObject, Monster: TActor, UserItem: TUserItem): void {
    // 优化：缓存常用属性，减少重复调用
    const 玩家名 = Player.GetName();
    const 地图名 = Player.GetMap().Name;
    const 怪物名 = Monster.GetName();
    const 装备名 = UserItem.DisplayName;
    const 消息 = `玩家{S=${玩家名};C=253}在{S=${地图名};C=253}击杀一只{S=${怪物名};C=253}掉落了一个{S=${装备名};C=249}`;

    for (let i = 0; i < GameLib.PlayCount; i++) {
        const p = GameLib.GetPlayer(i);
        if (p) {
            p.V.屏蔽掉落 ??= false;
            if (!p.GetNotOnlineAddExp() && !p.V.屏蔽掉落) {
                p.SendMessage(消息, 1);
            }
        }
    }
}

const 倍攻几率 = [
    { 地图名字: '荒芜山谷', 几率: 1, 固定: 1, 最高几率: 100 },
    { 地图名字: '试炼之地', 几率: 1, 固定: 1, 最高几率: 100 },
    { 地图名字: '血之炼狱', 几率: 1, 固定: 1, 最高几率: 100 },
    { 地图名字: '竞技洞窟', 几率: 1, 固定: 1, 最高几率: 100 },
    { 地图名字: '血路之颠', 几率: 1, 固定: 1, 最高几率: 100 },

    { 地图名字: '沙漠绿洲', 几率: 2, 固定: 2, 最高几率: 150 },
    { 地图名字: '凄凉之地', 几率: 2, 固定: 2, 最高几率: 150 },
    { 地图名字: '狂风峭壁', 几率: 2, 固定: 2, 最高几率: 150 },
    { 地图名字: '崎岖索道', 几率: 2, 固定: 2, 最高几率: 150 },
    { 地图名字: '风暴峡谷', 几率: 2, 固定: 2, 最高几率: 150 },

    { 地图名字: '古船遗迹', 几率: 2, 固定: 2, 最高几率: 200 },
    { 地图名字: '森林迷宫', 几率: 2, 固定: 2, 最高几率: 200 },
    { 地图名字: '古之城墙', 几率: 2, 固定: 2, 最高几率: 200 },
    { 地图名字: '暗影迷宫', 几率: 2, 固定: 2, 最高几率: 200 },
    { 地图名字: '失落暗殿', 几率: 2, 固定: 2, 最高几率: 200 },

    { 地图名字: '神秘古国', 几率: 2, 固定: 2, 最高几率: 250 },
    { 地图名字: '海岛遗迹', 几率: 2, 固定: 2, 最高几率: 250 },
    { 地图名字: '魔之莽道', 几率: 2, 固定: 2, 最高几率: 250 },
    { 地图名字: '盘蛇古迹', 几率: 2, 固定: 2, 最高几率: 250 },
    { 地图名字: '泗水祭坛', 几率: 2, 固定: 2, 最高几率: 250 },
    
    { 地图名字: '铁血魔域', 几率: 2, 固定: 2, 最高几率: 300 },
    { 地图名字: '血腥森林', 几率: 2, 固定: 2, 最高几率: 300 },
    { 地图名字: '蛮荒丛林', 几率: 2, 固定: 2, 最高几率: 300 },
    { 地图名字: '血狱皇陵', 几率: 2, 固定: 2, 最高几率: 300 },
    { 地图名字: '星空廊道', 几率: 2, 固定: 2, 最高几率: 300 },

    { 地图名字: '黑暗森林', 几率: 2, 固定: 2, 最高几率: 350 },
    { 地图名字: '郊外平原', 几率: 2, 固定: 2, 最高几率: 350 },
    { 地图名字: '天然洞穴', 几率: 2, 固定: 2, 最高几率: 350 },
    { 地图名字: '矿区山谷', 几率: 2, 固定: 2, 最高几率: 350 },
    { 地图名字: '祖玛回廊', 几率: 2, 固定: 2, 最高几率: 350 },

    { 地图名字: '万妖森林', 几率: 2, 固定: 2, 最高几率: 400 },
    { 地图名字: '万妖峡谷', 几率: 2, 固定: 2, 最高几率: 400 },
    { 地图名字: '万妖之巢', 几率: 2, 固定: 2, 最高几率: 400 },
    { 地图名字: '万妖迷宫', 几率: 2, 固定: 2, 最高几率: 400 },
    { 地图名字: '万妖祭坛', 几率: 2, 固定: 2, 最高几率: 400 },

    { 地图名字: '邪恶洞穴', 几率: 2, 固定: 2, 最高几率: 450 },
    { 地图名字: '蛇妖山谷', 几率: 2, 固定: 2, 最高几率: 450 },
    { 地图名字: '沃玛寺庙', 几率: 2, 固定: 2, 最高几率: 450 },
    { 地图名字: '暗黑蛇谷', 几率: 2, 固定: 2, 最高几率: 450 },
    { 地图名字: '沉息之地', 几率: 2, 固定: 2, 最高几率: 450 },

    { 地图名字: '神域冰谷', 几率: 2, 固定: 2, 最高几率: 500 },
    { 地图名字: '纷争之地', 几率: 2, 固定: 2, 最高几率: 500 },
    { 地图名字: '上古禁地', 几率: 2, 固定: 2, 最高几率: 500 },
    { 地图名字: '封印之城', 几率: 2, 固定: 2, 最高几率: 500 },
    { 地图名字: '神庙主殿', 几率: 2, 固定: 2, 最高几率: 500 },

]
const 职业技能重数有全倍攻 = [
    { 职业: '战神', 技能重数: [401, 402, 412, 414, 415], 倍攻: [195, 196, 208, 210, 211, 204, 205, 468] },
    { 职业: '骑士', 技能重数: [401, 402, 416, 417, 418], 倍攻: [195, 196, 212, 213, 214, 204, 205] },
    { 职业: '火神', 技能重数: [403, 405, 419, 420], 倍攻: [197, 199, 215, 216, 204, 205] },
    { 职业: '冰法', 技能重数: [403, 405, 421, 422, 423], 倍攻: [197, 199, 217, 218, 219, 204, 205] },
    { 职业: '驯兽师', 技能重数: [404, 406, 411], 倍攻: [198, 200, 207, 204, 205, 467] },
    { 职业: '牧师', 技能重数: [404, 406, 424, 425, 426], 倍攻: [198, 200, 220, 221, 222, 204, 205] },
    { 职业: '刺客', 技能重数: [407, 427, 428], 倍攻: [201, 223, 224, 204, 205] },
    { 职业: '鬼舞者', 技能重数: [407, 429, 430, 431], 倍攻: [201, 225, 226, 227, 204, 205] },
    { 职业: '神射手', 技能重数: [432, 433, 434], 倍攻: [228, 229, 230, 204, 205] },
    { 职业: '猎人', 技能重数: [410, 435, 436], 倍攻: [231, 232, 206, 204, 205, 466] },
    { 职业: '武僧', 技能重数: [409, 408, 437, 438, 439], 倍攻: [202, 203, 233, 234, 235, 204, 205] },
    { 职业: '罗汉', 技能重数: [409, 408, 413, 440], 倍攻: [202, 203, 236, 209, 204, 205, 469] },
]
const 职业技能重数没全倍攻 = [
    { 职业: '战神', 技能重数: [401, 402, 412, 414, 415], 倍攻: [195, 196, 208, 210, 211, 468] },
    { 职业: '骑士', 技能重数: [401, 402, 416, 417, 418], 倍攻: [195, 196, 212, 213, 214] },
    { 职业: '火神', 技能重数: [403, 405, 419, 420], 倍攻: [197, 199, 215, 216] },
    { 职业: '冰法', 技能重数: [403, 405, 421, 422, 423], 倍攻: [197, 199, 217, 218, 219] },
    { 职业: '驯兽师', 技能重数: [404, 406, 411], 倍攻: [198, 200, 207, 467] },
    { 职业: '牧师', 技能重数: [404, 406, 424, 425, 426], 倍攻: [198, 200, 220, 221, 222] },
    { 职业: '刺客', 技能重数: [407, 427, 428], 倍攻: [201, 223, 224] },
    { 职业: '鬼舞者', 技能重数: [407, 429, 430, 431], 倍攻: [201, 225, 226, 227] },
    { 职业: '神射手', 技能重数: [432, 433, 434], 倍攻: [228, 229, 230] },
    { 职业: '猎人', 技能重数: [410, 435, 436], 倍攻: [231, 232, 206, 466] },
    { 职业: '武僧', 技能重数: [409, 408, 437, 438, 439], 倍攻: [202, 203, 233, 234, 235] },
    { 职业: '罗汉', 技能重数: [409, 408, 413, 440], 倍攻: [202, 203, 236, 209, 469] },
]

const 攻击魔法速度 = 310
const 伤害减少 = 301
const 所有技能等级 = 304
const 吸血比例 = 302
const 宝宝速度 = 305
const 抵抗异常 = 307
const 种族小属性 = [350, 351, 352]
const 天赋属性 = [620, 621, 622, 623, 624, 625, 626, 627, 628]

// 优化：将倍攻属性ID列表提取为常量，避免每次函数调用时重新创建数组
const 倍攻属性ID列表 = new Set([
    195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208,
    209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222,
    223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236,
    466, 467, 468, 469
]);

/**
 * 为神器装备应用额外倍数
 *
 * 正确的逻辑：从装备属性记录中获取原始的统一计算数值，
 * 应用神器倍数后重新设置到装备上，而不是从OutWay中获取已转换的数值
 *
 * @param UserItem 装备对象
 * @param 神器倍数 神器额外倍数
 * @param 装备属性记录 属性记录对象
 */
function 统一属性计算_应用神器倍数(UserItem: TUserItem, 神器倍数: number, 装备属性记录: 装备属性记录): void {
    const 神器倍数字符串 = String(神器倍数);

    // 从装备属性记录中获取原始数值并应用神器倍数
    for (let recordIndex = 0; recordIndex < 装备属性记录.职业属性_职业.length; recordIndex++) {
        const 属性ID = 装备属性记录.职业属性_职业[recordIndex];
        const 原始属性值 = 装备属性记录.职业属性_属性[recordIndex];

        // 优化：跳过倍攻属性和无效属性（使用Set的has方法，O(1)复杂度）
        if (!属性ID || !原始属性值 || 倍攻属性ID列表.has(属性ID)) {
            continue;
        }

        // 应用神器倍数到原始数值
        const 新属性值 = js_number(原始属性值, 神器倍数字符串, 3);

        // 更新记录中的属性值
        装备属性记录.职业属性_属性[recordIndex] = 新属性值;

        // 找到对应的装备槽位并更新
        const 装备槽位 = 查找属性槽位(UserItem, 属性ID);
        if (装备槽位 >= 0) {
            设置装备属性值到槽位(UserItem, 装备槽位, 属性ID, 新属性值);
        }
    }

    // 更新自定义描述
    UserItem.SetCustomDesc(JSON.stringify(装备属性记录));
}

/**
 * 查找属性在装备中的槽位
 * @param UserItem 装备对象
 * @param 属性ID 要查找的属性ID
 * @returns 槽位索引，-1表示未找到
 */
function 查找属性槽位(UserItem: TUserItem, 属性ID: number): number {
    // 优化：搜索基础属性槽位
    for (let i = 基础属性第一条; i < 基础属性第十条; i++) {
        if (UserItem.GetOutWay1(i) === 属性ID) {
            return i;
        }
    }

    // 优化：搜索职业属性槽位
    const 职业属性结束 = 职业第一条 + 10;
    for (let i = 职业第一条; i < 职业属性结束; i++) {
        if (UserItem.GetOutWay1(i) === 属性ID) {
            return i;
        }
    }

    // 优化：搜索其他槽位（如果有特定的生肖槽位）
    for (let i = 0; i < 50; i++) { // 假设最多50个槽位
        if (UserItem.GetOutWay1(i) === 属性ID) {
            return i;
        }
    }

    return -1;
}

/**
 * 设置属性值到指定槽位
 * @param UserItem 装备对象
 * @param 槽位 槽位索引
 * @param 属性ID 属性ID
 * @param 属性值 属性值字符串
 */
function 设置装备属性值到槽位(UserItem: TUserItem, 槽位: number, 属性ID: number, 属性值: string): void {
    // 优化：缓存转换结果
    const 前端数字 = 数字转单位2(属性值);
    const 后端单位 = 数字转单位3(属性值);
    const 前端数字值 = Number(前端数字);
    const 后端单位值 = Number(后端单位);

    UserItem.SetOutWay1(槽位, 属性ID);
    UserItem.SetOutWay2(槽位, 前端数字值);
    UserItem.SetOutWay3(槽位, 后端单位值);
}

/**
 * 圣墟属性翻倍系统
 * 根据玩家的圣墟等级，对装备属性进行额外翻倍
 * 
 * @param Player 玩家对象
 * @param UserItem 装备对象
 * @param 装备属性记录 装备的属性记录
 * @returns 返回翻倍结果，包含是否触发翻倍和翻倍的属性数量
 */
// 优化：将基础属性ID列表提取为常量
const 基础属性IDs = new Set([30, 31, 32, 33, 34, 35, 36, 37, 38, 600, 601, 602, 603, 604, 605]);

function 应用圣墟属性翻倍(Player: TPlayObject, UserItem: TUserItem, 装备属性记录: 装备属性记录): { 是否触发翻倍: boolean, 翻倍属性数量: number, 翻倍倍率: number } {
    // 优化：检查圣墟等级是否满足条件
    const PV = Player.V;
    const 圣墟等级 = PV.圣墟等级 || 0;
    if (圣墟等级 < 10) {
        return { 是否触发翻倍: false, 翻倍属性数量: 0, 翻倍倍率: 0 }; // 圣墟等级不足10，不触发翻倍
    }

    // 计算翻倍几率和倍率
    const 圣墟点数 = random(Math.floor(圣墟等级 / 10) + 5);
    const 基础翻倍几率 = Math.min(圣墟点数 / 4000, 500 / 5000); // 最大几率为500/5000
    const 翻倍倍率 = Math.max(1, random(Math.floor(圣墟等级 / 100) + Math.floor(PV.圣墟点数等级 / 10)) + 1); // 至少1倍，确保不为0

    let 翻倍属性计数 = 0;

    // 遍历装备的所有属性
    if (装备属性记录.职业属性_职业 && 装备属性记录.职业属性_职业.length > 0) {
        const 职业属性列表 = 装备属性记录.职业属性_职业;
        const 属性值列表 = 装备属性记录.职业属性_属性;

        for (let i = 0; i < 职业属性列表.length; i++) {
            const 属性ID = 职业属性列表[i];
            const 属性值 = 属性值列表[i];

            // 优化：检查属性值是否有效，过滤掉无效值
            if (!属性值 || 属性值 === '0' || 属性值.includes('-') || 属性值.trim() === '') continue;

            let 是否触发翻倍 = false;
            let 当前翻倍倍率 = 1;

            // 优化：判断属性类型并确定翻倍几率（使用Set的has方法）
            if (基础属性IDs.has(属性ID)) {
                // 基础属性
                当前翻倍倍率 = 翻倍倍率;
                是否触发翻倍 = Math.random() < 基础翻倍几率;
            } 
            // else if (所有职业技能伤害.hasOwnProperty(属性ID)) {
            //     // 技能伤害
            //     当前翻倍倍率 = 翻倍倍率;
            //     是否触发翻倍 = Math.random() < 基础翻倍几率;
            // } else if (所有职业技能倍攻.hasOwnProperty(属性ID)) {
            //     // 技能倍功（几率是其他的1/10，倍率是其他的1/5）
            //     当前翻倍倍率 = Math.max(0.5, 翻倍倍率 / 5); // 确保最小倍率为0.5，避免过小
            //     是否触发翻倍 = Math.random() < 基础翻倍几率 / 10;
            // }

            // 如果触发翻倍
            if (是否触发翻倍 && 当前翻倍倍率 > 0) {
                // 计算翻倍后的属性值
                const 最终倍率 = String(当前翻倍倍率 + 1); // +1是因为翻倍倍率表示额外的倍数
                const 翻倍后属性值 = js_number(属性值, 最终倍率, 3);

                // 验证计算结果是否有效
                if (!翻倍后属性值 || 翻倍后属性值 === '0' || 翻倍后属性值.includes('-') || 翻倍后属性值.trim() === '') {
                    // 计算结果无效，跳过此属性
                    console.log(`[圣墟翻倍警告] 属性ID ${属性ID} 计算结果无效: 原值=${属性值}, 倍率=${最终倍率}, 结果=${翻倍后属性值}`);
                    continue;
                }

                // 验证翻倍后的值是否大于原值
                if (js_war(翻倍后属性值, 属性值) <= 0) {
                    // 翻倍后反而变小或相等，跳过
                    console.log(`[圣墟翻倍警告] 属性ID ${属性ID} 翻倍后未增长: 原值=${属性值}, 新值=${翻倍后属性值}`);
                    continue;
                }

                翻倍属性计数++;

                // 更新装备属性记录
                属性值列表[i] = 翻倍后属性值;

                // 查找并更新装备中的属性值
                const 槽位 = 查找属性槽位(UserItem, 属性ID);
                if (槽位 !== -1) {
                    设置装备属性值到槽位(UserItem, 槽位, 属性ID, 翻倍后属性值);
                }
            }
        }
        // 如果有属性触发翻倍，更新装备
        if (翻倍属性计数 > 0) {
            // 更新装备的CustomDesc
            UserItem.SetCustomDesc(JSON.stringify(装备属性记录));
            Player.UpdateItem(UserItem);
        }
    }

    return {
        是否触发翻倍: 翻倍属性计数 > 0,
        翻倍属性数量: 翻倍属性计数,
        翻倍倍率: 翻倍倍率 + 1
    };
}





// ====================================== 实时清理效果验证工具 ======================================
// 用于验证实时清理系统的效果
// 监控怪物信息缓存、装备JSON缓存和整体清理效果

// 导入装备缓存统计
import { 获取装备缓存统计 } from './装备属性统计';

/**
 * 实时清理效果验证器
 */
export class 实时清理效果验证器 {
    
    /**
     * 检查怪物信息缓存状态
     * @returns 怪物信息缓存的详细统计
     */
    public static 检查怪物信息缓存状态(): {
        总数量: number;
        有效数量: number;
        损坏数量: number;
        空数据数量: number;
        估算活跃怪物数量: number;
        缓存利用率: string;
        缓存健康度: string;
        建议: string[];
    } {
        let 总数量 = 0;
        let 有效数量 = 0;
        let 损坏数量 = 0;
        let 空数据数量 = 0;
        const 建议: string[] = [];

        try {
            if (GameLib.R && GameLib.R.怪物信息) {
                const 怪物信息Keys = Object.keys(GameLib.R.怪物信息);
                总数量 = 怪物信息Keys.length;

                for (const 怪物Handle of 怪物信息Keys) {
                    try {
                        const 怪物信息JSON = GameLib.R.怪物信息[怪物Handle];
                        
                        if (!怪物信息JSON || 怪物信息JSON === '' || 怪物信息JSON === 'null') {
                            空数据数量++;
                        } else {
                            try {
                                const 解析结果 = JSON.parse(怪物信息JSON);
                                if (解析结果 && typeof 解析结果 === 'object') {
                                    有效数量++;
                                } else {
                                    损坏数量++;
                                }
                            } catch (error) {
                                损坏数量++;
                            }
                        }
                    } catch (error) {
                        损坏数量++;
                    }
                }
            }

            // 计算健康度
            const 有效率 = 总数量 > 0 ? (有效数量 / 总数量) * 100 : 0;
            let 缓存健康度: string;
            
            if (有效率 >= 90) {
                缓存健康度 = '优秀';
            } else if (有效率 >= 70) {
                缓存健康度 = '良好';
            } else if (有效率 >= 50) {
                缓存健康度 = '一般';
            } else {
                缓存健康度 = '较差';
            }

            // 计算当前活跃怪物数量估算
            let 估算活跃怪物数量 = 0;
            try {
                // 简化估算：通过玩家数量和平均怪物密度估算
                // 这是一个保守的估算方法
                const 在线玩家数 = GameLib.GetPlayCount() || 0;
                // 假设每个玩家周围平均有10-20只怪物
                估算活跃怪物数量 = Math.max(在线玩家数 * 15, 100); // 最少100只怪物
                
                // 如果能获取到具体地图信息则更精确（预留接口）
                // 注：目前GameLib.GetMap可能不可用，使用估算方法
            } catch (error) {
                // 使用默认估算值
                估算活跃怪物数量 = 500;
            }

            // 生成建议
            if (总数量 === 0) {
                建议.push('⚠️ 怪物信息缓存为空，可能影响装备掉落属性生成');
            } else {
                const 缓存效率 = 估算活跃怪物数量 > 0 ? (估算活跃怪物数量 / 总数量) * 100 : 0;
                
                建议.push(`📊 缓存分析: 总缓存${总数量}项 vs 活跃怪物约${估算活跃怪物数量}只`);
                
                if (缓存效率 < 20) {
                    建议.push(`🔥 实时清理效果良好: 缓存利用率${缓存效率.toFixed(1)}%，过期缓存已大量清理`);
                } else if (缓存效率 < 50) {
                    建议.push(`✅ 实时清理效果正常: 缓存利用率${缓存效率.toFixed(1)}%`);
                } else {
                    建议.push(`⚠️ 可能存在缓存堆积: 缓存利用率${缓存效率.toFixed(1)}%，建议检查实时清理`);
                }
                
                if (损坏数量 > 100) {
                    建议.push(`🔧 发现${损坏数量}项损坏数据，建议手动清理`);
                }
                if (空数据数量 > 50) {
                    建议.push(`🧹 发现${空数据数量}项空数据，可以安全清理`);
                }
                if (有效率 >= 90) {
                    建议.push('✅ 怪物信息缓存状态良好，装备掉落应该正常');
                }
            }

            return {
                总数量,
                有效数量,
                损坏数量,
                空数据数量,
                估算活跃怪物数量,
                缓存利用率: 估算活跃怪物数量 > 0 ? ((估算活跃怪物数量 / 总数量) * 100).toFixed(1) + '%' : '无法计算',
                缓存健康度,
                建议
            };

        } catch (error) {
            return {
                总数量: 0,
                有效数量: 0,
                损坏数量: 0,
                空数据数量: 0,
                估算活跃怪物数量: 0,
                缓存利用率: '检查失败',
                缓存健康度: '检查失败',
                建议: [`❌ 检查怪物信息缓存时出错: ${error}`]
            };
        }
    }

    /**
     * 检查装备JSON缓存状态
     * @returns 装备缓存的详细统计
     */
    public static 检查装备缓存状态(): {
        缓存数量: number;
        命中率: string;
        访问次数: number;
        缓存效率: string;
        内存使用估算: string;
        建议: string[];
    } {
        const 建议: string[] = [];

        try {
            const 缓存统计 = 获取装备缓存统计();
            
            // 分析缓存效率
            const 命中率数值 = parseFloat(缓存统计.命中率.replace('%', ''));
            let 缓存效率 = '';
            
            if (命中率数值 >= 70) {
                缓存效率 = '优秀';
                建议.push('🔥 装备缓存命中率优秀，JSON解析性能提升显著');
            } else if (命中率数值 >= 50) {
                缓存效率 = '良好';
                建议.push('✅ 装备缓存命中率良好，性能有所提升');
            } else if (命中率数值 >= 30) {
                缓存效率 = '一般';
                建议.push('📊 装备缓存命中率一般，建议观察缓存清理效果');
            } else {
                缓存效率 = '较差';
                建议.push('⚠️ 装备缓存命中率较低，可能需要优化缓存策略');
            }

            // 估算内存使用
            const 估算内存KB = 缓存统计.缓存数量 * 2; // 假设每个缓存条目约2KB
            const 内存使用估算 = 估算内存KB > 1024 
                ? `${(估算内存KB / 1024).toFixed(1)}MB` 
                : `${估算内存KB}KB`;

            // 生成建议
            if (缓存统计.缓存数量 === 0) {
                建议.push('📝 装备缓存为空，系统刚启动或缓存已清理');
            } else {
                建议.push(`💾 当前缓存${缓存统计.缓存数量}项，访问${缓存统计.访问次数}次`);
                
                if (缓存统计.缓存数量 > 200) {
                    建议.push('🧹 装备缓存较多，实时清理系统正在自动管理');
                }
                
                if (缓存统计.访问次数 > 1000 && 命中率数值 > 50) {
                    建议.push('⚡ 缓存系统工作良好，有效提升JSON解析性能');
                }
            }

            return {
                缓存数量: 缓存统计.缓存数量,
                命中率: 缓存统计.命中率,
                访问次数: 缓存统计.访问次数,
                缓存效率,
                内存使用估算,
                建议
            };

        } catch (error) {
            return {
                缓存数量: 0,
                命中率: '无法获取',
                访问次数: 0,
                缓存效率: '检查失败',
                内存使用估算: '无法计算',
                建议: [`❌ 检查装备缓存时出错: ${error}`]
            };
        }
    }

    /**
     * 检查系统整体状态和清理效果
     * @param Player 玩家对象
     * @returns 检查结果
     */
    public static 检查系统清理效果(Player: TPlayObject): {
        玩家状态: string;
        怪物信息可用: boolean;
        装备掉落环境: string;
        实时清理状态: string;
        潜在问题: string[];
        建议操作: string[];
    } {
        const 潜在问题: string[] = [];
        const 建议操作: string[] = [];

        try {
            // 检查玩家状态
            let 玩家状态 = '正常';
            if (!Player) {
                玩家状态 = '玩家对象无效';
                潜在问题.push('❌ 玩家对象为空或无效');
                建议操作.push('请使用有效的玩家对象进行测试');
            }

            // 检查怪物信息可用性
            let 怪物信息可用 = false;
            if (GameLib.R && GameLib.R.怪物信息) {
                const 怪物信息数量 = Object.keys(GameLib.R.怪物信息).length;
                怪物信息可用 = 怪物信息数量 > 0;
                
                if (!怪物信息可用) {
                    潜在问题.push('⚠️ 怪物信息缓存为空，可能影响装备属性生成');
                    建议操作.push('等待怪物生成或重新加载地图');
                }
            } else {
                潜在问题.push('❌ GameLib.R.怪物信息 不存在');
                建议操作.push('检查游戏引擎状态');
            }

            // 检查装备掉落环境
            let 装备掉落环境 = '正常';
            
            // 检查地图状态
            if (Player && Player.GetMapName) {
                const 地图名 = Player.GetMapName();
                if (!地图名) {
                    装备掉落环境 = '地图信息异常';
                    潜在问题.push('⚠️ 无法获取玩家地图信息');
                }
            }

            // 检查极品率
            if (Player && Player.R) {
                const 极品率 = Player.R.极品率 || 0;
                if (极品率 <= 0) {
                    潜在问题.push('📊 玩家极品率为0，可能影响装备品质');
                    建议操作.push('检查玩家属性计算是否正常');
                }
            }

            // 检查实时清理状态
            let 实时清理状态 = '正常';
            const 怪物缓存状态 = this.检查怪物信息缓存状态();
            const 装备缓存状态 = this.检查装备缓存状态();
            
            // 分析实时清理效果
            const 怪物缓存利用率 = parseFloat(怪物缓存状态.缓存利用率.replace('%', ''));
            const 装备命中率 = parseFloat(装备缓存状态.命中率.replace('%', ''));
            
            if (怪物缓存利用率 < 30 && 装备命中率 > 50) {
                实时清理状态 = '优秀';
                建议操作.push('🔥 实时清理系统运行优秀，缓存效率高');
            } else if (怪物缓存利用率 < 50) {
                实时清理状态 = '良好';
                建议操作.push('✅ 实时清理系统运行良好');
            } else {
                实时清理状态 = '需要关注';
                潜在问题.push('⚠️ 缓存可能存在堆积，检查实时清理是否正常工作');
                建议操作.push('检查怪物死亡和装备回收的清理日志');
            }

            return {
                玩家状态,
                怪物信息可用,
                装备掉落环境,
                实时清理状态,
                潜在问题,
                建议操作
            };

        } catch (error) {
            return {
                玩家状态: '检查失败',
                怪物信息可用: false,
                装备掉落环境: '检查失败',
                实时清理状态: '检查失败',
                潜在问题: [`❌ 检查过程出错: ${error}`],
                建议操作: ['重新运行检查或联系技术支持']
            };
        }
    }

    /**
     * 执行完整的实时清理效果验证
     * @param Player 玩家对象（可选）
     * @returns 完整的验证报告
     */
    public static 执行完整验证(Player?: TPlayObject): {
        验证时间: string;
        怪物缓存状态: any;
        装备缓存状态: any;
        系统清理效果: any;
        整体评估: string;
        清理效果评分: number;
        建议措施: string[];
    } {
        const 验证时间 = new Date().toLocaleString('zh-CN');
        const 怪物缓存状态 = this.检查怪物信息缓存状态();
        const 装备缓存状态 = this.检查装备缓存状态();
        const 系统清理效果 = Player ? this.检查系统清理效果(Player) : null;

        // 整体评估和清理效果评分
        let 整体评估 = '良好';
        let 清理效果评分 = 0;
        const 建议措施: string[] = [];

        // 评分计算（满分100分）
        // 怪物缓存评分（50分）
        const 怪物缓存利用率 = parseFloat(怪物缓存状态.缓存利用率.replace('%', '')) || 0;
        let 怪物缓存评分 = 0;
        if (怪物缓存利用率 <= 20) {
            怪物缓存评分 = 50; // 优秀
        } else if (怪物缓存利用率 <= 40) {
            怪物缓存评分 = 40; // 良好
        } else if (怪物缓存利用率 <= 60) {
            怪物缓存评分 = 30; // 一般
        } else {
            怪物缓存评分 = 20; // 较差
        }

        // 装备缓存评分（30分）
        const 装备命中率 = parseFloat(装备缓存状态.命中率.replace('%', '')) || 0;
        let 装备缓存评分 = 0;
        if (装备命中率 >= 70) {
            装备缓存评分 = 30; // 优秀
        } else if (装备命中率 >= 50) {
            装备缓存评分 = 25; // 良好
        } else if (装备命中率 >= 30) {
            装备缓存评分 = 20; // 一般
        } else {
            装备缓存评分 = 15; // 较差
        }

        // 系统稳定性评分（20分）
        let 系统稳定性评分 = 20;
        if (怪物缓存状态.总数量 === 0) {
            系统稳定性评分 = 0;
            整体评估 = '异常';
            建议措施.push('🚨 立即检查怪物信息缓存问题');
        } else if (怪物缓存状态.缓存健康度 === '较差') {
            系统稳定性评分 = 10;
            整体评估 = '需要关注';
            建议措施.push('🔧 建议清理损坏的怪物信息数据');
        }

        if (系统清理效果 && !系统清理效果.怪物信息可用) {
            系统稳定性评分 -= 10;
            整体评估 = '异常';
            建议措施.push('⚠️ 怪物信息不可用，装备掉落可能无属性');
        }

        // 计算总评分
        清理效果评分 = 怪物缓存评分 + 装备缓存评分 + 系统稳定性评分;

        // 根据评分确定整体评估
        if (清理效果评分 >= 90) {
            整体评估 = '优秀';
            建议措施.push('🔥 实时清理系统运行优秀，性能卓越');
        } else if (清理效果评分 >= 75) {
            整体评估 = '良好';
            建议措施.push('✅ 实时清理系统运行良好，性能稳定');
        } else if (清理效果评分 >= 60) {
            整体评估 = '一般';
            建议措施.push('📊 实时清理系统基本正常，建议持续监控');
        } else {
            整体评估 = '需要关注';
            建议措施.push('⚠️ 实时清理系统效果不佳，建议检查配置');
        }

        // 具体建议
        建议措施.push(`📈 清理效果评分: ${清理效果评分}/100分`);
        建议措施.push(`🎯 怪物缓存利用率: ${怪物缓存状态.缓存利用率}`);
        建议措施.push(`⚡ 装备缓存命中率: ${装备缓存状态.命中率}`);
        建议措施.push('📝 建议定期运行此验证工具，监控清理效果');

        return {
            验证时间,
            怪物缓存状态,
            装备缓存状态,
            系统清理效果,
            整体评估,
            清理效果评分,
            建议措施
        };
    }
}

/**
 * 快速验证实时清理效果 - 在控制台中快速调用
 * @param Player 玩家对象（可选）
 */
export function 快速验证实时清理效果(Player?: TPlayObject): void {
    console.log('🔍 开始实时清理效果验证...');
    
    const 验证结果 = 实时清理效果验证器.执行完整验证(Player);
    
    console.log('📊 实时清理效果验证报告');
    console.log('='.repeat(60));
    console.log(`验证时间: ${验证结果.验证时间}`);
    console.log(`整体评估: ${验证结果.整体评估}`);
    console.log(`清理效果评分: ${验证结果.清理效果评分}/100分`);
    console.log('');
    
    console.log('🎯 怪物信息缓存状态:');
    console.log(`  总缓存数量: ${验证结果.怪物缓存状态.总数量}`);
    console.log(`  有效数量: ${验证结果.怪物缓存状态.有效数量}`);
    console.log(`  估算活跃怪物: ${验证结果.怪物缓存状态.估算活跃怪物数量}`);
    console.log(`  缓存利用率: ${验证结果.怪物缓存状态.缓存利用率}`);
    console.log(`  缓存健康度: ${验证结果.怪物缓存状态.缓存健康度}`);
    console.log('');
    
    console.log('⚡ 装备JSON缓存状态:');
    console.log(`  缓存数量: ${验证结果.装备缓存状态.缓存数量}`);
    console.log(`  命中率: ${验证结果.装备缓存状态.命中率}`);
    console.log(`  访问次数: ${验证结果.装备缓存状态.访问次数}`);
    console.log(`  缓存效率: ${验证结果.装备缓存状态.缓存效率}`);
    console.log(`  内存使用估算: ${验证结果.装备缓存状态.内存使用估算}`);
    console.log('');
    
    if (验证结果.系统清理效果) {
        console.log('🚀 系统清理效果状态:');
        console.log(`  玩家状态: ${验证结果.系统清理效果.玩家状态}`);
        console.log(`  怪物信息可用: ${验证结果.系统清理效果.怪物信息可用 ? '是' : '否'}`);
        console.log(`  装备掉落环境: ${验证结果.系统清理效果.装备掉落环境}`);
        console.log(`  实时清理状态: ${验证结果.系统清理效果.实时清理状态}`);
        console.log('');
    }
    
    console.log('💡 优化建议:');
    验证结果.建议措施.forEach(建议 => {
        console.log(`  ${建议}`);
    });
    
    console.log('='.repeat(60));
    console.log('✅ 验证完成');
}

// 兼容性：保留原函数名
export const 快速验证装备掉落 = 快速验证实时清理效果;

// ====================================== 使用示例 ======================================

/*
使用方法：

// 1. 快速验证实时清理效果（在控制台中）
import { 快速验证实时清理效果 } from './装备掉落测试验证';
快速验证实时清理效果(Player); // Player为可选参数

// 2. 详细验证
import { 实时清理效果验证器 } from './装备掉落测试验证';

// 检查怪物信息缓存状态
const 怪物缓存状态 = 实时清理效果验证器.检查怪物信息缓存状态();
console.log('怪物缓存状态:', 怪物缓存状态);

// 检查装备JSON缓存状态
const 装备缓存状态 = 实时清理效果验证器.检查装备缓存状态();
console.log('装备缓存状态:', 装备缓存状态);

// 检查系统清理效果
const 清理效果 = 实时清理效果验证器.检查系统清理效果(Player);
console.log('清理效果:', 清理效果);

// 执行完整验证
const 完整报告 = 实时清理效果验证器.执行完整验证(Player);
console.log('完整报告:', 完整报告);

// 3. 兼容性调用（保留原函数名）
import { 快速验证装备掉落 } from './装备掉落测试验证';
快速验证装备掉落(Player);

// 4. 实时监控示例
setInterval(() => {
    const 验证结果 = 实时清理效果验证器.执行完整验证();
    console.log(`实时清理评分: ${验证结果.清理效果评分}/100`);
    console.log(`怪物缓存利用率: ${验证结果.怪物缓存状态.缓存利用率}`);
    console.log(`装备缓存命中率: ${验证结果.装备缓存状态.命中率}`);
}, 300000); // 每5分钟检查一次

*/

import { 原始名字 , TAG } from "../功能脚本组/[怪物]/_M_Base";
import { 大数值整数简写, 随机小数 } from "../功能脚本组/[服务]/延时跳转";
import { _P_N_可复活次数, 技能ID, 特效, 永久特效 } from "../功能脚本组/[玩家]/_P_Base";

import { 实时回血, 攻击飘血, 血量显示 } from "./字符计算";
import { CheckBuffGroupID, 技能ID转换技能名称 } from "../功能脚本组/[功能]/_功能";
import * as 地图 from '../功能脚本组/[地图]/地图';
import { 智能计算, 转大数值  , js_百分比 , js_范围随机 , js_war} from "../大数值/核心计算方法";

// ==================== 受伤被动技能计算（从MagicNpc.ts整合） ====================

/**
 * 计算受伤时的被动技能效果（供外部调用）
 * @param Player 玩家对象
 * @param 伤害 受到的伤害值(字符串)
 * @returns 计算后的伤害值(字符串)
 */
export function 计算受伤被动(Player: TPlayObject, 伤害: string): string {
    const V = Player.V;
    const R = Player.R;
    let 最终伤害 = 伤害;

    // 血神 - 血气吸纳：被攻击1%几率恢复5%血量,每20级几率提高1%,(最高到40)
    if (V.职业 === '血神') {
        const 血气吸纳 = Player.FindSkill('血气吸纳');
        if (血气吸纳) {
            const 几率 = Math.min(1 + Math.floor(血气吸纳.Level / 20), 40);
            if (random(100) < 几率) {
                const 恢复量 = 智能计算(Player.GetSVar(92), '0.05', 3);
                实时回血(Player, 恢复量);
                Player.SendMessage(`【血气吸纳】触发! 恢复5%血量`, 2);
            }
        }
    }

    // 不动 - 铁布衫：提供20%格挡，每10级提高1%（50上限）
    if (V.职业 === '不动') {
        const 铁布衫 = Player.FindSkill('铁布衫');
        if (铁布衫) {
            const 格挡几率 = Math.min(20 + Math.floor(铁布衫.Level / 10), 50);
            if (random(100) < 格挡几率) {
                最终伤害 = '0';
                Player.SendMessage(`【铁布衫】格挡成功!`, 2);
            }
        }

        // 人王盾护盾吸收（使用大数值计算）
        if (R.人王盾护盾值 && R.人王盾护盾值 !== '0') {
            const 护盾剩余 = 智能计算(R.人王盾护盾值, 伤害, 2);
            // 判断护盾是否足够
            if (护盾剩余[0] !== '-') {
                R.人王盾护盾值 = 护盾剩余;
                最终伤害 = '0';
                Player.SendMessage(`【人王盾】吸收伤害,剩余护盾${大数值整数简写(R.人王盾护盾值)}`, 2);
            } else {
                // 护盾不足，计算溢出伤害
                最终伤害 = 智能计算(伤害, R.人王盾护盾值, 2);
                R.人王盾护盾值 = '0';
                Player.SetCustomEffect(永久特效.关闭, -1);
                Player.SendMessage(`【人王盾】护盾破碎!`, 2);
            }
        }
    }

    return 最终伤害;
}


// #region 地图伤害修正
/**
 * 地图伤害修正系数配置
 * 使用扁平化的Map结构提高查找效率
 */
const 地图伤害修正系数 = new Map<number, number>([

    [21 , 0.003],
    [22 , 0.001],
    [23 , 0.00001],
    [24 , 0.00001],
    [25 , 0.00001],
    [26 , 0.00001],
    [27 , 0.00001],
    [28 , 0.00001],
    [29 , 0.00001],
    [30 , 0.000001],
    [31 , 0.0000001],
    [32 , 0.00000003],
    [33 , 0.000000009],
    [34 , 0.0000000027],
    [35 , 0.00000000081],
    [36 , 0.000000000243],
    [37 , 0.0000000000729],
    [38 , 0.00000000002187],
    [39 , 0.000000000006561],
    [40 , 0.0000000000019683],
    [41 , 0.00000000000000001],
    [42 , 0.000000000000000001],
    // 其他等级地图配置.000..
]);

/**
 * 获取地图伤害修正系数 - 优化后的O(1)查找
 */
function 获取地图伤害修正(地图等级: number): number | null {
    return 地图伤害修正系数.get(地图等级) ?? null;
}
// #endregion

// #region 数值安全处理工具（优化版）
/**
 * 安全数值转换函数，防止NaN和无效值（优化：减少类型转换）
 */
const safeNumber = (value: any): number => {
    if (typeof value === 'number') return isNaN(value) ? 0 : value;
    const num = Number(value);
    return isNaN(num) ? 0 : num;
};

/**
 * 安全字符串数值转换（优化：提前返回，减少字符串操作）
 */
const 安全数值 = (value: any, defaultValue = '0'): string => {
    if (!value && value !== 0) return defaultValue;
    if (typeof value === 'string') {
        // 快速检查无效值
        const firstChar = value[0];
        if (firstChar === 'N' || firstChar === 'I' || firstChar === '-' && value[1] === 'I') {
            return defaultValue;
        }
        return value;
    }
    return String(value);
};

/**
 * 安全魔次数值转换（优化：减少重复检查）
 */
const 安全字符 = (value: any, defaultValue = '1'): string => {
    if (!value) return defaultValue;
    if (typeof value === 'string') {
        const firstChar = value[0];
        if (firstChar === 'N' || firstChar === 'I' || firstChar === '-') return defaultValue;
        return value;
    }
    const num = Number(value);
    return (isNaN(num) || num <= 0) ? defaultValue : String(value);
};

/**
 * 检查并修复无效的伤害值（优化：快速路径）
 */
const sanitizeDamage = (damage: string, fallback = '1'): string => {
    if (!damage) return fallback;
    const firstChar = damage[0];
    // 快速检查：N(NaN), I(Infinity), 0, -(负数)
    if (firstChar === 'N' || firstChar === 'I' || firstChar === '0' && damage.length === 1) {
        return fallback;
    }
    return damage;
};

// #endregion

// #region 常量定义
const 基本常量 = {
    最小攻击: '1',
    基础数值: '0',
    基础属性: '500',
} as const;

// #region 技能伤害配置
/**
 * 技能伤害计算配置类
 */
class 技能属性 {
    constructor(
        public baseMultiplier: number,
        public levelMultiplier: number,
        public hasSpecialEffect: boolean = false,
        public specialEffectHandler?: (player: TPlayObject, enemy: TActor) => void
    ) {}

    /**
     * 计算技能伤害
     */
    calculate(基础攻击: string, 技能等级: number, 额外魔次: string, 额外伤害: string, player?: TPlayObject, enemy?: TActor): string {
        if (this.hasSpecialEffect && this.specialEffectHandler && player && enemy) {
            this.specialEffectHandler(player, enemy);
        }
        return 计算技能基础伤害(基础攻击, 技能等级, this.baseMultiplier, this.levelMultiplier, 额外魔次, 额外伤害);
    }
}

/**
 * 技能配置映射表 - 根据_P_Base.ts定义和职业选择.ts描述
 */
const SKILL_CONFIGS = new Map<number, 技能属性>([
    // ========== 基础技能 ==========
    [技能ID.基础技能.攻杀剑术, new 技能属性(2, 0.2)],         // 200%基础,每级+20%
    [技能ID.基础技能.刺杀剑术, new 技能属性(2.5, 0.25)],      // 250%基础,每级+25%
    [技能ID.基础技能.半月弯刀, new 技能属性(1.5, 0.15)],      // 150%基础,每级+15%
    [技能ID.基础技能.雷电术, new 技能属性(2, 0.2)],           // 200%基础,每级+20%
    [技能ID.基础技能.暴风雪, new 技能属性(1, 0.1)],           // 100%基础,每级+10%
    [技能ID.基础技能.灵魂火符, new 技能属性(2, 0.2)],         // 200%基础,每级+20%
    [技能ID.基础技能.飓风破, new 技能属性(1.2, 0.12)],        // 120%基础,每级+12%
    [技能ID.基础技能.暴击术, new 技能属性(1.5, 0.15)],        // 150%基础,每级+15%
    [技能ID.基础技能.霜月, new 技能属性(1.5, 0.15)],          // 150%基础,每级+15%
    [技能ID.基础技能.精准箭术, new 技能属性(2, 0.2)],         // 200%基础,每级+20%
    [技能ID.基础技能.万箭齐发, new 技能属性(1.2, 0.12)],      // 120%基础,每级+12%
    [技能ID.基础技能.罗汉棍法, new 技能属性(1.5, 0.15)],      // 150%基础,每级+15%
    [技能ID.基础技能.天雷阵, new 技能属性(1.2, 0.12)],        // 120%基础,每级+12%
    
    // ========== 天枢职业 (10000-10004) ==========
    // 怒斩: 主动,对目标周围3码内所有敌人造成伤害200%,每级提高20%
    [技能ID.天枢.怒斩, new 技能属性(2, 0.2)],
    // 人之怒: 被动,攻击时20%几率使你造成得伤害额外提高400%,每级提高40%
    [技能ID.天枢.人之怒, new 技能属性(4, 0.4)],
    // 地之怒: 被动,攻击时10%几率使你造成得伤害额外提高600%,每级提高60%
    [技能ID.天枢.地之怒, new 技能属性(6, 0.6)],
    // 天之怒: 被动,攻击时5%几率使你造成得伤害额外提高800%,每级提高80%
    [技能ID.天枢.天之怒, new 技能属性(8, 0.8)],
    // 神之怒: 被动,攻击时1%几率使你造成得伤害额外提高1000%,每级提高100%
    [技能ID.天枢.神之怒, new 技能属性(10, 1.0)],
    
    // ========== 血神职业 (10005-10009) ==========
    // 血气献祭: 主动,消耗1%的生命,对目标造成500%的伤害,每级提高50%
    [技能ID.血神.血气献祭, new 技能属性(5, 0.5)],
    // 血气燃烧: 开启后,每秒对周围5码范围内敌人造成150%的伤害,每级提高15%
    [技能ID.血神.血气燃烧, new 技能属性(1.5, 0.15)],
    // 血气吸纳: 被动,被攻击1%几率恢复5%血量,每20级几率提高1%
    [技能ID.血神.血气吸纳, new 技能属性(1, 0.01)],
    // 血气迸发: 被动,攻击时可吸取造成伤害的1‰转化为生命,每级提高1‰
    [技能ID.血神.血气迸发, new 技能属性(1, 0.001)],
    // 血魔临身: 开启后,使你的攻击额外提高150%,每级提高5%
    [技能ID.血神.血魔临身, new 技能属性(1.5, 0.05)],
    
    // ========== 暗影职业 (10010-10014) ==========
    // 暗影猎取: 被动,攻击1%的几率获取暗影点
    [技能ID.暗影.暗影猎取, new 技能属性(1, 0.01)],
    // 暗影袭杀: 主动,对目标造成500%伤害,每级提高50%
    [技能ID.暗影.暗影袭杀, new 技能属性(5, 0.5)],
    // 暗影剔骨: 开启后,对周围6码范围内敌人造成300%伤害,每级提高30%
    [技能ID.暗影.暗影剔骨, new 技能属性(3, 0.3)],
    // 暗影风暴: 主动,对目标范围5码内敌人造成400%伤害,每级提高40%
    [技能ID.暗影.暗影风暴, new 技能属性(4, 0.4)],
    // 暗影附体: 主动,使暗影袭杀的攻击提高至1000%
    [技能ID.暗影.暗影附体, new 技能属性(10, 0)],
    
    // ========== 烈焰职业 (10015-10019) ==========
    // 火焰追踪: 主动,对目标造成200%伤害,每级提高20%
    [技能ID.烈焰.火焰追踪, new 技能属性(2, 0.2)],
    // 火镰狂舞: 被动,每10级可为火焰追踪的目标增加一个
    [技能ID.烈焰.火镰狂舞, new 技能属性(1, 0)],
    // 烈焰护甲: 开启后,每2秒对周围4格内的目标造成300%伤害,每级提高30%
    [技能ID.烈焰.烈焰护甲, new 技能属性(3, 0.3)],
    // 爆裂火冢: 被动,击中目标20%几率造成8格范围300%伤害,每级提高30%
    [技能ID.烈焰.爆裂火冢, new 技能属性(3, 0.3)],
    // 烈焰突袭: 被动,每攻击5次,使你下次伤害提升至200%,每重+20%
    [技能ID.烈焰.烈焰突袭, new 技能属性(2, 0.2)],
    
    // ========== 正义职业 (10020-10024) ==========
    // 正义(圣光): 开启后,每秒对周围5码内所有目标造成200%伤害,每级提高20%
    [技能ID.正义.圣光, new 技能属性(2, 0.2)],
    // 行刑: 被动,对普通怪物的伤害增加200%，每级提高20%
    [技能ID.正义.行刑, new 技能属性(2, 0.2)],
    // 洗礼: 被动,对精英以上怪物的伤害增加100%，每级提高10%
    [技能ID.正义.洗礼, new 技能属性(1, 0.1)],
    // 审判: 被动,对满血目标造成10%血量切割，每20级+1%切割,封顶40%
    [技能ID.正义.审判, new 技能属性(1, 0)],
    // 神罚: 被动,攻击10%几率使目标遭受神罚，损失当前生命的1%，每40级+1%
    [技能ID.正义.神罚, new 技能属性(1, 0)],
    
    // ========== 不动职业 (10025-10029) ==========
    // 如山: 开启后,每秒对周围5码内造成400%伤害,每级提高40%
    [技能ID.不动.如山, new 技能属性(4, 0.4)],
    // 泰山: 被动,主属性提高30%,每级增加3%
    [技能ID.不动.泰山, new 技能属性(1.3, 0.03)],
    // 人王盾: 主动,释放技能提供一个防御上限值1000%的护盾，每级提高100%
    [技能ID.不动.人王盾, new 技能属性(10, 1)],
    // 铁布衫: 被动,提供20%格挡，每10级提高1%（50上限）
    [技能ID.不动.铁布衫, new 技能属性(1, 0)],
    // 金刚掌: 主动,对目标周围8格范围造成500%伤害,并麻痹目标3秒,每级提高50%
    [技能ID.不动.金刚掌, new 技能属性(5, 0.5, true, (_player, enemy) => {
        enemy.SetState(5, 3, 0); // 麻痹3秒
    })],
]);

// 职业被动技能触发几率常量（根据职业选择.ts描述）
const 被动触发几率 = {
    人之怒: 20,    // 20%几率
    地之怒: 10,    // 10%几率
    天之怒: 5,     // 5%几率
    神之怒: 1,     // 1%几率
    暗影猎取: 1,   // 1%几率获取暗影点
    神罚: 10,      // 10%几率
    爆裂火冢: 20   // 20%几率
} as const;


/**
 * 技能属性获取器 - 根据_P_Base.ts定义
 * 返回: { 等级, 魔次, 伤害 }
 */
const getSkillAttributes = (自己: TPlayObject, 技能序号: number) => {
    const V = 自己.V;
    const R = 自己.R;

    switch (技能序号) {
        // ========== 基础技能 ==========
        case 技能ID.基础技能.攻杀剑术: return { 等级: V.攻杀剑术等级 || 1, 魔次: R.攻杀剑术魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.刺杀剑术: return { 等级: V.刺杀剑术等级 || 1, 魔次: R.刺杀剑术魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.半月弯刀: return { 等级: V.半月弯刀等级 || 1, 魔次: R.半月弯刀魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.雷电术: return { 等级: V.雷电术等级 || 1, 魔次: R.雷电术魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.暴风雪: return { 等级: V.暴风雪等级 || 1, 魔次: R.暴风雪魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.灵魂火符: return { 等级: V.灵魂火符等级 || 1, 魔次: R.灵魂火符魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.飓风破: return { 等级: V.飓风破等级 || 1, 魔次: R.飓风破魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.暴击术: return { 等级: V.暴击术等级 || 1, 魔次: R.暴击术魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.霜月: return { 等级: V.霜月等级 || 1, 魔次: R.霜月魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.精准箭术: return { 等级: V.精准箭术等级 || 1, 魔次: R.精准箭术魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.万箭齐发: return { 等级: V.万箭齐发等级 || 1, 魔次: R.万箭齐发魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.罗汉棍法: return { 等级: V.罗汉棍法等级 || 1, 魔次: R.罗汉棍法魔次 || '1', 伤害: '0' };
        case 技能ID.基础技能.天雷阵: return { 等级: V.天雷阵等级 || 1, 魔次: R.天雷阵魔次 || '1', 伤害: '0' };
        
        // ========== 天枢职业 ==========
        case 技能ID.天枢.怒斩: return { 等级: V.怒斩等级 || 1, 魔次: R.怒斩魔次 || '1', 伤害: '0' };
        case 技能ID.天枢.人之怒: return { 等级: V.人之怒等级 || 1, 魔次: '1', 伤害: '0' };
        case 技能ID.天枢.地之怒: return { 等级: V.地之怒等级 || 1, 魔次: '1', 伤害: '0' };
        case 技能ID.天枢.天之怒: return { 等级: V.天之怒等级 || 1, 魔次: '1', 伤害: '0' };
        case 技能ID.天枢.神之怒: return { 等级: V.神之怒等级 || 1, 魔次: '1', 伤害: '0' };
        
        // ========== 血神职业 ==========
        case 技能ID.血神.血气献祭: return { 等级: V.血气献祭等级 || 1, 魔次: R.血气献祭魔次 || '1', 伤害: '0' };
        case 技能ID.血神.血气燃烧: return { 等级: V.血气燃烧等级 || 1, 魔次: R.血气燃烧魔次 || '1', 伤害: '0' };
        case 技能ID.血神.血气吸纳: return { 等级: V.血气吸纳等级 || 1, 魔次: R.血气吸纳魔次 || '1', 伤害: '0' };
        case 技能ID.血神.血气迸发: return { 等级: V.血气迸发等级 || 1, 魔次: R.血气迸发魔次 || '1', 伤害: '0' };
        case 技能ID.血神.血魔临身: return { 等级: V.血魔临身等级 || 1, 魔次: '1', 伤害: '0' };
        
        // ========== 暗影职业 ==========
        case 技能ID.暗影.暗影猎取: return { 等级: V.暗影猎取等级 || 1, 魔次: R.暗影猎取魔次 || '1', 伤害: '0' };
        case 技能ID.暗影.暗影袭杀: return { 等级: V.暗影袭杀等级 || 1, 魔次: R.暗影袭杀魔次 || '1', 伤害: '0' };
        case 技能ID.暗影.暗影剔骨: return { 等级: V.暗影剔骨等级 || 1, 魔次: R.暗影剔骨魔次 || '1', 伤害: '0' };
        case 技能ID.暗影.暗影风暴: return { 等级: V.暗影风暴等级 || 1, 魔次: R.暗影风暴魔次 || '1', 伤害: '0' };
        case 技能ID.暗影.暗影附体: return { 等级: V.暗影附体等级 || 1, 魔次: '1', 伤害: '0' };
        
        // ========== 烈焰职业 ==========
        case 技能ID.烈焰.火焰追踪: return { 等级: V.火焰追踪等级 || 1, 魔次: R.火焰追踪魔次 || '1', 伤害: '0' };
        case 技能ID.烈焰.火镰狂舞: return { 等级: V.火镰狂舞等级 || 1, 魔次: R.火镰狂舞魔次 || '1', 伤害: '0' };
        case 技能ID.烈焰.烈焰护甲: return { 等级: V.烈焰护甲等级 || 1, 魔次: R.烈焰护甲魔次 || '1', 伤害: '0' };
        case 技能ID.烈焰.爆裂火冢: return { 等级: V.爆裂火冢等级 || 1, 魔次: R.爆裂火冢魔次 || '1', 伤害: '0' };
        case 技能ID.烈焰.烈焰突袭: return { 等级: V.烈焰突袭等级 || 1, 魔次: R.烈焰突袭魔次 || '1', 伤害: '0' };
        
        // ========== 正义职业 ==========
        case 技能ID.正义.圣光: return { 等级: V.圣光等级 || 1, 魔次: R.圣光魔次 || '1', 伤害: '0' };
        case 技能ID.正义.行刑: return { 等级: V.行刑等级 || 1, 魔次: R.行刑魔次 || '1', 伤害: '0' };
        case 技能ID.正义.洗礼: return { 等级: V.洗礼等级 || 1, 魔次: R.洗礼魔次 || '1', 伤害: '0' };
        case 技能ID.正义.审判: return { 等级: V.审判等级 || 1, 魔次: R.审判魔次 || '1', 伤害: '0' };
        case 技能ID.正义.神罚: return { 等级: V.神罚等级 || 1, 魔次: R.神罚魔次 || '1', 伤害: '0' };
        
        // ========== 不动职业 ==========
        case 技能ID.不动.如山: return { 等级: V.如山等级 || 1, 魔次: R.如山魔次 || '1', 伤害: '0' };
        case 技能ID.不动.泰山: return { 等级: V.泰山等级 || 1, 魔次: R.泰山魔次 || '1', 伤害: '0' };
        case 技能ID.不动.人王盾: return { 等级: V.人王盾等级 || 1, 魔次: '1', 伤害: '0' };
        case 技能ID.不动.铁布衫: return { 等级: V.铁布衫等级 || 1, 魔次: '1', 伤害: '0' };
        case 技能ID.不动.金刚掌: return { 等级: V.金刚掌等级 || 1, 魔次: R.金刚掌魔次 || '1', 伤害: '0' };
        
        default: return undefined;
    }
};
// #endregion

/**
 * 检查攻击是否合法（优化版）
 */
function 检查攻击合法性(自己: TActor, 敌人: TActor): boolean {
    // 优化：快速路径 - 基础检查
    if (!自己 || !敌人 || 自己.Handle === 敌人.Handle) return false;
    if (自己.GetDeath() || 敌人.GetDeath()) return false;
    if (自己.GetInSafeZone() || 敌人.GetInSafeZone()) return false;

    // 优化：主人检查
    const 自己主人 = 自己.Master;
    const 敌人主人 = 敌人.Master;
    if (自己主人 && 敌人主人 && 自己主人.Name === 敌人主人.Name) return false;
    if (敌人主人?.Handle === 自己.Handle) return false;

    // 玩家特殊检查
    if (自己.IsPlayer()) {
        const aPlayer = 自己 as TPlayObject;
        const 攻击模式 = aPlayer.GetAttackMode();

        // 优化：和平模式检查
        if (攻击模式 === 1 && (敌人.IsPlayer() || 敌人主人 != null)) return false;

        // 优化：善恶模式检查
        if (攻击模式 === 6 && 敌人.IsPlayer() && 敌人.GetPkLevel() < 2) return false;

        // 优化：行会模式检查
        if (攻击模式 === 5 && aPlayer.Guild && 敌人.Guild && aPlayer.Guild.Name === 敌人.Guild.Name) return false;

        // 优化：组队模式检查
        if (攻击模式 === 4 && aPlayer.GroupOwner && 敌人.IsPlayer()) {
            const 敌人Handle = 敌人.Handle;
            for (let i = 0; i < aPlayer.GroupCount; i++) {
                const member = aPlayer.GetGroupMember(i);
                if (member?.Handle === 敌人Handle) return false;
            }
        }

        // 优化：宠物检查（缓存Handle）
        const 敌人Handle = 敌人.Handle;
        for (let i = 0; i <= aPlayer.SlaveCount; i++) {
            const slave = aPlayer.GetSlave(i);
            if (slave?.Handle === 敌人Handle) return false;
        }
    }

    return true;
}

/**
 * 计算技能的基础伤害（优化版）
 * @param 基础攻击 基础攻击力
 * @param 等级 技能等级
 * @param 基础倍率 基础伤害倍率
 * @param 等级倍率 每级增加的倍率
 * @param 额外魔次 额外魔次加成
 * @param 额外伤害 额外固定伤害
 * @returns 计算后的伤害值
 */
function 计算技能基础伤害(基础攻击: string, 等级: number, 基础倍率: number, 等级倍率: number, 额外魔次: string, 额外伤害: string): string {
    // 优化：使用安全处理工具验证输入参数
    基础攻击 = sanitizeDamage(基础攻击, 基本常量.最小攻击);

    // 优化：减少函数调用，直接计算
    const 安全等级 = safeNumber(等级);
    const 安全基础倍率 = safeNumber(基础倍率) || 1;
    const 安全等级倍率 = safeNumber(等级倍率);
    const 安全额外魔次 = 安全字符(额外魔次, '1');
    const 安全额外伤害 = 安全数值(额外伤害, 基本常量.基础数值);

    // 优化：计算总倍率（确保至少为1）
    const 总倍率值 = 安全基础倍率 + 安全等级 * 安全等级倍率;
    const 总倍率 = String(Math.max(总倍率值, 1));

    // 优化：链式计算最终伤害
    let 伤害 = 智能计算(基础攻击, 总倍率, 3);
    伤害 = 智能计算(伤害, 安全额外伤害, 1);
    伤害 = 智能计算(伤害, 安全额外魔次, 3);
    伤害 = 智能计算(伤害, 基础攻击, 1);

    return sanitizeDamage(伤害, 基本常量.最小攻击);
}

function 计算玩家伤害(自己: TPlayObject, 敌人: TActor, 技能序号: number): string {
    // 优化：缓存常用属性访问
    const V = 自己.V;
    const R = 自己.R;

    // 直接获取怪物属性
    const 地图等级 = 地图.地图ID取固定星级(敌人.Map.MapID);
    const 敌人防御最小 = 敌人.GetSVar(95);
    const 敌人防御最大 = 敌人.GetSVar(96);

    // 计算敌人防御（应用物理穿透）
    let 敌人防御 = js_范围随机(敌人防御最小, 敌人防御最大);
    if (js_war(敌人防御, '0') <= 0) {
        敌人防御 = '0';
    }

    // 确保自定属性对象已初始化
    if (!R.自定属性 || typeof R.自定属性 !== 'object') {
        R.自定属性 = {};
        // 初始化所有职业的默认攻击值
        for (let i = 161; i <= 166; i++) {
            R.自定属性[i] = 基本常量.基础属性;
        }
    }

    // 安全获取并验证攻击值
    const 最大攻击 = 安全数值(R.自定属性[自己.Job + 161], 基本常量.基础属性);

    // 先计算 玩家攻击 - 怪物防御
    let 基础伤害 = 智能计算(最大攻击, 敌人防御, 2);
    if (js_war(基础伤害, '0') <= 0) {
        基础伤害 = '1';
    }

    // 基础攻击 = 基础伤害
    let 基础攻击 = 基础伤害;

    // 确保最小伤害（使用安全处理工具）
    基础攻击 = sanitizeDamage(基础攻击, 基本常量.最小攻击);

    let 技能攻击 = 基础攻击;


    // 使用新的技能配置系统计算伤害
    const skillConfig = SKILL_CONFIGS.get(技能序号);
    if (skillConfig) {
        const 技能属性 = getSkillAttributes(自己, 技能序号);
        if (技能属性) {
            技能攻击 = skillConfig.calculate(基础攻击, 技能属性.等级, 技能属性.魔次, 技能属性.伤害, 自己, 敌人);
        } else {
            技能攻击 = 智能计算(智能计算(基础攻击, String(R.所有技能等级), 3), 基础攻击, 1);
        }
    } else {
        // 未配置的技能使用默认计算
        技能攻击 = 智能计算(智能计算(基础攻击, String(R.所有技能等级), 3), 基础攻击, 1);
    }

    // 特殊技能处理
    if (技能序号 === 10000) {
        // return 转大数值('5e50');
    }

    // ========== 六大职业被动技能触发（优化版） ==========
    const 职业 = V.职业;
    if (职业) {
        switch (职业) {
            case '天枢': {
                // 天枢被动：几率触发额外伤害（从高到低判断，只触发一个）
                const rand = random(100);
                if (rand < 被动触发几率.神之怒) {
                    const 等级 = V.神之怒等级 || 1;
                    技能攻击 = 智能计算(技能攻击, String(10 + 等级), 3);
                    自己.SendCountDownMessage(`【神之怒】触发！`, 0);
                } else if (rand < 被动触发几率.天之怒) {
                    const 等级 = V.天之怒等级 || 1;
                    技能攻击 = 智能计算(技能攻击, String(8 + 等级 * 0.8), 3);
                    自己.SendCountDownMessage(`【天之怒】触发！`, 0);
                } else if (rand < 被动触发几率.地之怒) {
                    const 等级 = V.地之怒等级 || 1;
                    技能攻击 = 智能计算(技能攻击, String(6 + 等级 * 0.6), 3);
                    自己.SendCountDownMessage(`【地之怒】触发！`, 0);
                } else if (rand < 被动触发几率.人之怒) {
                    const 等级 = V.人之怒等级 || 1;
                    技能攻击 = 智能计算(技能攻击, String(4 + 等级 * 0.4), 3);
                    自己.SendCountDownMessage(`【人之怒】触发！`, 0);
                }
                break;
            }
            case '血神': {
                // 血气迸发：吸血
                const 等级 = V.血气迸发等级 || 1;
                const 吸血千分比 = Math.min(1 + 等级, 2000);
                const 吸血量 = 智能计算(技能攻击, String(吸血千分比 / 1000), 3);
                if (js_war(自己.GetSVar(91), 自己.GetSVar(92)) < 0) {
                    实时回血(自己, 吸血量);
                }
                // 血魔临身状态加成
                if (R.血魔临身) {
                    const 血魔等级 = V.血魔临身等级 || 1;
                    技能攻击 = 智能计算(技能攻击, String(1.5 + 血魔等级 * 0.05), 3);
                }
                break;
            }
            case '暗影': {
                // 暗影猎取：1%几率获取暗影点
                if (random(100) < 被动触发几率.暗影猎取) {
                    const 等级 = V.暗影猎取等级 || 1;
                    const 上限 = Math.floor(等级 / 5) + 100;
                    R.暗影点 = Math.min((R.暗影点 || 0) + 1, 上限);
                    自己.SendCountDownMessage(`获得暗影点！当前:${R.暗影点}/${上限}`, 0);
                }
                // // 暗影点加成
                // if (R.暗影点 > 0) {
                //     技能攻击 = 智能计算(技能攻击, String(1 + R.暗影点 * 0.01), 3);
                // }
                // 暗影附体状态
                if (R.暗影附体 && 技能序号 === 技能ID.暗影.暗影袭杀) {
                    技能攻击 = 智能计算(技能攻击, '2', 3);
                }
                break;
            }
            case '烈焰': {
                // 烈焰突袭：每5次攻击触发
                R.烈焰突袭计数 = (R.烈焰突袭计数 || 0) + 1;
                if (R.烈焰突袭计数 >= 5) {
                    R.烈焰突袭计数 = 0;
                    const 等级 = V.烈焰突袭等级 || 1;
                    技能攻击 = 智能计算(技能攻击, String(2 + 等级 * 0.2), 3);
                    自己.SendCountDownMessage(`【烈焰突袭】触发！`, 0);
                }
                // 爆裂火冢：20%几率触发特效
                if (random(100) < 被动触发几率.爆裂火冢) {
                    敌人.ShowEffectEx2(特效.爆裂火冢, -10, 25, true, 1);
                }
                break;
            }
            case '正义': {
                // 判断怪物类型
                const 怪物类型: number = 敌人.GetNVar(TAG) % 10; 
                // const 是精英怪 = 怪物名称.includes('精英') || 怪物名称.includes('BOSS') || 怪物名称.includes('首领');
                // 行刑/洗礼
                if (怪物类型 === 1 || 怪物类型 === 2) {
                    const 等级 = V.行刑等级 || 1;
                    技能攻击 = 智能计算(技能攻击, String(2 + 等级 * 0.2), 3);
                } else {
                    const 等级 = V.洗礼等级 || 1;
                    技能攻击 = 智能计算(技能攻击, String(1 + 等级 * 0.1), 3);
                }
                // 审判：对满血目标切割
                const 敌人当前血量 = 敌人.GetSVar(91);
                const 敌人最大血量 = 敌人.GetSVar(92);
                if (js_war(敌人当前血量, 敌人最大血量) >= 0) {
                    const 等级 = V.审判等级 || 1;
                    const 切割比例 = Math.min(10 + Math.floor(等级 / 20), 40) / 100;
                    技能攻击 = 智能计算(技能攻击, 智能计算(敌人最大血量, String(切割比例), 3), 1);
                }
                // 神罚：10%几率
                if (random(100) < 被动触发几率.神罚) {
                    const 等级 = V.神罚等级 || 1;
                    const 比例 = (1 + Math.floor(等级 / 40)) / 100;
                    技能攻击 = 智能计算(技能攻击, 智能计算(敌人当前血量, String(比例), 3), 1);
                    自己.SendCountDownMessage(`【神罚】触发！`, 0);
                }
                break;
            }
            case '不动': {
                // 泰山：主属性加成
                const 等级 = V.泰山等级 || 1;
                技能攻击 = 智能计算(技能攻击, String(1.3 + 等级 * 0.03), 3);
                break;
            }
        }
    }

    // 地图伤害修正
    const 修正 = 获取地图伤害修正(地图等级);
    if (修正 !== null) {
        技能攻击 = 智能计算(技能攻击, String(修正), 3);
    }


    // 暴击计算（优化：减少嵌套函数调用）
    const 暴击几率值 = Number(R.暴击几率) || 0;
    if (暴击几率值 > 0 && random(100) < 暴击几率值) {
        const 暴击倍率 = 智能计算(R.暴击倍率, '2', 1);
        技能攻击 = 智能计算(技能攻击, 暴击倍率, 3);
    }

    // GM秒怪功能
    if (V.我要秒怪) {
        // return `999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999`;
        return 转大数值('5e50')
    }
    if(自己.IsAdmin && 技能序号 == 10000){return 转大数值('1e2')}

    return 技能攻击;
}


function 处理怪物对玩家伤害(自己: TActor, 敌人: TPlayObject): string {
    // 优化：缓存常用属性访问
    const EV = 敌人.V;
    const ER = 敌人.R;

    // 直接获取地图等级
    const 地图等级 = 地图.地图ID取固定星级(敌人.GetMap().MapID);

    // 安全获取怪物的攻击力
    const 怪物最小攻击 = 安全数值(自己.GetSVar(93), 基本常量.最小攻击);
    const 怪物最大攻击 = 安全数值(自己.GetSVar(94), 基本常量.最小攻击);
    let 怪物攻击 = js_范围随机(怪物最小攻击, 怪物最大攻击);

    // 高等级地图怪物攻击加成
    if (地图等级 > 20) {
        怪物攻击 = 智能计算(怪物攻击, '10', 3);
    }

    // 安全获取玩家的防御力
    let 敌人防御 = 安全数值(敌人.GetSVar(96), 基本常量.基础数值);


    // 计算伤害 = 怪物攻击 - 玩家防御
    let 字符最终攻击 = js_war(怪物攻击, 敌人防御) <= 0 ? 基本常量.最小攻击 : 智能计算(怪物攻击, 敌人防御, 2);
    字符最终攻击 = sanitizeDamage(字符最终攻击, 基本常量.最小攻击);

    // 确保最小伤害
    if (js_war(字符最终攻击, '1') < 0) {
        字符最终攻击 = '1';
    }

    return 字符最终攻击;
}

export function 计算伤害(自己: TActor, 敌人: TActor, 技能序号: number, _伤害倍数?: number): any {
    // 优化：快速路径 - 提前检查合法性
    if (!检查攻击合法性(自己, 敌人)) {
        return 0;
    }

    if (自己.IsPlayer() && 技能序号 < 0) {
        return 0;
    }

    let 最终伤害 = '0';

    // 优化：根据攻击者类型计算伤害
    const 是玩家 = 自己.IsPlayer();

    if (是玩家) {
        最终伤害 = 计算玩家伤害(自己 as TPlayObject, 敌人, 技能序号);
    } else { // 怪物攻击
        if (敌人.IsPlayer()) {
            最终伤害 = 处理怪物对玩家伤害(自己, 敌人 as TPlayObject);
            // 应用玩家受伤被动技能（血气吸纳、铁布衫、人王盾等）
            最终伤害 = 计算受伤被动(敌人 as TPlayObject, 最终伤害);
        } 
    }

    // 优化：使用快速检查无效值
    if (!最终伤害 || 最终伤害[0] === 'N' || 最终伤害[0] === 'I') {
        最终伤害 = 基本常量.基础数值;
    }

    // 确保伤害不为负数
    if (js_war(最终伤害, 基本常量.最小攻击) < 0) {
        最终伤害 = 基本常量.基础数值;
    }

  
    // 优化：伤害提示显示 - 只在需要时计算技能名字
    if (是玩家) {
        const 玩家 = 自己 as TPlayObject;
        if (!玩家.V.伤害屏蔽) {
            const 技能名字 = 技能ID转换技能名称(技能序号);
            const 伤害简写 = 大数值整数简写(最终伤害);
            const 玩家名 = 玩家.GetName();
            const 位数 = 最终伤害.length;
            玩家.SendMessage(`【伤害提示】:{S=${玩家名};C=22} 使用 {s=${技能名字};C=22} 攻击目标造成伤害 {S=${伤害简写};C=22} {s=(${位数});c=9} 位`, 2);
        }
    } 
    

    // 伤害应用和死亡判定
    if (!CheckBuffGroupID(敌人, 1011)) { // 目标不处于无敌状态
        // 直接获取敌人血量
        const 敌人血量 = 安全数值(敌人.GetSVar(91), 基本常量.最小攻击);
        let 剩余血量 = 智能计算(敌人血量, 最终伤害, 2);

        // 确保血量不为负数
        剩余血量 = js_war(剩余血量, 基本常量.基础数值) < 0 ? 基本常量.基础数值 : 剩余血量;

        // 应用伤害效果
        攻击飘血(敌人, 最终伤害);
        敌人.SetSVar(91, 剩余血量);
        血量显示(敌人);

        // 死亡判定
        if (js_war(剩余血量, 基本常量.基础数值) <= 0) {
            敌人.GoDie(自己, 自己);

            if (!敌人.IsPlayer()) {
                // 清理怪物信息缓存
                try {
                    const 怪物Handle = 敌人.Handle;
                    const 怪物Handle字符串 = String(怪物Handle);
                    if (GameLib.R?.怪物信息?.[怪物Handle字符串]) {
                        delete GameLib.R.怪物信息[怪物Handle字符串];
                    }
                } catch {
                    // 忽略清理错误
                }
                敌人.MakeGhost();
            }
        }
    }

    return;
}



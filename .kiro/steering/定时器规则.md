---
inclusion: always
---

# RobotManageNpc 定时器调用规则

## 概述
RobotManageNpc.ts 是游戏引擎的定时任务管理器，所有定时执行的逻辑都应该通过它来实现。

## ❌ 错误用法
```typescript
// 永远不要使用这些
setTimeout(() => {}, 1000);
setInterval(() => {}, 5000);
```

## ✅ 正确用法

### 1. 个人定时器（针对单个玩家）

```typescript
// 每秒执行一次（针对每个在线玩家）
export function 个人1秒(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 你的逻辑
}

// 每10秒执行一次（针对每个在线玩家）
export function 个人10秒(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 你的逻辑
}
```

### 2. 全局定时器（全服务器执行一次）

```typescript
// 每秒执行一次（全局）
export function 全局1秒(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 你的逻辑
}

// 每30秒执行一次（全局）
export function 刷怪30秒(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 你的逻辑
}

// 每1分钟执行一次（全局）
export function 全局1分钟(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 你的逻辑
}
```

### 3. 每日清理定时器

```typescript
// 每天0点执行（全局）
export function 全局每日清理(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 清理全局数据
}

// 每天0点执行（针对每个玩家）
export function 个人每日清理(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    // 清理玩家数据
}
```

## 时间计算规则

### 使用计数器而非时间函数

```typescript
// ✅ 推荐：使用计数器
GameLib.V.开区分钟数 ??= 0
GameLib.V.开区分钟数++  // 每分钟+1

if (GameLib.V.开区分钟数 >= 10080) {  // 7天 = 10080分钟
    // 执行逻辑
}

// ❌ 不推荐：频繁调用时间函数（高CPU消耗）
const 当前时间 = Now()
const 天数 = DaysBetween(当前时间, 开区时间)
```

### 常用时间换算

- 1分钟 = 60秒
- 1小时 = 60分钟 = 3600秒
- 1天 = 24小时 = 1440分钟 = 86400秒
- 7天 = 168小时 = 10080分钟

## 性能优化技巧

### 1. 使用计数器减少执行频率

```typescript
export function 个人1秒(Npc: TNormNpc, Player: TPlayObject, Args: TArgs): void {
    Player.R.性能计数器 ??= 0
    Player.R.性能计数器++
    
    // 每5秒执行一次
    if (Player.R.性能计数器 % 5 === 0) {
        // 你的逻辑
    }
    
    // 每10秒执行一次
    if (Player.R.性能计数器 % 10 === 0) {
        // 你的逻辑
    }
}
```

### 2. 只在需要时执行

```typescript
// ✅ 好的做法：条件判断后再执行
if (GameLib.V.是新区 === true) {
    GameLib.V.开区分钟数++
    // 只在新区时才计数
}

// ❌ 不好的做法：每次都执行
GameLib.V.开区分钟数++
if (GameLib.V.是新区 === false) {
    return  // 浪费了一次计数
}
```

## 注意事项

1. **函数命名规范**：必须按照引擎要求的函数名命名（如 `个人1秒`、`全局1分钟`）
2. **参数固定**：所有定时器函数必须包含 `(Npc: TNormNpc, Player: TPlayObject, Args: TArgs)` 参数
3. **避免阻塞**：定时器函数内不要有耗时操作，保持快速执行
4. **使用计数器**：优先使用计数器而非时间函数来计算时间间隔
5. **条件判断**：在执行前先判断条件，避免无效计算

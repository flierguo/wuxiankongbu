# Implementation Plan: 怪物属性与装备属性系统

## Overview

本实现计划将在 `_核心部分` 文件夹中创建新的脚本文件，实现怪物属性系统、装备属性系统、属性统计器和伤害计算器。所有数值运算使用字符串格式和大数值计算引擎，确保支持999京范围内的数值。

## Tasks

- [ ] 1. 创建核心常量和类型定义
  - [x] 1.1 创建 `_核心部分/怪物装备常量.ts` 文件
    - 定义怪物TAG类型枚举和属性倍率配置
    - 定义基础属性ID映射（31-38）
    - 定义技能魔次ID范围和分组配置
    - 定义装备颜色和品质枚举
    - _Requirements: 1.1-1.6, 5.2, 6.2-6.4_

  - [x] 1.2 创建 `_核心部分/怪物装备类型.ts` 文件
    - 定义怪物数据接口 IMonsterData
    - 定义装备属性接口 IEquipmentAttribute
    - 定义玩家属性接口 IPlayerAttributeData
    - 所有数值字段使用 string 类型
    - _Requirements: 8.2, 8.3, 9.3_

- [ ] 2. 实现怪物属性系统
  - [x] 2.1 创建 `_核心部分/怪物属性系统.ts` 文件
    - 实现 `获取TAG类型(tag: number)` 函数
    - 实现 `计算属性倍率(tagType: MonsterTAG)` 函数
    - 实现 `赋予怪物属性(monster, tag, baseHP, baseDC, baseAC)` 函数
    - 使用 SVar[91-94] 存储怪物属性
    - 所有数值使用字符串和大数值计算
    - _Requirements: 1.1-1.7_

  - [x] 2.2 编写属性测试：TAG分类属性倍率正确性
    - **Property 1: TAG分类属性倍率正确性**
    - **Validates: Requirements 1.1, 1.2, 1.3, 1.4, 1.5, 1.6**

  - [x] 2.3 实现怪物变异系统
    - 实现 `判定变异(monster, mutationRate)` 函数
    - 实现 `应用变异效果(monster, mutationTypes)` 函数
    - 变异倍率范围 2-5 倍
    - 变异效果数量 1-3 种
    - _Requirements: 2.1-2.5_

  - [x] 2.4 编写属性测试：变异系统属性倍率
    - **Property 3: 变异系统属性倍率**
    - **Validates: Requirements 2.2, 2.3**

  - [x] 2.5 实现怪物技能分配
    - 实现 `分配怪物技能(monster, skillCount)` 函数
    - 精英/BOSS 几率获得 1-2 个技能
    - 存储技能ID和释放几率
    - _Requirements: 3.1-3.5_

- [x] 3. Checkpoint - 确保怪物系统测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 4. 实现装备属性系统
  - [x] 4.1 创建 `_核心部分/装备属性系统.ts` 文件
    - 实现 `生成基础属性(monsterDC, count)` 函数
    - 随机生成 1-6 条基础属性
    - 属性ID范围 31-38
    - 属性值基于怪物攻击计算（字符串格式）
    - _Requirements: 4.1-4.5, 5.1-5.3_

  - [x] 4.2 编写属性测试：装备基础属性生成范围
    - **Property 4: 装备基础属性生成范围**
    - **Validates: Requirements 5.1, 5.2**

  - [x] 4.3 实现技能魔次生成
    - 实现 `获取技能魔次分组(skillId)` 函数
    - 实现 `生成技能魔次(monsterLevel)` 函数
    - 基础技能(10001-10013)为第1组
    - 职业+全体技能(10014-10020)为第2组
    - 新技能每5个一组(10021-10050)
    - 数值使用字符串格式
    - _Requirements: 6.1-6.7_

  - [x] 4.4 编写属性测试：技能魔次ID范围与分组正确性
    - **Property 6: 技能魔次ID范围与分组正确性**
    - **Validates: Requirements 6.2, 6.3, 6.4, 6.7**

  - [x] 4.5 实现装备翻倍系统
    - 实现 `计算基础翻倍()` 函数（1-100随机）
    - 实现 `计算极品翻倍(playerRate)` 函数
    - 实现 `计算神品翻倍()` 函数（1/2000几率）
    - 实现 `应用翻倍(baseValue, multipliers)` 函数
    - 所有计算使用大数值引擎
    - _Requirements: 7.1-7.6_

  - [x] 4.6 编写属性测试：翻倍系统计算正确性
    - **Property 7: 翻倍系统计算正确性**
    - **Validates: Requirements 7.1, 7.3, 7.5**

- [x] 5. Checkpoint - 确保装备生成测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 6. 实现装备属性存储
  - [x] 6.1 实现属性序列化/反序列化
    - 实现 `序列化属性(attributes)` 函数
    - 实现 `反序列化属性(json)` 函数
    - 存储到 CustomDesc
    - 属性值使用字符串格式
    - _Requirements: 8.1-8.5_

  - [x] 6.2 编写属性测试：装备属性序列化Round-Trip
    - **Property 8: 装备属性序列化Round-Trip**
    - **Validates: Requirements 8.5**

- [x] 7. 实现属性统计系统
  - [x] 7.1 创建 `_核心部分/属性统计系统.ts` 文件
    - 实现 `读取装备属性(player)` 函数
    - 实现 `累加属性(attributes)` 函数
    - 实现 `存储到自定属性(player, totals)` 函数
    - 使用 Map 存储累加结果
    - 使用大数值计算累加
    - _Requirements: 9.1-9.5_

  - [x] 7.2 编写属性测试：属性统计累加正确性
    - **Property 9: 属性统计累加正确性**
    - **Validates: Requirements 9.2, 9.3**

- [x] 8. 实现伤害计算系统
  - [x] 8.1 创建 `_核心部分/伤害计算系统.ts` 文件
    - 实现伤害公式：(主属性 - 怪物防御) * (技能魔次 - 怪物魔次抵抗) * BUFF加成
    - 主属性 < 怪物防御时返回最小伤害 1
    - 技能魔次 < 怪物魔次抵抗时使用最小系数 0.1
    - 使用大数值计算引擎
    - _Requirements: 10.1-10.5_

  - [x] 8.2 编写属性测试：伤害计算公式正确性
    - **Property 10: 伤害计算公式正确性**
    - **Validates: Requirements 10.1, 10.3**

  - [x] 8.3 编写属性测试：大数值字符串运算一致性
    - **Property 13: 大数值字符串运算一致性**
    - **Validates: Requirements 6.6, 9.4**

- [x] 9. Checkpoint - 确保伤害计算测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 10. 实现磨怪系统
  - [x] 10.1 实现磨怪属性赋予
    - 实现 `判定磨怪类型(monster)` 函数
    - 实现 `赋予磨怪属性(monster)` 函数
    - 超高生命值设置
    - 特殊标识显示
    - _Requirements: 11.1-11.3_

  - [x] 10.2 实现磨怪掉落增强
    - 实现 `计算磨怪掉落加成(monster)` 函数
    - 掉落品质几率提升 50-200%
    - 根据存活时间动态提升
    - 保证至少一件高品质装备
    - _Requirements: 11.4-11.5_

  - [x] 10.3 编写属性测试：磨怪掉落保证
    - **Property 12: 磨怪掉落保证**
    - **Validates: Requirements 11.5**

- [x] 11. 性能优化
  - [x] 11.1 实现快速路径优化
    - 9千万亿以内使用原生JavaScript计算
    - 超过阈值使用Decimal对象
    - _Requirements: 12.1_

  - [x] 11.2 编写属性测试：大数值计算快速路径
    - **Property 11: 大数值计算快速路径**
    - **Validates: Requirements 12.1**

  - [x] 11.3 实现缓存优化
    - JSON解析结果缓存
    - 使用Map替代switch语句
    - 预计算常用值
    - _Requirements: 12.3-12.6_

- [x] 12. Final Checkpoint - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## Notes

- 所有新脚本创建在 `_核心部分` 文件夹内
- 所有数值使用字符串格式存储，支持大数值运算
- 使用 `计算方法[最终版]/核心计算方法.ts` 中的大数值计算函数
- 所有任务（包括测试任务）都必须完成
- 技能魔次分组规则：基础技能独立一组，职业+全体技能一组，新技能每5个一组

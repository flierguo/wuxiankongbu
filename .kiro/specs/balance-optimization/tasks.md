# Implementation Plan: 数值平衡优化

## Overview

本实现计划将数值平衡优化分为4个主要阶段：配置统一、生物属性简化、装备属性简化、验证系统实现。

## 当前代码状态分析

### 已有配置（需要修改）
- 世界配置.ts: 有旧的难度等级配置（倍数1,2,3,5,10），需更新为新配置（1,3,10,30,100,300）
- 生物属性.ts: 有TAG生物倍数配置（1,1.8,3,5,8,30,15），需更新为新配置（1,2,4,8,16,50,160）
- 数值平衡验证.ts: 已创建基础验证函数

### 主要问题
1. 生物属性Refresh函数使用7次大数值乘法（需简化为3次）
2. TAG6=30, TAG7=15 配置不合理（TAG7应大于TAG6）
3. 装备掉落仍有惊喜掉落逻辑（需移除）
4. 变异系统配置键名错误导致无法正常工作

## Tasks

- [x] 1. 统一数值配置到世界配置.ts
  - [x] 1.1 添加新的难度系数配置表
    - 在世界配置.ts中添加 `难度系数配置` 常量（替换旧的难度等级配置）
    - 新配置：简单(1)、普通(3)、困难(10)、精英(30)、炼狱(100)、圣耀(300)
    - 保持约3倍递增关系
    - _Requirements: 2.1, 2.2_

  - [x] 1.2 添加新的TAG倍数配置表
    - 在世界配置.ts中添加 `TAG倍数配置` 常量
    - 新配置：TAG1=1, TAG2=2, TAG3=4, TAG4=8, TAG5=16, TAG6=50, TAG7=160
    - 确保TAG7 > TAG6（修复当前配置问题）
    - _Requirements: 4.1, 4.2, 4.3, 4.4_

  - [x] 1.3 添加生物和装备基础值配置
    - 添加 `生物基础值配置`: 血量1000, 攻击100, 防御50
    - 添加 `装备基础值配置`: 属性基础100, 魔次基础10
    - _Requirements: 2.3_

- [x] 2. 简化生物属性计算
  - [x] 2.1 重构Refresh函数核心计算逻辑
    - 修改 `Refresh` 函数，使用新的简化公式
    - 新公式: `属性 = 基础值 × 地图难度倍数 × TAG倍数`（仅3次乘法）
    - 地图难度倍数 = 地图强度 × 难度系数
    - 移除：星级难度倍数计算（2^(固定星级-1)导致数值爆炸）
    - 移除：血量额外倍数、变异倍数、随机倍数等冗余计算
    - _Requirements: 1.1, 1.2, 1.3, 1.4_

  - [x] 2.2 更新TAG倍数引用
    - 修改生物属性.ts，从世界配置.ts导入新的TAG倍数配置
    - 删除生物属性.ts中的旧 `TAG生物倍数` 常量
    - _Requirements: 4.2, 4.3_

  - [x] 2.3 移除变异系统
    - 删除 `属性变异配置` 常量
    - 删除 `获取属性变异倍数` 函数
    - 删除Refresh函数中所有变异相关代码
    - _Requirements: 1.4_

  - [x] 2.4 移除数值平衡配置中的冗余项
    - 删除 `血量额外倍数` 配置
    - 删除 `攻击倍数最小/最大` 配置
    - 删除 `防御倍数最小/最大` 配置
    - _Requirements: 1.4, 2.4_

- [x] 3. 简化装备属性计算
  - [x] 3.1 重构计算属性值函数
    - 修改 `计算属性值` 函数，使用新的简化公式
    - 新公式: `属性 = 基础值 × 地图难度倍数 × 随机倍数(0.8-1.2) × 极品倍率`
    - 从世界配置.ts导入难度系数配置
    - _Requirements: 5.1, 5.4_

  - [x] 3.2 移除惊喜掉落和稀有高属性逻辑
    - 删除 `惊喜掉落几率`、`惊喜倍数最小/最大` 配置
    - 删除计算属性值函数中的惊喜掉落代码块
    - 删除稀有高属性代码块（1/200几率）
    - 统一使用极品倍率作为唯一的属性提升机制
    - _Requirements: 5.2, 5.3_

  - [x] 3.3 统一装备与生物的基准值
    - 确保装备属性计算使用与生物相同的地图难度倍数
    - 从世界配置.ts导入统一的难度系数配置
    - _Requirements: 2.3, 3.1_

- [x] 4. Checkpoint - 验证基础功能
  - 确保生物刷新正常工作（无报错）
  - 确保装备掉落正常工作（无报错）
  - 检查数值是否在合理范围内
  - 验证CPU消耗是否降低

- [x] 5. 完善数值验证系统
  - [x] 5.1 更新验证脚本
    - 更新 `数值平衡验证.ts` 文件
    - 从世界配置.ts导入新的配置常量
    - 实现完整的 `验证数值配置` 函数
    - _Requirements: 7.1_

  - [x] 5.2 实现难度递增验证
    - 验证相邻难度的倍数比例在2-5倍范围内
    - 输出不符合条件的配置项
    - _Requirements: 3.3, 7.4_

  - [x] 5.3 实现平衡关系验证
    - 验证装备攻击 > 同难度TAG1防御
    - 确保玩家能够有效击杀当前难度怪物
    - _Requirements: 3.2, 7.3_

  - [x] 5.4 实现属性范围验证
    - 验证所有地图强度(1-1000)、难度(6种)、TAG(1-7)组合
    - 确保属性值在合理范围内（血量>0，攻击>0，防御>=0）
    - _Requirements: 7.2_

- [x] 5.5 编写属性测试 - 难度递增比例

  - **Property 2: 难度递增比例约束**
  - *For any* 相邻的两个难度等级，后一难度的系数与前一难度的系数之比应在2-5倍范围内
  - **Validates: Requirements 3.3, 7.4**

- [x] 5.6 编写属性测试 - 装备与生物平衡

  - **Property 4: 装备与生物平衡关系**
  - *For any* 地图强度和难度组合，当前难度的装备攻击值应大于同难度TAG1生物的防御值
  - **Validates: Requirements 3.1, 7.3**

- [x] 6. 清理旧代码和添加注释
  - [x] 6.1 清理生物属性.ts
    - 确认已删除所有冗余配置和函数
    - 删除未使用的导入和变量
    - _Requirements: 1.4, 2.4_

  - [x] 6.2 清理装备掉落.ts
    - 确认已删除惊喜掉落相关配置
    - 简化数值平衡配置常量
    - _Requirements: 5.2_

  - [x] 6.3 添加配置注释
    - 在世界配置.ts中添加详细的数值说明注释
    - 说明难度系数的递增关系
    - 说明TAG倍数的设计意图
    - _Requirements: 6.3_

- [x] 7. Final Checkpoint - 完整验证
  - 运行数值验证脚本，确保所有验证通过
  - 检查TypeScript编译无错误
  - 验证CPU消耗是否降低（对比优化前后）

## Notes

- 任务标记 `*` 为可选测试任务
- 每个任务完成后应运行验证脚本确保数值正确
- 修改配置后需要重新刷新地图中的怪物才能看到效果
- 建议在测试服务器上先验证，再部署到正式服务器
- 核心优化目标：将7次大数值乘法减少为3次，降低CPU消耗
